<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vacaciones - Planta</title>

<style>
/* ====== MEJORAS DE LECTURA EN EL MODAL ====== */
.calMes { 
  background:#fafafa; 
  padding:15px; 
  border-radius:12px; 
  border:1px solid #ddd; 
}
.calMes h3 { text-align:center; font-size:20px; margin-bottom:10px; color:#333; }
.calMes3 table { border:1px solid #ccc; border-radius:8px; overflow:hidden; }
.calMes3 table th, .calMes3 table td { border:1px solid #ddd; padding:6px; }
.calMes3 table tr:nth-child(even) td { background:#fafafa; }

.diaVac3 { background:#7ed47e !important; font-weight:bold !important; }
.diaArt3 { background:#D7EEFF !important; }
.diaFeriado3 { background:#ffcccc !important; }
.diaFuera { color:#aaa; }

/* ================== ESTILOS GENERALES ================== */
.today-header { background:#ffe08c !important; font-weight:bold; border-bottom:2px solid #d09000; }

table thead th { position:sticky; top:0; z-index:20; background:#fafafa; box-shadow:0 2px 3px rgba(0,0,0,0.15); }
#gridWrap {
  border:1px solid #ddd;
  background:#fff;
  padding:8px;
  border-radius:6px;
  height: calc(100vh - 140px);  /* ocupa TODO el alto disponible */
  overflow: auto;
}

table { border-collapse:collapse; width:100%; font-size:12px; }
th,td { border:1px solid #eee; padding:4px; min-width:28px; text-align:center; white-space:nowrap; }
th.sticky { position:sticky; left:0; background:#fafafa; z-index:7; }
td.name { min-width:220px; text-align:left; position:sticky; left:0; background:#fff; z-index:6; }
.name-hn { background:#e8f4ff !important; }

body { font-family:Arial; margin:10px; background:#f6f7fb; color:#222; }
header { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
h1 { margin:0 0 10px 0; font-size:20px }

.vac { background:#7ed47e !important; font-weight:bold; }
.art { background:#D7EEFF !important; }
.holiday { background:#ffcccc !important; }

.legend { display:flex; gap:10px; margin-left:10px }
.btn { padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer }

/* ================== POPUP PERSONA ================== */
#calPersonaPopup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.65); display:none; justify-content:center; align-items:flex-start; padding-top:30px; z-index:99999; }
#calPersonaBox {
  background:#fff;
  padding:20px;
  border-radius:12px;
  width:95%;
  max-width:1100px;
  max-height:85vh;
  overflow-y:auto;
  box-shadow:0 0 25px rgba(0,0,0,0.35);
  margin-top:40px;     /* más aire arriba */
}

/* Botón fijo */
#calPersonaBox .btn {
  position:sticky;
  top:0;
  background:#fff;
  z-index:50;
  margin-bottom:10px;
}

.calMes3 {
  display:inline-block;
  width:30%;
  vertical-align:top;
  margin-bottom:20px;
  padding:5px;

#resumenPersona { margin-top:20px; padding:12px; border:1px solid #ccc; background:#fafafa; border-radius:6px; }

/* ================== VISTA CELULAR ================== */
@media (max-width: 600px) {
  .calMes3 { width:100% !important; }
  td.name { min-width:90px; font-size:12px; }
  table { font-size:10px; }
/* ===== ENCABEZADO LIMPIO ===== */
.header-clean {
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  padding:10px 0 20px 0;
  border-bottom:1px solid #ddd;
}

.header-title h1 {
  font-size:22px;
  margin:0;
  font-weight:800;
}

.subtitle {
  margin-top:3px;
  color:#666;
  font-size:13px;
}

.header-controls {
  display:flex;
  flex-direction:column;
  gap:10px;
}

.legend {
  <div class="legend">
  <span class="leg-item">
    <div class="leg-box" style="background:#7ed47e"></div> Vacaciones
  </span>
  <span class="leg-item">
    <div class="leg-box" style="background:#D7EEFF"></div> Artículos
  </span>
  <span class="leg-item">
    <div class="leg-box" style="background:#ffcccc"></div> Feriados / Findes
  </span>
</div>
}

.leg-item {
  display:flex;
  align-items:center;
  gap:6px;
}

.leg-box {
  width:18px;
  height:14px;
  border:1px solid #aaa;
}

.btn {
  padding:6px 10px;
  font-size:14px;
}
}

</style>
</head>

<body>

<!-- POPUP PERSONA -->
<div id="calPersonaPopup">
  <div id="calPersonaBox">
    <button onclick="cerrarPopupPersona()" class="btn">Volver</button>
    <h2 id="tituloPopupPersona"></h2>
    <div id="mesesPersona"></div>
    <div id="resumenPersona"></div>
  </div>
</div>

<header class="header-clean">
  <div class="header-title">
    <h1>VACACIONES Y ARTÍCULOS – CENTRO DE EXPLOSIVOS</h1>
    <div class="subtitle">Dic 2025 – Mar 2026</div>
  </div>

  <div class="header-controls">
    <div class="legend">
      <span class="leg-item"><div class="leg-box vac"></div> Vacaciones</span>
      <span class="leg-item"><div class="leg-box art"></div> Artículos</span>
      <span class="leg-item"><div class="leg-box holiday"></div> Feriados / Findes</span>
    </div>

    <div class="filters">
      Personal:
      <select id="filtroPlanta" class="btn">
        <option value="TODOS">Todos</option>
        <option value="PLANTA I">Planta I</option>
        <option value="PLANTA HN">Planta HN</option>
      </select>

      <input type="file" id="upload" accept=".json" class="btn">
    </div>
  </div>
</header>


<div id="gridWrap"></div>

<script>
/* ================= CONFIG =================== */
const jsonPath = "vacaciones.json";
const startDate = new Date(2025,11,1);
const endDate   = new Date(2026,2,31);

let data = {};
let flatPeople = [];

const feriadosAR = [
  "2025-12-08","2025-12-24","2025-12-25","2025-12-31",
  "2026-01-01","2026-02-16","2026-02-17",
  "2026-03-24","2026-03-29","2026-03-30"
];

function dateToYMD(d){ const mm=("0"+(d.getMonth()+1)).slice(-2); const dd=("0"+d.getDate()).slice(-2); return d.getFullYear()+"-"+mm+"-"+dd; }
function ymdToLocal(s){ const [y,m,d]=s.split("-"); return new Date(y,m-1,d); }
function ymdToDMY(s){ if(!s) return ""; const [y,m,d]=s.split("-"); return `${d}/${m}/${y}`; }

function normalizeData(){
  Object.keys(data).forEach(pl => {
    let newPl = pl.toUpperCase().replace("_"," ");
    if(newPl==="I") newPl="PLANTA I";
    if(newPl==="HN") newPl="PLANTA HN";
    if(newPl!==pl){ data[newPl]=data[pl]; delete data[pl]; pl=newPl; }

    data[pl]=data[pl].map(p=>{
      if(!p.articulos) p.articulos=[];
      if(typeof p.articulos==="string"){
        p.articulos=p.articulos.replace(/;/g,",").split(",").map(a=>{
          a=a.trim();
          if(a.includes("/")){
            const [d,m,y]=a.split("/");
            return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
          }
          return a;
        }).filter(a=>a.length>0);
      }
      return p;
    });
  });
}

async function loadJSON(){
  try{
    const r = await fetch(jsonPath+"?nocache="+Math.random());
    data = await r.json();
  }catch(e){ data={}; }

  normalizeData();
  buildFlatList();
  renderGrid();
  verificarNovedadesHoy();
}

function buildFlatList(){
  const f=filtroPlanta.value;
  flatPeople=[];
  Object.keys(data).forEach(pl=>{
    if(f!=="TODOS" && f!==pl) return;
    data[pl].forEach(p=>flatPeople.push({planta:pl, ...p}));
  });
  flatPeople.sort((a,b)=> a.planta.localeCompare(b.planta) || a.nombre.localeCompare(b.nombre));
}

function getDatesArray(){
  let arr=[]; for(let d=new Date(startDate); d<=endDate; d.setDate(d.getDate()+1)) arr.push(new Date(d)); return arr;
}

/* YA NO HAY FILTRO DE MESES */
function monthFilterShows(d){ return true; }

function renderGrid(){
  const dates=getDatesArray();
  const wrap=document.getElementById('gridWrap');
  const dayI=["D","L","M","X","J","V","S"];
  const monthNames=["ene.","feb.","mar.","abr.","may.","jun.","jul.","ago.","sep.","oct.","nov.","dic."];

  let html='<table><thead><tr><th class="sticky">Planta / Nombre</th>';

  dates.forEach(d=>{
    if(!monthFilterShows(d)) return;
    const ymd=dateToYMD(d);
    const today=dateToYMD(new Date());
    html+=`<th class="${ymd===today?'today-header':''}">
      <div style="font-size:11px">${dayI[d.getDay()]}</div>
      <div style="font-size:9px">${monthNames[d.getMonth()]}</div>
      <div>${("0"+d.getDate()).slice(-2)}</div>
    </th>`;
  });

  html+='</tr></thead><tbody>';

  flatPeople.forEach((p,i)=>{
    let s=p.vacacion_inicio?ymdToLocal(p.vacacion_inicio):null;
    let e=p.vacacion_fin?ymdToLocal(p.vacacion_fin):null;
    let totalVac=0;

    if(s&&e){ if(p.articulos.includes(dateToYMD(e))) e=new Date(e.setDate(e.getDate()-1)); totalVac=Math.max(0, Math.round((e-s)/86400000)+1); }

    html+=`<tr onclick="abrirPopupPersona(flatPeople[${i}])" style="cursor:pointer">
      <td class="name ${p.planta==='PLANTA HN'?'name-hn':''}">
        <div style="font-size:15px;font-weight:bold;">${p.nombre}</div>
        <div style="font-size:11px;color:#444">Legajo: ${p.legajo}<br>Vacaciones:${totalVac} días<br>Planta: ${p.planta}</div>
      </td>`;

    let count=0;
    dates.forEach(d=>{
      if(!monthFilterShows(d)) return;
      const ymd=dateToYMD(d);
      const ld=ymdToLocal(ymd);

      let isVac=(s&&e&&ld>=s&&ld<=e);
      let isArt=p.articulos.includes(ymd);

      let cls="";
      if(d.getDay()===0||d.getDay()===6) cls="holiday";
      if(feriadosAR.includes(ymd)) cls="holiday";
      if(isVac){ cls="vac"; count++; }
      if(isArt&&!isVac) cls="art";

      html += `<td class="${cls}">` +
          (isVac ? `<span class='vac-num'>${count}</span>` : 
          (isArt ? `<span style="font-size:9px;font-weight:bold;">art. 155</span>` : "")) +
        `</td>`;
    });

    html+='</tr>';
  });

  html+='</tbody></table>';
  wrap.innerHTML=html;
}

/* ================= POPUP ================= */
function abrirPopupPersona(p){
  tituloPopupPersona.innerText="Calendario de "+p.nombre;
  generarTresMeses(p);
  generarResumenPersona(p);
  calPersonaPopup.style.display="flex";
}

function cerrarPopupPersona(){ calPersonaPopup.style.display="none"; }

function generarTresMeses(p){
  mesesPersona.innerHTML="";
  const inicio=p.vacacion_inicio?ymdToLocal(p.vacacion_inicio):null;
  const fin=p.vacacion_fin?ymdToLocal(p.vacacion_fin):null;

  const meses=[new Date(2025,11),new Date(2026,0),new Date(2026,1),new Date(2026,2)];
  let mostrar=[];

  meses.forEach(m=>{
    const y = m.getFullYear(), mes = m.getMonth();
    const ini = new Date(y,mes,1), fm = new Date(y,mes+1,0);

    let ok = false;

    if(inicio && fin && !(fin < ini || inicio > fm)) ok = true;

    /* CORREGIDO: evitar artículos vacíos y fechas inválidas */
    if(!ok){
      (p.articulos || []).forEach(a=>{
        if(!a) return;
        const d = ymdToLocal(a);
        if(isNaN(d)) return;
        if(d.getMonth()===mes && d.getFullYear()===y) ok=true;
      });
    }

    if(ok) mostrar.push(m);
  });

  if(!mostrar.length) mostrar=[new Date(2026,0)];
  mostrar.forEach(m=>mesesPersona.appendChild(crearMesPersona(m,p)));
}

function crearMesPersona(fm,p){
  const y=fm.getFullYear(), mes=fm.getMonth();
  const div=document.createElement("div"); div.className="calMes3";

  const vac=diasVacPersona(p), art=p.articulos||[];
  const ini=new Date(y,mes,1), fin=new Date(y,mes+1,0).getDate();

  const nombres=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  let html=`<div class='calMes'><h3>${nombres[mes]} ${y}</h3><table><tr><th>L</th><th>M</th><th>Mi</th><th>J</th><th>V</th><th>S</th><th>D</th></tr><tr>`;

  let off=(ini.getDay()===0?6:ini.getDay()-1);
  for(let i=0;i<off;i++) html+=`<td class='diaFuera'></td>`;

  for(let d=1;d<=fin;d++){
    const fstr=`${y}-${String(mes+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dow=ymdToLocal(fstr).getDay();

    let cls="";
    if(vac.includes(fstr)) cls="diaVac3";
    else if(art.includes(fstr)) cls="diaArt3";
    else if(feriadosAR.includes(fstr)) cls="diaFeriado3";
    else if(dow===0||dow===6) cls="diaFeriado3";

    html+=`<td class='${cls}'>${d}</td>`;
    if((off+d)%7===0) html+="</tr><tr>";
  }

  html+="</tr></table></div>";
  div.innerHTML=html;
  return div;
}

function diasVacPersona(p){
  if(!p.vacacion_inicio||!p.vacacion_fin) return [];
  let a=[], d=ymdToLocal(p.vacacion_inicio), fin=ymdToLocal(p.vacacion_fin);
  while(d<=fin){ a.push(dateToYMD(d)); d=new Date(d.setDate(d.getDate()+1)); }
  return a;
}

function generarResumenPersona(p){
  if(!p.vacacion_inicio||!p.vacacion_fin){
    resumenPersona.innerHTML="<b>No tiene vacaciones.</b>";
    return;
  }
  const fin=ymdToLocal(p.vacacion_fin);
  const ingr=calcularDiaIngreso(fin,p.articulos);
  resumenPersona.innerHTML=`<h3>Resumen</h3>
  <p><b>Primer día:</b> ${ymdToDMY(p.vacacion_inicio)}</p>
  <p><b>Último día:</b> ${ymdToDMY(p.vacacion_fin)}</p>
  <p><b>Artículos:</b> ${(p.articulos||[]).map(a=>ymdToDMY(a)).join(", ") || "Sin artículos"}</p>
  <p style='font-size:18px'><b>Ingresa a trabajar:</b> ${ingr}</p>`;
}

function calcularDiaIngreso(finVac, art){
  let f=new Date(finVac); f.setDate(f.getDate()+1);
  while(true){
    const ymd=dateToYMD(f), dow=f.getDay();
    if(dow!==0&&dow!==6 && !feriadosAR.includes(ymd) && !(art||[]).includes(ymd)) return ymdToDMY(ymd);
    f.setDate(f.getDate()+1);
  }
}

/* ========== MODAL NOVEDADES ========== */
function verificarNovedadesHoy(){
  const hoy=dateToYMD(new Date());
  let vac=[], art=[], ing=[];

  flatPeople.forEach(p=>{
    if(p.vacacion_inicio===hoy) vac.push(p);
    if((p.articulos||[]).includes(hoy)) art.push(p);
    if(p.vacacion_fin){
      const i=calcularDiaIngreso(ymdToLocal(p.vacacion_fin),p.articulos);
      if(i===ymdToDMY(hoy)) ing.push(p);
    }
  });

  if(!vac.length&&!art.length&&!ing.length) return;

  let h=`<h2>Novedades del día ${ymdToDMY(hoy)}</h2>`;
  if(art.length){ h+=`<h3>Artículos</h3><ul>`+art.map(p=>`<li>${p.nombre}</li>`).join("")+"</ul>"; }
  if(vac.length){ h+=`<h3>Comienzan vacaciones</h3><ul>`+vac.map(p=>`<li>${p.nombre}</li>`).join("")+"</ul>"; }
  if(ing.length){ h+=`<h3>Ingresan a trabajar</h3><ul>`+ing.map(p=>`<li>${p.nombre}</li>`).join("")+"</ul>"; }

  const modal=document.createElement("div");
  modal.id="modalNovedades";
  modal.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.65);display:flex;justify-content:center;align-items:center;z-index:999999";
  modal.innerHTML=`<div style='background:#fff;padding:20px;border-radius:12px;max-width:500px;width:90%'>${h}<button class='btn' onclick='document.getElementById("modalNovedades").remove()'>Cerrar</button></div>`;
  document.body.appendChild(modal);
}

/* EVENTOS */
filtroPlanta.onchange=()=>{ buildFlatList(); renderGrid(); };

upload.onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=v=>{
    try{
      data=JSON.parse(v.target.result);
      normalizeData();
      buildFlatList();
      renderGrid();
      verificarNovedadesHoy();
      alert("JSON cargado");
    }
    catch(err){
      alert("Archivo inválido");
    }
  };
  r.readAsText(f,"utf-8");
};

/* INICIO */
loadJSON();
</script>

</body>
</html>
