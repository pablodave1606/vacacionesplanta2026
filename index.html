<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vacaciones - Planta</title>

<style>
/* ====== MEJORAS DE LECTURA EN EL MODAL ====== */
.calMes { 
  background:#fafafa; 
  padding:15px; 
  border-radius:12px; 
  border:1px solid #ddd; 
}
.calMes h3 { text-align:center; font-size:20px; margin-bottom:10px; color:#333; }
.calMes3 table { border:1px solid #ccc; border-radius:8px; overflow:hidden; }
.calMes3 table th, .calMes3 table td { border:1px solid #ddd; padding:6px; }
.calMes3 table tr:nth-child(even) td { background:#fafafa; }

/* CLASES DE TIPO DE D√çA CON !important PARA QUE SOBREESCRIBAN LOS COLORES DE MES */
.diaVac3 { background:#7ed47e !important; font-weight:bold !important; }
.diaArt3 { background:#D7EEFF !important; }
.diaLoaFrac3 { background:#ffd8b3 !important; font-weight:bold !important; }
.diaFeriado3 { background:#ffcccc !important; }
.diaFuera { color:#aaa; }

/* ================== ESTILOS GENERALES ================== */
.today-header { background:#ffe08c !important; font-weight:bold; border-bottom:2px solid #d09000; }

table thead th { position:sticky; top:0; z-index:20; background:#fafafa; box-shadow:0 2px 3px rgba(0,0,0,0.15); }
#gridWrap {
  border:1px solid #ddd;
  background:#fff;
  padding:8px;
  border-radius:6px;
  height: calc(100vh - 140px);
  overflow: auto;
}

table { border-collapse:collapse; width:100%; font-size:12px; }
th,td { border:1px solid #eee; padding:4px; min-width:28px; text-align:center; white-space:nowrap; }
th.sticky { position:sticky; left:0; background:#fafafa; z-index:7; }
td.name { min-width:220px; text-align:left; position:sticky; left:0; background:#fff; z-index:6; }
.name-hn { background:#e8f4ff !important; }

body { font-family:Arial; margin:10px; background:#f6f7fb; color:#222; }
header { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
h1 { margin:0 0 10px 0; font-size:20px }

/* CLASES PRINCIPALES CON !important Y MAYOR ESPECIFICIDAD */
/* A√ëADIMOS table td DELANTE PARA MAYOR ESPECIFICIDAD */
table td.vac { background:#7ed47e !important; font-weight:bold; }
table td.art { background:#D7EEFF !important; }
table td.loa_frac { background:#ffd8b3 !important; font-weight:bold; }
table td.holiday { background:#ffcccc !important; }

.legend { display:flex; gap:10px; margin-left:10px }
.btn { padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer }

/* ================== POPUP PERSONA ================== */
#calPersonaPopup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.65); display:none; justify-content:center; align-items:flex-start; padding-top:30px; z-index:99999; }
#calPersonaBox {
  background:#fff;
  padding:20px;
  border-radius:12px;
  width:95%;
  max-width:1100px;
  max-height:85vh;
  overflow-y:auto;
  box-shadow:0 0 25px rgba(0,0,0,0.35);
  margin-top:40px;
}

/* BOT√ìN VOLVER AGUANDADO */
#calPersonaBox .btn {
  position:sticky;
  top:0;
  background:#007bff;
  color: white;
  z-index:50;
  margin-bottom:15px;
  padding:12px 20px;
  font-size:16px;
  font-weight:bold;
  border:none;
  border-radius:8px;
  box-shadow:0 3px 6px rgba(0,0,0,0.2);
  transition:all 0.3s;
  width:100%;
}

#calPersonaBox .btn:hover {
  background:#0056b3;
  transform:translateY(-2px);
  box-shadow:0 5px 8px rgba(0,0,0,0.3);
}

.calMes3 {
  display:inline-block;
  width:30%;
  vertical-align:top;
  margin-bottom:20px;
  padding:5px;
}

#resumenPersona { margin-top:20px; padding:12px; border:1px solid #ccc; background:#fafafa; border-radius:6px; }

/* ================== VISTA CELULAR ================== */
#mobileView { display: none; }

.mobile-person-card {
  background: white;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border: 1px solid #ddd;
}

.mobile-person-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.mobile-person-name {
  font-weight: bold;
  font-size: 16px;
}

.mobile-person-planta {
  font-size: 12px;
  background: #e8f4ff;
  padding: 2px 8px;
  border-radius: 12px;
}

.mobile-person-details {
  font-size: 12px;
  color: #666;
  margin-bottom: 10px;
}

/* ===== ENCABEZADO LIMPIO ===== */
.header-clean {
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  padding:10px 0 20px 0;
  border-bottom:1px solid #ddd;
}

.header-title h1 {
  font-size:22px;
  margin:0;
  font-weight:800;
}

.subtitle {
  margin-top:3px;
  color:#666;
  font-size:13px;
}

.header-controls {
  display:flex;
  flex-direction:column;
  gap:10px;
}

.leg-item {
  display:flex;
  align-items:center;
  gap:6px;
}

.leg-box {
  width:18px;
  height:14px;
  border:1px solid #aaa;
}

/* ================== RESPONSIVE ================== */
@media (max-width: 768px) {
  #gridWrap { display: none !important; }
  #mobileView { display: block; }
  
  .header-clean {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
  
  .header-title h1 { font-size: 18px; }
  .header-controls { width: 100%; }
  .legend { flex-wrap: wrap; gap: 8px; }
  
  .filters {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }
  
  .filters select, .filters input { width: 100%; }
  .calMes3 { width: 100% !important; }
}

/* ================ ESTILOS PARA PER√çODOS ================ */
.vacation-periods-container {
  margin: 15px 0;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #7ed47e;
}

.vacation-period {
  margin-bottom: 10px;
  padding: 8px;
  background: white;
  border-radius: 6px;
  border: 1px solid #e0e0e0;
}

.vacation-period:last-child {
  margin-bottom: 0;
}

.vacation-period-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 5px;
}

.vacation-period-title {
  font-weight: bold;
  color: #2c3e50;
}

.vacation-period-dates {
  font-size: 13px;
  color: #666;
}

.vacation-period-info {
  display: flex;
  gap: 15px;
  font-size: 12px;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.no-vacations {
  color: #666;
  font-style: italic;
  padding: 10px;
  text-align: center;
  background: #f9f9f9;
  border-radius: 6px;
}

/* ================== MODAL INGRESO M√ìVIL ================== */
#mobileIngresoPopup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 100000;
  padding: 20px;
}

#mobileIngresoBox {
  background: #fff;
  padding: 25px;
  border-radius: 15px;
  width: 90%;
  max-width: 450px;
  text-align: center;
  box-shadow: 0 0 30px rgba(0,0,0,0.4);
}

#mobileIngresoBox h2 {
  margin: 0 0 15px 0;
  color: #2c3e50;
  font-size: 22px;
  border-bottom: 3px solid #7ed47e;
  padding-bottom: 12px;
}

#mobileIngresoInfo {
  font-size: 20px;
  font-weight: bold;
  color: #27ae60;
  margin: 20px 0;
  padding: 20px;
  background: linear-gradient(135deg, #f0f9f0 0%, #e1f5e1 100%);
  border-radius: 12px;
  border-left: 6px solid #27ae60;
  border-right: 6px solid #27ae60;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* BOT√ìN VOLVER EN MODAL M√ìVIL AGUANDADO */
#mobileIngresoBtn {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
  border: none;
  padding: 16px 25px;
  border-radius: 10px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  width: 100%;
  margin-top: 20px;
  transition: all 0.3s;
  box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}

#mobileIngresoBtn:hover {
  background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 8px rgba(0,0,0,0.25);
}

/* Leyenda en modal m√≥vil */
.leyenda-mobile {
  margin: 15px 0;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
}

.leyenda-mobile h4 {
  margin: 0 0 10px 0;
  font-size: 16px;
  color: #333;
  text-align: center;
}

.leyenda-items-mobile {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  font-size: 12px;
}

.leyenda-item-mobile {
  display: flex;
  align-items: center;
  gap: 6px;
}

.leyenda-box-mobile {
  width: 16px;
  height: 16px;
  border: 1px solid #888;
  border-radius: 3px;
  flex-shrink: 0;
}

/* ================ MESES CON COLORES EN GRILLA PC ================ */
/* COLORES DE MES SIN !important Y MENOS OPACIDAD */
.mes-diciembre { background-color: rgba(255, 248, 225, 0.15); }
.mes-enero { background-color: rgba(225, 245, 254, 0.15); }
.mes-febrero { background-color: rgba(255, 242, 240, 0.15); }
.mes-marzo { background-color: rgba(240, 255, 240, 0.15); }

.mes-header {
  position: relative;
  font-weight: bold;
  color: #333;
}

.mes-header::after {
  content: attr(data-mes);
  position: absolute;
  bottom: -15px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 10px;
  color: #666;
  white-space: nowrap;
}

/* Estilo destacado para "Vuelve a trabajar" en modal PC */
.vuelve-destacado {
  background: linear-gradient(135deg, #e1f5e1 0%, #c8e6c9 100%) !important;
  border-left: 5px solid #27ae60 !important;
  border-radius: 8px;
  padding: 15px !important;
  margin: 10px 0;
  font-weight: bold;
  font-size: 16px !important;
  color: #1e8449 !important;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
}

/* ========== SEPARADOR DE MESES CORREGIDO ========== */
/* La l√≠nea debe estar a la DERECHA del √∫ltimo d√≠a del mes anterior */
/* No al primer d√≠a del mes siguiente */
.mes-separator {
  border-right: 3px solid #999 !important;
}

/* Para n√∫meros de d√≠as de vacaciones */
.vac-num {
  font-weight: bold;
  font-size: 11px;
}

/* ===== LEYENDA DE COLORES EN MODAL (PC + M√ìVIL) ===== */
.leyenda-modal {
  margin: 15px 0 20px 0;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 10px;
  border: 1px solid #ddd;
}
.leyenda-modal h4 {
  margin: 0 0 10px 0;
  font-size: 15px;
  text-align: center;
  color: #333;
}
.leyenda-modal-items {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  font-size: 13px;
}
.leyenda-modal-item {
  display: flex;
  align-items: center;
  gap: 6px;
}
.leyenda-modal-box {
  width: 16px;
  height: 16px;
  border: 1px solid #888;
  border-radius: 3px;
}
/* ===== FIX MOBILE: VUELVE A TRABAJAR ===== */
@media (max-width: 768px) {

  .vacation-period-info {
    flex-direction: column;
    gap: 8px;
  }

  .vuelve-destacado {
    width: 100%;
    box-sizing: border-box;
    font-size: 14px !important;
    padding: 10px !important;
    margin: 6px 0 !important;
    text-align: center;
    white-space: normal;
  }
}
/* ===== FIX DEFINITIVO COLORES LEYENDA HEADER ===== */
.leg-box.vac {
  background: #7ed47e;
}

.leg-box.art {
  background: #D7EEFF;
}

.leg-box.loa_frac {
  background: #ffd8b3;
}

.leg-box.holiday {
  background: #ffcccc;
}

/* ===== FILTRO POR PUESTO ===== */
.filters {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.filters select {
  min-width: 120px;
}

.puesto-filter-container {
  display: flex;
  align-items: center;
  gap: 5px;
}

</style>
</head>

<body>

<!-- POPUP PERSONA -->
<div id="calPersonaPopup">
  <div id="calPersonaBox">
    <button onclick="cerrarPopupPersona()" class="btn">Volver</button>
    
<h2 id="tituloPopupPersona"></h2>

<!-- LEYENDA DE COLORES -->
<div class="leyenda-modal">
  <h4>Leyenda de colores</h4>
  <div class="leyenda-modal-items">
    <div class="leyenda-modal-item">
      <div class="leyenda-modal-box" style="background:#7ed47e;"></div>
      <span>Vacaciones</span>
    </div>
    <div class="leyenda-modal-item">
      <div class="leyenda-modal-box" style="background:#D7EEFF;"></div>
      <span>Art√≠culos</span>
    </div>
    <div class="leyenda-modal-item">
      <div class="leyenda-modal-box" style="background:#ffd8b3;"></div>
      <span>LOA Frac</span>
    </div>
    <div class="leyenda-modal-item">
      <div class="leyenda-modal-box" style="background:#ffcccc;"></div>
      <span>Feriados / Findes</span>
    </div>
  </div>
</div>

    <div id="mesesPersona"></div>
    <div id="resumenPersona"></div>
  </div>
</div>

<!-- POPUP INGRESO M√ìVIL -->
<div id="mobileIngresoPopup">
  <div id="mobileIngresoBox">
    <h2 id="mobileIngresoTitulo"></h2>
    <div id="mobileIngresoInfo"></div>
    
    <!-- Leyenda de colores en modal m√≥vil -->
    <div class="leyenda-mobile">
      <h4>Leyenda de colores</h4>
      <div class="leyenda-items-mobile">
        <div class="leyenda-item-mobile">
          <div class="leyenda-box-mobile" style="background:#7ed47e;"></div>
          <span>Vacaciones</span>
        </div>
        <div class="leyenda-item-mobile">
          <div class="leyenda-box-mobile" style="background:#D7EEFF;"></div>
          <span>Art√≠culos</span>
        </div>
        <div class="leyenda-item-mobile">
          <div class="leyenda-box-mobile" style="background:#ffd8b3;"></div>
          <span>LOA Frac</span>
        </div>
        <div class="leyenda-item-mobile">
          <div class="leyenda-box-mobile" style="background:#ffcccc;"></div>
          <span>Feriados</span>
        </div>
      </div>
    </div>
    
    <button id="mobileIngresoBtn" onclick="cerrarMobileIngreso()">Ver calendario completo</button>
  </div>
</div>

<header class="header-clean">
  <div class="header-title">
    <h1>VACACIONES Y ART√çCULOS ‚Äì CENTRO DE EXPLOSIVOS</h1>
    <div class="subtitle">Dic 2025 ‚Äì Mar 2026</div>
  </div>

  <div class="header-controls">
    <div class="legend">
      <span class="leg-item"><div class="leg-box vac"></div> Vacaciones</span>
      <span class="leg-item"><div class="leg-box art"></div> Art√≠culos</span>
      <span class="leg-item"><div class="leg-box loa_frac"></div> LOA Frac</span>
      <span class="leg-item"><div class="leg-box holiday"></div> Feriados / Findes</span>
    </div>

    <div class="filters">
      Personal:
      <select id="filtroPlanta" class="btn">
        <option value="TODOS">Todos</option>
        <option value="PLANTA I">Planta I</option>
        <option value="PLANTA HN">Planta HN</option>
      </select>

      <div class="puesto-filter-container">
        Puesto:
        <select id="filtroPuesto" class="btn">
          <option value="TODOS">Todos los puestos</option>
        </select>
      </div>

      <input type="file" id="upload" accept=".json" class="btn">
    </div>
  </div>
</header>

<!-- VISTA PC -->
<div id="gridWrap"></div>

<!-- VISTA M√ìVIL -->
<div id="mobileView">
  <div id="mobilePersonList"></div>
</div>

<script>
/* ================= CONFIG =================== */
const jsonPath = "vacaciones.json";
const startDate = new Date(2025,11,1);
const endDate   = new Date(2026,2,31);

let data = {};
let flatPeople = [];

const feriadosAR = [
  "2025-12-08","2025-12-24","2025-12-25","2025-12-31",
  "2026-01-01","2026-02-16","2026-02-17",
  "2026-03-24","2026-03-29","2026-03-30"
];

// Colores de fondo para cada mes en la grilla
const coloresMeses = {
  11: 'mes-diciembre',  // Diciembre
  0: 'mes-enero',      // Enero
  1: 'mes-febrero',    // Febrero
  2: 'mes-marzo'       // Marzo
};

// Nombres de meses para la grilla
const nombresMesesGrilla = {
  11: 'DIC',
  0: 'ENE',
  1: 'FEB',
  2: 'MAR'
};

function dateToYMD(d){ const mm=("0"+(d.getMonth()+1)).slice(-2); const dd=("0"+d.getDate()).slice(-2); return d.getFullYear()+"-"+mm+"-"+dd; }
function ymdToLocal(s){ const [y,m,d]=s.split("-"); return new Date(y,m-1,d); }
function ymdToDMY(s){ if(!s) return ""; const [y,m,d]=s.split("-"); return `${d}/${m}/${y}`; }

// Funci√≥n para obtener todos los d√≠as de vacaciones de una persona (m√∫ltiples per√≠odos)
function getDiasVacPersona(p) {
  const dias = [];
  if (p.vacaciones && p.vacaciones.length > 0) {
    p.vacaciones.forEach(periodo => {
      if (periodo.inicio && periodo.fin) {
        let d = ymdToLocal(periodo.inicio);
        const fin = ymdToLocal(periodo.fin);
        while (d <= fin) {
          dias.push(dateToYMD(d));
          d = new Date(d.setDate(d.getDate() + 1));
        }
      }
    });
  }
  return dias;
}

// Funci√≥n para obtener el total de d√≠as de vacaciones
function getTotalDiasVac(p) {
  let total = 0;
  if (p.vacaciones && p.vacaciones.length > 0) {
    p.vacaciones.forEach(periodo => {
      if (periodo.inicio && periodo.fin) {
        const inicio = ymdToLocal(periodo.inicio);
        const fin = ymdToLocal(periodo.fin);
        const dias = Math.round((fin - inicio) / 86400000) + 1;
        total += dias;
      }
    });
  }
  return total;
}

function normalizeData(){
  Object.keys(data).forEach(pl => {
    let newPl = pl.toUpperCase().replace("_"," ");
    if(newPl==="I") newPl="PLANTA I";
    if(newPl==="HN") newPl="PLANTA HN";
    if(newPl!==pl){ data[newPl]=data[pl]; delete data[pl]; pl=newPl; }

    data[pl]=data[pl].map(p=>{
      // Compatibilidad con versi√≥n anterior
      if (!p.vacaciones) {
        p.vacaciones = [];
        if (p.vacacion_inicio && p.vacacion_fin) {
          p.vacaciones.push({
            inicio: p.vacacion_inicio,
            fin: p.vacacion_fin
          });
        }
        // Eliminar campos antiguos
        delete p.vacacion_inicio;
        delete p.vacacion_fin;
      }
      
      // Inicializar puestos si no existen
      if (!p.puestos) {
        p.puestos = [];
      }
      
      // Normalizar puestos si vienen como strings
      if(typeof p.puestos==="string"){
        p.puestos=p.puestos.replace(/;/g,",").split(",").map(a=>a.trim()).filter(a=>a.length>0);
      }
      
      if(!p.articulos) p.articulos=[];
      if(!p.loa_frac) p.loa_frac=[];
      
      // Normalizar arrays si vienen como strings
      if(typeof p.articulos==="string"){
        p.articulos=p.articulos.replace(/;/g,",").split(",").map(a=>{
          a=a.trim();
          if(a.includes("/")){
            const [d,m,y]=a.split("/");
            return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
          }
          return a;
        }).filter(a=>a.length>0);
      }
      
      if(typeof p.loa_frac==="string"){
        p.loa_frac=p.loa_frac.replace(/;/g,",").split(",").map(a=>{
          a=a.trim();
          if(a.includes("/")){
            const [d,m,y]=a.split("/");
            return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
          }
          return a;
        }).filter(a=>a.length>0);
      }
      
      return p;
    });
  });
}

// Funci√≥n para obtener todos los puestos √∫nicos de una planta
function obtenerTodosLosPuestos(planta) {
  const puestosSet = new Set();
  
  if (planta === "TODOS") {
    // Obtener puestos de todas las plantas
    Object.keys(data).forEach(pl => {
      data[pl].forEach(persona => {
        if (persona.puestos && persona.puestos.length > 0) {
          persona.puestos.forEach(puesto => {
            puestosSet.add(puesto.trim());
          });
        }
      });
    });
  } else if (data[planta]) {
    // Obtener puestos de una planta espec√≠fica
    data[planta].forEach(persona => {
      if (persona.puestos && persona.puestos.length > 0) {
        persona.puestos.forEach(puesto => {
          puestosSet.add(puesto.trim());
        });
      }
    });
  }
  
  // Convertir a array y ordenar alfab√©ticamente
  return Array.from(puestosSet).sort((a, b) => a.localeCompare(b));
}

// Funci√≥n para cargar puestos en el filtro
function cargarPuestosEnFiltro(plantaSeleccionada) {
  const filtroPuesto = document.getElementById('filtroPuesto');
  const puestos = obtenerTodosLosPuestos(plantaSeleccionada);
  
  // Guardar el valor actual
  const valorActual = filtroPuesto.value;
  
  // Limpiar opciones (excepto la primera)
  filtroPuesto.innerHTML = '<option value="TODOS">Todos los puestos</option>';
  
  // Agregar opciones de puestos
  puestos.forEach(puesto => {
    const option = document.createElement('option');
    option.value = puesto;
    option.textContent = puesto;
    filtroPuesto.appendChild(option);
  });
  
  // Restaurar valor si existe
  if (puestos.includes(valorActual)) {
    filtroPuesto.value = valorActual;
  } else {
    filtroPuesto.value = "TODOS";
  }
  
  // Habilitar/deshabilitar seg√∫n la selecci√≥n de planta
  if (plantaSeleccionada === "TODOS") {
    filtroPuesto.disabled = true;
  } else {
    filtroPuesto.disabled = false;
  }
}

async function loadJSON(){
  try{
    const r = await fetch(jsonPath+"?nocache="+Math.random());
    data = await r.json();
  }catch(e){ data={}; }

  normalizeData();
  cargarPuestosEnFiltro("TODOS");
  buildFlatList();
  renderGrid();
  renderMobileView();
  verificarNovedadesHoy();
}

function buildFlatList(){
  const plantaFiltro = document.getElementById('filtroPlanta').value;
  const puestoFiltro = document.getElementById('filtroPuesto').value;
  
  flatPeople=[];
  
  Object.keys(data).forEach(pl=>{
    if(plantaFiltro !== "TODOS" && plantaFiltro !== pl) return;
    
    data[pl].forEach(p=>{
      // Filtrar por puesto si se ha seleccionado uno espec√≠fico
      if (puestoFiltro !== "TODOS") {
        if (!p.puestos || !p.puestos.includes(puestoFiltro)) {
          return; // Saltar esta persona si no tiene el puesto seleccionado
        }
      }
      
      flatPeople.push({planta:pl, ...p});
    });
  });
  
  flatPeople.sort((a,b)=> a.planta.localeCompare(b.planta) || a.nombre.localeCompare(b.nombre));
}

function filtrarPorPlantaYPuesto() {
  buildFlatList();
  renderGrid();
  renderMobileView();
}

function getDatesArray(){
  let arr=[]; 
  let d = new Date(startDate);
  while(d <= endDate){
    arr.push(new Date(d));
    d.setDate(d.getDate() + 1);
  }
  return arr;
}

function renderGrid(){
  const dates=getDatesArray();
  const wrap=document.getElementById('gridWrap');
  const dayI=["D","L","M","X","J","V","S"];
  const monthNames=["ene.","feb.","mar.","abr.","may.","jun.","jul.","ago.","sep.","oct.","nov.","dic."];

  let html='<table><thead><tr><th class="sticky">Planta / Nombre</th>';

  let mesAnterior = null;
  let mesActual = null;
  
  dates.forEach((d, index)=>{
    const ymd=dateToYMD(d);
    const today=dateToYMD(new Date());
    
    // Verificar si cambi√≥ de mes
    const mes = d.getMonth();
    let claseMes = coloresMeses[mes] || '';
    
    // Verificar si es el PRIMER d√≠a del mes
    let esPrimerDiaMes = mesActual !== mes;
    mesActual = mes;
    
    // Determinar si poner separador: NO en el primer d√≠a del mes siguiente
    // SINO en el √öLTIMO d√≠a del mes anterior
    let claseSeparador = '';
    
    // Necesitamos saber cu√°l es el mes anterior
    if (mesAnterior !== null && mesAnterior !== mes) {
      // Estamos en el primer d√≠a de un nuevo mes
      // La l√≠nea debe estar en el d√≠a ANTERIOR (√∫ltimo del mes anterior)
      // NO en este d√≠a
    }
    mesAnterior = mes;
    
    // Obtener el nombre del mes para mostrar en el header
    const nombreMes = nombresMesesGrilla[mes] || '';
    
    html+=`<th class="${ymd===today?'today-header':''} ${claseMes} ${claseSeparador}" data-mes="${nombreMes}">
      <div style="font-size:11px">${dayI[d.getDay()]}</div>
      <div style="font-size:9px">${monthNames[d.getMonth()]}</div>
      <div>${("0"+d.getDate()).slice(-2)}</div>
    </th>`;
  });

  html+='</tr></thead><tbody>';

  flatPeople.forEach((p,i)=>{
    const totalVac = getTotalDiasVac(p);
    const diasVac = getDiasVacPersona(p);
    const art = p.articulos || [];
    const loa = p.loa_frac || [];
    const puestos = p.puestos || [];

    html+=`<tr onclick="abrirPopupPersona(flatPeople[${i}])" style="cursor:pointer">
      <td class="name ${p.planta==='PLANTA HN'?'name-hn':''}">
        <div style="font-size:15px;font-weight:bold;">${p.nombre}</div>
        <div style="font-size:11px;color:#444">
          Legajo: ${p.legajo}<br>
          ${puestos.length > 0 ? `Puesto${puestos.length > 1 ? 's' : ''}: ${puestos.join(', ')}<br>` : ''}
          Vacaciones: ${totalVac} d√≠as (${p.vacaciones ? p.vacaciones.length : 0} per√≠odo${p.vacaciones && p.vacaciones.length !== 1 ? 's' : ''})<br>
          Planta: ${p.planta}
        </div>
      </td>`;

    let count=0;
    let mesAnteriorFila = null;
    
    dates.forEach((d, index)=>{
      const ymd=dateToYMD(d);

      let isVac = diasVac.includes(ymd);
      let isArt = art.includes(ymd);
      let isLoaFrac = loa.includes(ymd);

      let cls="";
      if(d.getDay()===0||d.getDay()===6) cls="holiday";
      if(feriadosAR.includes(ymd)) cls="holiday";
      if(isVac){ cls="vac"; count++; }
      else if(isArt) cls="art";
      else if(isLoaFrac) cls="loa_frac";
      
      // Agregar color de fondo seg√∫n el mes
      const mes = d.getMonth();
      const claseMesFondo = coloresMeses[mes] || '';
      
      // ========== CORRECCI√ìN: SEPARADOR EN EL √öLTIMO D√çA DEL MES ANTERIOR ==========
      let claseSeparadorFila = '';
      
      // Verificar si estamos en el primer d√≠a de un nuevo mes (excepto diciembre)
      if (mesAnteriorFila !== null && mesAnteriorFila !== mes && mes !== 11) {
        // La l√≠nea debe estar en el d√≠a ANTERIOR (√∫ltimo del mes anterior)
        // Para esto necesitamos modificar la celda ANTERIOR, no la actual
        // Esto es complicado de hacer aqu√≠, mejor lo hacemos diferente...
      }
      
      // En su lugar, verificamos si el D√çA SIGUIENTE es de un mes diferente
      if (index < dates.length - 1) {
        const siguienteDia = dates[index + 1];
        const mesSiguiente = siguienteDia.getMonth();
        if (mes !== mesSiguiente) {
          // Ma√±ana es de un mes diferente, poner separador en ESTA celda (√∫ltima del mes actual)
          claseSeparadorFila = 'mes-separator';
        }
      }
      
      mesAnteriorFila = mes;

      let contenido = "";
      if (isVac) {
        contenido = `<span class='vac-num'>${count}</span>`;
      } else if (isArt) {
        contenido = `<span style="font-size:9px;font-weight:bold;">art</span>`;
      } else if (isLoaFrac) {
        contenido = `<span style="font-size:8px;font-weight:bold;">LOA</span>`;
      }

      // IMPORTANTE: Las clases de tipo de d√≠a (cls) van PRIMERO para prioridad
      // Las clases de tipo de d√≠a tienen mayor especificidad en CSS (table td.clase)
      html += `<td class="${cls} ${claseMesFondo} ${claseSeparadorFila}">${contenido}</td>`;
    });

    html+='</tr>';
  });

  html+='</tbody></table>';
  wrap.innerHTML=html;
}

/* ================= VISTA M√ìVIL ================== */
function renderMobileView() {
  const list = document.getElementById('mobilePersonList');
  let html = '';
  
  flatPeople.forEach((p, i) => {
    const totalVac = getTotalDiasVac(p);
    const numPeriodos = p.vacaciones ? p.vacaciones.length : 0;
    const puestos = p.puestos || [];
    
    html += `
      <div class="mobile-person-card" onclick="mostrarIngresoMobile(flatPeople[${i}])" style="cursor: pointer;">
        <div class="mobile-person-header">
          <div class="mobile-person-name">${p.nombre}</div>
          <div class="mobile-person-planta">${p.planta}</div>
        </div>
        <div class="mobile-person-details">
          Legajo: ${p.legajo}<br>
          ${puestos.length > 0 ? `Puesto${puestos.length > 1 ? 's' : ''}: ${puestos.join(', ')}<br>` : ''}
          Vacaciones: ${totalVac} d√≠as (${numPeriodos} per√≠odo${numPeriodos !== 1 ? 's' : ''})
        </div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

/* ================= MODAL INGRESO M√ìVIL ================= */
let personaSeleccionadaMobile = null;

function mostrarIngresoMobile(p) {
  personaSeleccionadaMobile = p;
  
  // Buscar la pr√≥xima fecha de ingreso a trabajar
  let ingresoFecha = null;
  let periodoInfo = null;
  
  if (p.vacaciones && p.vacaciones.length > 0) {
    const hoy = new Date();
    const hoyYMD = dateToYMD(hoy);
    
    // Buscar si hoy est√° en un per√≠odo de vacaciones
    const diasVac = getDiasVacPersona(p);
    
    if (diasVac.includes(hoyYMD)) {
      // Hoy est√° de vacaciones, buscar cu√°ndo termina
      p.vacaciones.forEach(periodo => {
        if (periodo.inicio && periodo.fin) {
          const inicio = ymdToLocal(periodo.inicio);
          const fin = ymdToLocal(periodo.fin);
          const hoyDate = ymdToLocal(hoyYMD);
          
          if (hoyDate >= inicio && hoyDate <= fin) {
            periodoInfo = periodo;
            // Calcular d√≠a de reingreso
            ingresoFecha = calcularDiaReingreso(fin, p.articulos || [], p.loa_frac || []);
          }
        }
      });
    } else {
      // No est√° de vacaciones hoy, buscar si viene de unas vacaciones recientes
      p.vacaciones.forEach(periodo => {
        if (periodo.fin) {
          const finDate = ymdToLocal(periodo.fin);
          const reingreso = calcularDiaReingreso(finDate, p.articulos || [], p.loa_frac || []);
          const reingresoDate = ymdToLocal(reingreso);
          
          // Si el reingreso es hoy o futuro
          if (reingresoDate >= hoy) {
            if (!ingresoFecha || reingresoDate < ymdToLocal(ingresoFecha)) {
              ingresoFecha = reingreso;
              periodoInfo = periodo;
            }
          }
        }
      });
    }
  }
  
  // Mostrar el modal
  document.getElementById('mobileIngresoTitulo').textContent = p.nombre;
  
  if (ingresoFecha) {
    const hoyYMD = dateToYMD(new Date());
    const ingresoDate = ymdToLocal(ingresoFecha);
    const hoyDate = ymdToLocal(hoyYMD);
    
    let mensaje = '';
    
    if (ingresoFecha === hoyYMD) {
      mensaje = `<div style="font-size:24px; margin-bottom:10px;">üè¢ INGRESA HOY</div>`;
      mensaje += `<div style="font-size:18px; color:#d35400;">A trabajar</div>`;
    } else if (ingresoDate < hoyDate) {
      mensaje = `<div style="font-size:22px; margin-bottom:10px;">‚úÖ YA INGRES√ì</div>`;
      mensaje += `<div style="font-size:16px; color:#27ae60;">A trabajar</div>`;
    } else {
      const diffDias = Math.round((ingresoDate - hoyDate) / 86400000);
      mensaje = `<div style="font-size:26px; margin-bottom:10px;">üìÖ INGRESA EN ${diffDias} D√çA${diffDias !== 1 ? 'S' : ''}</div>`;
      mensaje += `<div style="font-size:20px; color:#2980b9;">${ymdToDMY(ingresoFecha)}</div>`;
      mensaje += `<div style="font-size:14px; margin-top:8px; color:#666;">Fecha de reingreso</div>`;
    }
    
    document.getElementById('mobileIngresoInfo').innerHTML = mensaje;
  } else {
    document.getElementById('mobileIngresoInfo').innerHTML = 
      '<div style="font-size:20px; color:#7f8c8d;">No tiene vacaciones programadas</div>' +
      '<div style="font-size:14px; margin-top:5px; color:#95a5a6;">o ya ingres√≥ a trabajar</div>';
  }
  
  document.getElementById('mobileIngresoPopup').style.display = 'flex';
}

function cerrarMobileIngreso() {
  document.getElementById('mobileIngresoPopup').style.display = 'none';
  
  // Despu√©s de 300ms, abrir el popup completo
  setTimeout(() => {
    if (personaSeleccionadaMobile) {
      abrirPopupPersona(personaSeleccionadaMobile);
      personaSeleccionadaMobile = null;
    }
  }, 300);
}

// Tambi√©n permitir cerrar haciendo clic fuera del modal
document.getElementById('mobileIngresoPopup').addEventListener('click', function(e) {
  if (e.target.id === 'mobileIngresoPopup') {
    cerrarMobileIngreso();
  }
});

/* ================= POPUP PERSONA ================= */
function abrirPopupPersona(p){
  document.getElementById('tituloPopupPersona').innerText = `Calendario de ${p.nombre}`;
  generarTresMeses(p);
  generarResumenPersona(p);
  document.getElementById('calPersonaPopup').style.display = "flex";
}

function cerrarPopupPersona(){ 
  document.getElementById('calPersonaPopup').style.display = "none"; 
}

function generarTresMeses(p){
  document.getElementById('mesesPersona').innerHTML = "";
  
  const meses = [new Date(2025,11), new Date(2026,0), new Date(2026,1), new Date(2026,2)];
  let mostrar = [];

  meses.forEach(m => {
    const y = m.getFullYear(), mes = m.getMonth();
    const ini = new Date(y, mes, 1), fm = new Date(y, mes + 1, 0);

    let ok = false;

    // Verificar si hay vacaciones en este mes
    if (p.vacaciones && p.vacaciones.length > 0) {
      p.vacaciones.forEach(periodo => {
        if (periodo.inicio && periodo.fin) {
          const inicio = ymdToLocal(periodo.inicio);
          const fin = ymdToLocal(periodo.fin);
          if (!(fin < ini || inicio > fm)) ok = true;
        }
      });
    }

    // Verificar art√≠culos
    if (!ok && p.articulos && p.articulos.length > 0) {
      p.articulos.forEach(a => {
        if(!a) return;
        const d = ymdToLocal(a);
        if(isNaN(d)) return;
        if(d.getMonth() === mes && d.getFullYear() === y) ok = true;
      });
    }

    // Verificar LOA Frac
    if (!ok && p.loa_frac && p.loa_frac.length > 0) {
      p.loa_frac.forEach(a => {
        if(!a) return;
        const d = ymdToLocal(a);
        if(isNaN(d)) return;
        if(d.getMonth() === mes && d.getFullYear() === y) ok = true;
      });
    }

    if(ok) mostrar.push(m);
  });

  if(!mostrar.length) mostrar = [new Date(2026,0)];
  mostrar.forEach(m => document.getElementById('mesesPersona').appendChild(crearMesPersona(m, p)));
}

function crearMesPersona(fm, p){
  const y = fm.getFullYear(), mes = fm.getMonth();
  const div = document.createElement("div"); 
  div.className = "calMes3";

  const vac = getDiasVacPersona(p);
  const art = p.articulos || [];
  const loa = p.loa_frac || [];
  const ini = new Date(y, mes, 1);
  const fin = new Date(y, mes + 1, 0).getDate();

  const nombres = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  let html = `<div class='calMes'><h3>${nombres[mes]} ${y}</h3><table><tr><th>L</th><th>M</th><th>Mi</th><th>J</th><th>V</th><th>S</th><th>D</th></tr><tr>`;

  let off = (ini.getDay() === 0 ? 6 : ini.getDay() - 1);
  for(let i = 0; i < off; i++) html += `<td class='diaFuera'></td>`;

  for(let d = 1; d <= fin; d++){
    const fstr = `${y}-${String(mes + 1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dow = ymdToLocal(fstr).getDay();

    let cls = "";
    if(vac.includes(fstr)) cls = "diaVac3";
    else if(art.includes(fstr)) cls = "diaArt3";
    else if(loa.includes(fstr)) cls = "diaLoaFrac3";
    else if(feriadosAR.includes(fstr)) cls = "diaFeriado3";
    else if(dow === 0 || dow === 6) cls = "diaFeriado3";

    html += `<td class='${cls}'>${d}</td>`;
    if((off + d) % 7 === 0) html += "</tr><tr>";
  }

  html += "</tr></table></div>";
  div.innerHTML = html;
  return div;
}

function generarResumenPersona(p){
  let html = `<h3>Resumen</h3>`;
  
  // Mostrar puestos
  const puestos = p.puestos || [];
  if (puestos.length > 0) {
    html += `<p><strong>Puesto${puestos.length > 1 ? 's' : ''}:</strong> ${puestos.join(', ')}</p>`;
  } else {
    html += `<p><strong>Puestos:</strong> Sin puestos asignados</p>`;
  }
  
  // Mostrar per√≠odos de vacaciones
  if (p.vacaciones && p.vacaciones.length > 0) {
    html += `<div class="vacation-periods-container">`;
    html += `<h4>Per√≠odos de Vacaciones</h4>`;
    
    p.vacaciones.forEach((periodo, index) => {
      const inicio = periodo.inicio;
      const fin = periodo.fin;
      const inicioDate = ymdToLocal(inicio);
      const finDate = ymdToLocal(fin);
      const dias = Math.round((finDate - inicioDate) / 86400000) + 1;
      const reingreso = calcularDiaReingreso(finDate, p.articulos || [], p.loa_frac || []);
      
      html += `
        <div class="vacation-period">
          <div class="vacation-period-header">
            <div class="vacation-period-title">Per√≠odo ${index + 1}</div>
            <div class="vacation-period-dates">${dias} d√≠as</div>
          </div>
          <div class="vacation-period-info">
            <div class="info-item"><strong>Inicio:</strong> ${ymdToDMY(inicio)}</div>
            <div class="info-item"><strong>Fin:</strong> ${ymdToDMY(fin)}</div>
            <div class="info-item vuelve-destacado"><strong>Vuelve a trabajar:</strong> ${ymdToDMY(reingreso)}</div>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
  } else {
    html += `<p class="no-vacations">No tiene per√≠odos de vacaciones asignados.</p>`;
  }
  
  // Mostrar art√≠culos
  html += `<p><strong>Art√≠culos:</strong> ${(p.articulos||[]).map(a => ymdToDMY(a)).join(", ") || "Sin art√≠culos"}</p>`;
  
  // Mostrar LOA Frac
  html += `<p><strong>LOA Frac:</strong> ${(p.loa_frac||[]).map(a => ymdToDMY(a)).join(", ") || "Sin LOA Frac"}</p>`;
  
  // Mostrar total
  const totalVac = getTotalDiasVac(p);
  html += `<p style='font-size:18px; margin-top: 20px; padding: 10px; background: #f0f8ff; border-radius: 6px;'>
    <strong>Total d√≠as de vacaciones:</strong> ${totalVac} d√≠as
  </p>`;
  
  document.getElementById('resumenPersona').innerHTML = html;
}

// Funci√≥n para calcular d√≠a de reingreso para un per√≠odo espec√≠fico
function calcularDiaReingreso(finVac, art, loaFrac){
  let f = new Date(finVac); 
  f.setDate(f.getDate() + 1);
  while(true){
    const ymd = dateToYMD(f);
    const dow = f.getDay();
    if(dow !== 0 && dow !== 6 && !feriadosAR.includes(ymd) && 
       !(art||[]).includes(ymd) && !(loaFrac||[]).includes(ymd)) {
      return ymd;
    }
    f.setDate(f.getDate() + 1);
  }
}

/* ========== MODAL NOVEDADES ========== */
function verificarNovedadesHoy(){
  const hoy = dateToYMD(new Date());
  let vac = [], art = [], loa = [], ing = [];

  flatPeople.forEach(p => {
    // Verificar si comienza vacaciones hoy
    if (p.vacaciones && p.vacaciones.length > 0) {
      p.vacaciones.forEach(periodo => {
        if (periodo.inicio === hoy) vac.push({persona: p, periodo: periodo});
      });
    }
    
    if((p.articulos||[]).includes(hoy)) art.push(p);
    if((p.loa_frac||[]).includes(hoy)) loa.push(p);
    
    // Verificar si hoy es d√≠a de reingreso de alg√∫n per√≠odo
    if(p.vacaciones && p.vacaciones.length > 0) {
      p.vacaciones.forEach(periodo => {
        if (periodo.fin) {
          const finDate = ymdToLocal(periodo.fin);
          const reingreso = calcularDiaReingreso(finDate, p.articulos || [], p.loa_frac || []);
          if(reingreso === hoy) ing.push({persona: p, periodo: periodo});
        }
      });
    }
  });

  if(!vac.length && !art.length && !loa.length && !ing.length) return;

  let h = `<h2>Novedades del d√≠a ${ymdToDMY(hoy)}</h2>`;
  if(art.length){ 
    h += `<h3>Art√≠culos</h3><ul>` + art.map(p => `<li>${p.nombre}</li>`).join("") + "</ul>"; 
  }
  if(vac.length){ 
    h += `<h3>Comienzan vacaciones</h3><ul>` + 
         vac.map(v => `<li>${v.persona.nombre} (${ymdToDMY(v.periodo.inicio)} - ${ymdToDMY(v.periodo.fin)})</li>`).join("") + 
         "</ul>"; 
  }
  if(loa.length){ 
    h += `<h3>LOA Fraccionada</h3><ul>` + loa.map(p => `<li>${p.nombre}</li>`).join("") + "</ul>"; 
  }
  if(ing.length){ 
    h += `<h3>Ingresan a trabajar</h3><ul>` + 
         ing.map(i => `<li>${i.persona.nombre} (del per√≠odo ${ymdToDMY(i.periodo.inicio)} - ${ymdToDMY(i.periodo.fin)})</li>`).join("") + 
         "</ul>"; 
  }

  const modal = document.createElement("div");
  modal.id = "modalNovedades";
  modal.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.65);display:flex;justify-content:center;align-items:center;z-index:999999";
  modal.innerHTML = `<div style='background:#fff;padding:20px;border-radius:12px;max-width:500px;width:90%'>${h}<button class='btn' onclick='document.getElementById("modalNovedades").remove()' style='background:#007bff;color:white;padding:12px 20px;font-size:16px;font-weight:bold;border:none;border-radius:8px;width:100%;margin-top:15px;'>Cerrar</button></div>`;
  document.body.appendChild(modal);
}

/* ========== MANEJAR BOT√ìN VOLVER DE ANDROID ========== */
// Variable para rastrear si hay un modal abierto
let modalAbierto = false;

// Interceptar el evento de bot√≥n "atr√°s" en Android
window.addEventListener('popstate', function(event) {
  if (modalAbierto) {
    // Si hay un modal abierto, lo cerramos en lugar de salir de la p√°gina
    event.preventDefault();
    
    // Cerrar el modal que est√© visible
    const ingresoPopup = document.getElementById('mobileIngresoPopup');
    const calPersonaPopup = document.getElementById('calPersonaPopup');
    
    if (ingresoPopup.style.display === 'flex') {
      cerrarMobileIngreso();
    } else if (calPersonaPopup.style.display === 'flex') {
      cerrarPopupPersona();
    } else if (document.getElementById('modalNovedades')) {
      document.getElementById('modalNovedades').remove();
    }
  }
});

// Funci√≥n para abrir modal de ingreso (actualizada)
function mostrarIngresoMobile(p) {
  personaSeleccionadaMobile = p;
  modalAbierto = true;
  
  // Buscar la pr√≥xima fecha de ingreso a trabajar
  let ingresoFecha = null;
  let periodoInfo = null;
  
  if (p.vacaciones && p.vacaciones.length > 0) {
    const hoy = new Date();
    const hoyYMD = dateToYMD(hoy);
    
    // Buscar si hoy est√° en un per√≠odo de vacaciones
    const diasVac = getDiasVacPersona(p);
    
    if (diasVac.includes(hoyYMD)) {
      // Hoy est√° de vacaciones, buscar cu√°ndo termina
      p.vacaciones.forEach(periodo => {
        if (periodo.inicio && periodo.fin) {
          const inicio = ymdToLocal(periodo.inicio);
          const fin = ymdToLocal(periodo.fin);
          const hoyDate = ymdToLocal(hoyYMD);
          
          if (hoyDate >= inicio && hoyDate <= fin) {
            periodoInfo = periodo;
            // Calcular d√≠a de reingreso
            ingresoFecha = calcularDiaReingreso(fin, p.articulos || [], p.loa_frac || []);
          }
        }
      });
    } else {
      // No est√° de vacaciones hoy, buscar si viene de unas vacaciones recientes
      p.vacaciones.forEach(periodo => {
        if (periodo.fin) {
          const finDate = ymdToLocal(periodo.fin);
          const reingreso = calcularDiaReingreso(finDate, p.articulos || [], p.loa_frac || []);
          const reingresoDate = ymdToLocal(reingreso);
          
          // Si el reingreso es hoy o futuro
          if (reingresoDate >= hoy) {
            if (!ingresoFecha || reingresoDate < ymdToLocal(ingresoFecha)) {
              ingresoFecha = reingreso;
              periodoInfo = periodo;
            }
          }
        }
      });
    }
  }
  
  // Mostrar el modal
  document.getElementById('mobileIngresoTitulo').textContent = p.nombre;
  
  if (ingresoFecha) {
    const hoyYMD = dateToYMD(new Date());
    const ingresoDate = ymdToLocal(ingresoFecha);
    const hoyDate = ymdToLocal(hoyYMD);
    
    let mensaje = '';
    
    if (ingresoFecha === hoyYMD) {
      mensaje = `<div style="font-size:24px; margin-bottom:10px;">üè¢ INGRESA HOY</div>`;
      mensaje += `<div style="font-size:18px; color:#d35400;">A trabajar</div>`;
    } else if (ingresoDate < hoyDate) {
      mensaje = `<div style="font-size:22px; margin-bottom:10px;">‚úÖ YA INGRES√ì</div>`;
      mensaje += `<div style="font-size:16px; color:#27ae60;">A trabajar</div>`;
    } else {
      const diffDias = Math.round((ingresoDate - hoyDate) / 86400000);
      mensaje = `<div style="font-size:26px; margin-bottom:10px;">üìÖ INGRESA EN ${diffDias} D√çA${diffDias !== 1 ? 'S' : ''}</div>`;
      mensaje += `<div style="font-size:20px; color:#2980b9;">${ymdToDMY(ingresoFecha)}</div>`;
      mensaje += `<div style="font-size:14px; margin-top:8px; color:#666;">Fecha de reingreso</div>`;
    }
    
    document.getElementById('mobileIngresoInfo').innerHTML = mensaje;
  } else {
    document.getElementById('mobileIngresoInfo').innerHTML = 
      '<div style="font-size:20px; color:#7f8c8d;">No tiene vacaciones programadas</div>' +
      '<div style="font-size:14px; margin-top:5px; color:#95a5a6;">o ya ingres√≥ a trabajar</div>';
  }
  
  document.getElementById('mobileIngresoPopup').style.display = 'flex';
}

function cerrarMobileIngreso() {
  modalAbierto = false;
  document.getElementById('mobileIngresoPopup').style.display = 'none';
  
  // Despu√©s de 300ms, abrir el popup completo
  setTimeout(() => {
    if (personaSeleccionadaMobile) {
      abrirPopupPersona(personaSeleccionadaMobile);
      personaSeleccionadaMobile = null;
    }
  }, 300);
}

// Funci√≥n para abrir popup persona (actualizada)
function abrirPopupPersona(p){
  modalAbierto = true;
  document.getElementById('tituloPopupPersona').innerText = `Calendario de ${p.nombre}`;
  generarTresMeses(p);
  generarResumenPersona(p);
  document.getElementById('calPersonaPopup').style.display = "flex";
}

function cerrarPopupPersona(){ 
  modalAbierto = false;
  document.getElementById('calPersonaPopup').style.display = "none"; 
}

/* EVENTOS */
document.getElementById('filtroPlanta').addEventListener('change', function() {
  const plantaSeleccionada = this.value;
  cargarPuestosEnFiltro(plantaSeleccionada);
  filtrarPorPlantaYPuesto();
});

document.getElementById('filtroPuesto').addEventListener('change', function() {
  filtrarPorPlantaYPuesto();
});

document.getElementById('upload').addEventListener('change', e => {
  const f = e.target.files[0]; 
  if(!f) return;
  
  const r = new FileReader();
  r.onload = v => {
    try{
      data = JSON.parse(v.target.result);
      normalizeData();
      const plantaSeleccionada = document.getElementById('filtroPlanta').value;
      cargarPuestosEnFiltro(plantaSeleccionada);
      buildFlatList();
      renderGrid();
      renderMobileView();
      verificarNovedadesHoy();
      alert("JSON cargado exitosamente");
    }
    catch(err){
      alert("Archivo inv√°lido: " + err.message);
    }
  };
  r.readAsText(f, "utf-8");
});

// Agregar evento para cerrar con la tecla ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const ingresoPopup = document.getElementById('mobileIngresoPopup');
    if (ingresoPopup.style.display === 'flex') {
      cerrarMobileIngreso();
    } else {
      const calPersonaPopup = document.getElementById('calPersonaPopup');
      if (calPersonaPopup.style.display === 'flex') {
        cerrarPopupPersona();
      } else if (document.getElementById('modalNovedades')) {
        document.getElementById('modalNovedades').remove();
      }
    }
  }
});

/* INICIO */
loadJSON();
</script>

</body>
</html>