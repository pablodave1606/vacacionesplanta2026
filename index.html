<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vacaciones - Planta</title>

<style>
/* ====== MEJORAS DE LECTURA EN EL MODAL ====== */
.calMes { 
  background:#fafafa; 
  padding:15px; 
  border-radius:12px; 
  border:1px solid #ddd; 
}
.calMes h3 { text-align:center; font-size:20px; margin-bottom:10px; color:#333; }
.calMes3 table { border:1px solid #ccc; border-radius:8px; overflow:hidden; }
.calMes3 table th, .calMes3 table td { border:1px solid #ddd; padding:6px; }
.calMes3 table tr:nth-child(even) td { background:#fafafa; }

.diaVac3 { background:#7ed47e !important; font-weight:bold !important; }
.diaArt3 { background:#D7EEFF !important; }
.diaLoaFrac3 { background:#ffd8b3 !important; font-weight:bold !important; }
.diaFeriado3 { background:#ffcccc !important; }
.diaFuera { color:#aaa; }

/* ================== ESTILOS GENERALES ================== */
.today-header { background:#ffe08c !important; font-weight:bold; border-bottom:2px solid #d09000; }

table thead th { position:sticky; top:0; z-index:20; background:#fafafa; box-shadow:0 2px 3px rgba(0,0,0,0.15); }
#gridWrap {
  border:1px solid #ddd;
  background:#fff;
  padding:8px;
  border-radius:6px;
  height: calc(100vh - 140px);
  overflow: auto;
}

table { border-collapse:collapse; width:100%; font-size:12px; }
th,td { border:1px solid #eee; padding:4px; min-width:28px; text-align:center; white-space:nowrap; }
th.sticky { position:sticky; left:0; background:#fafafa; z-index:7; }
td.name { min-width:220px; text-align:left; position:sticky; left:0; background:#fff; z-index:6; }
.name-hn { background:#e8f4ff !important; }

body { font-family:Arial; margin:10px; background:#f6f7fb; color:#222; }
header { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
h1 { margin:0 0 10px 0; font-size:20px }

.vac { background:#7ed47e !important; font-weight:bold; }
.art { background:#D7EEFF !important; }
.loa_frac { background:#ffd8b3 !important; font-weight:bold; }
.holiday { background:#ffcccc !important; }

.legend { display:flex; gap:10px; margin-left:10px }
.btn { padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer }

/* ================== POPUP PERSONA ================== */
#calPersonaPopup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.65); display:none; justify-content:center; align-items:flex-start; padding-top:30px; z-index:99999; }
#calPersonaBox {
  background:#fff;
  padding:20px;
  border-radius:12px;
  width:95%;
  max-width:1100px;
  max-height:85vh;
  overflow-y:auto;
  box-shadow:0 0 25px rgba(0,0,0,0.35);
  margin-top:40px;
}

#calPersonaBox .btn {
  position:sticky;
  top:0;
  background:#fff;
  z-index:50;
  margin-bottom:10px;
}

.calMes3 {
  display:inline-block;
  width:30%;
  vertical-align:top;
  margin-bottom:20px;
  padding:5px;
}

#resumenPersona { margin-top:20px; padding:12px; border:1px solid #ccc; background:#fafafa; border-radius:6px; }

/* ================== VISTA CELULAR ================== */
#mobileView { display: none; }

.mobile-person-card {
  background: white;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border: 1px solid #ddd;
}

.mobile-person-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.mobile-person-name {
  font-weight: bold;
  font-size: 16px;
}

.mobile-person-planta {
  font-size: 12px;
  background: #e8f4ff;
  padding: 2px 8px;
  border-radius: 12px;
}

.mobile-person-details {
  font-size: 12px;
  color: #666;
  margin-bottom: 10px;
}

/* ===== ENCABEZADO LIMPIO ===== */
.header-clean {
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  padding:10px 0 20px 0;
  border-bottom:1px solid #ddd;
}

.header-title h1 {
  font-size:22px;
  margin:0;
  font-weight:800;
}

.subtitle {
  margin-top:3px;
  color:#666;
  font-size:13px;
}

.header-controls {
  display:flex;
  flex-direction:column;
  gap:10px;
}

.leg-item {
  display:flex;
  align-items:center;
  gap:6px;
}

.leg-box {
  width:18px;
  height:14px;
  border:1px solid #aaa;
}

/* ================== RESPONSIVE ================== */
@media (max-width: 768px) {
  #gridWrap { display: none !important; }
  #mobileView { display: block; }
  
  .header-clean {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
  
  .header-title h1 { font-size: 18px; }
  .header-controls { width: 100%; }
  .legend { flex-wrap: wrap; gap: 8px; }
  
  .filters {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }
  
  .filters select, .filters input { width: 100%; }
  .calMes3 { width: 100% !important; }
}

/* ================ ESTILOS PARA PERÍODOS ================ */
.vacation-periods-container {
  margin: 15px 0;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #7ed47e;
}

.vacation-period {
  margin-bottom: 10px;
  padding: 8px;
  background: white;
  border-radius: 6px;
  border: 1px solid #e0e0e0;
}

.vacation-period:last-child {
  margin-bottom: 0;
}

.vacation-period-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 5px;
}

.vacation-period-title {
  font-weight: bold;
  color: #2c3e50;
}

.vacation-period-dates {
  font-size: 13px;
  color: #666;
}

.vacation-period-info {
  display: flex;
  gap: 15px;
  font-size: 12px;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.no-vacations {
  color: #666;
  font-style: italic;
  padding: 10px;
  text-align: center;
  background: #f9f9f9;
  border-radius: 6px;
}

/* ================== MODAL INGRESO MÓVIL ================== */
#mobileIngresoPopup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 100000;
  padding: 20px;
}

#mobileIngresoBox {
  background: #fff;
  padding: 25px;
  border-radius: 15px;
  width: 90%;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 0 30px rgba(0,0,0,0.4);
}

#mobileIngresoBox h2 {
  margin: 0 0 15px 0;
  color: #2c3e50;
  font-size: 20px;
  border-bottom: 2px solid #7ed47e;
  padding-bottom: 10px;
}

#mobileIngresoInfo {
  font-size: 18px;
  font-weight: bold;
  color: #27ae60;
  margin: 20px 0;
  padding: 15px;
  background: #f0f9f0;
  border-radius: 8px;
  border-left: 4px solid #27ae60;
}

#mobileIngresoBtn {
  background: #7ed47e;
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  width: 100%;
  margin-top: 15px;
  transition: background 0.3s;
}

#mobileIngresoBtn:hover {
  background: #5cc25c;
}
</style>
</head>

<body>

<!-- POPUP PERSONA -->
<div id="calPersonaPopup">
  <div id="calPersonaBox">
    <button onclick="cerrarPopupPersona()" class="btn">Volver</button>
    <h2 id="tituloPopupPersona"></h2>
    <div id="mesesPersona"></div>
    <div id="resumenPersona"></div>
  </div>
</div>

<!-- POPUP INGRESO MÓVIL -->
<div id="mobileIngresoPopup">
  <div id="mobileIngresoBox">
    <h2 id="mobileIngresoTitulo"></h2>
    <div id="mobileIngresoInfo"></div>
    <button id="mobileIngresoBtn" onclick="cerrarMobileIngreso()">Ver calendario completo</button>
  </div>
</div>

<header class="header-clean">
  <div class="header-title">
    <h1>VACACIONES Y ARTÍCULOS – CENTRO DE EXPLOSIVOS</h1>
    <div class="subtitle">Dic 2025 – Mar 2026</div>
  </div>

  <div class="header-controls">
    <div class="legend">
      <span class="leg-item"><div class="leg-box vac"></div> Vacaciones</span>
      <span class="leg-item"><div class="leg-box art"></div> Artículos</span>
      <span class="leg-item"><div class="leg-box loa_frac"></div> LOA Frac</span>
      <span class="leg-item"><div class="leg-box holiday"></div> Feriados / Findes</span>
    </div>

    <div class="filters">
      Personal:
      <select id="filtroPlanta" class="btn">
        <option value="TODOS">Todos</option>
        <option value="PLANTA I">Planta I</option>
        <option value="PLANTA HN">Planta HN</option>
      </select>

      <input type="file" id="upload" accept=".json" class="btn">
    </div>
  </div>
</header>

<!-- VISTA PC -->
<div id="gridWrap"></div>

<!-- VISTA MÓVIL -->
<div id="mobileView">
  <div id="mobilePersonList"></div>
</div>

<script>
/* ================= CONFIG =================== */
const jsonPath = "vacaciones.json";
const startDate = new Date(2025,11,1);
const endDate   = new Date(2026,2,31);

let data = {};
let flatPeople = [];

const feriadosAR = [
  "2025-12-08","2025-12-24","2025-12-25","2025-12-31",
  "2026-01-01","2026-02-16","2026-02-17",
  "2026-03-24","2026-03-29","2026-03-30"
];

function dateToYMD(d){ const mm=("0"+(d.getMonth()+1)).slice(-2); const dd=("0"+d.getDate()).slice(-2); return d.getFullYear()+"-"+mm+"-"+dd; }
function ymdToLocal(s){ const [y,m,d]=s.split("-"); return new Date(y,m-1,d); }
function ymdToDMY(s){ if(!s) return ""; const [y,m,d]=s.split("-"); return `${d}/${m}/${y}`; }

// NUEVO: Función para obtener todos los días de vacaciones de una persona (múltiples períodos)
function getDiasVacPersona(p) {
  const dias = [];
  if (p.vacaciones && p.vacaciones.length > 0) {
    p.vacaciones.forEach(periodo => {
      if (periodo.inicio && periodo.fin) {
        let d = ymdToLocal(periodo.inicio);
        const fin = ymdToLocal(periodo.fin);
        while (d <= fin) {
          dias.push(dateToYMD(d));
          d = new Date(d.setDate(d.getDate() + 1));
        }
      }
    });
  }
  return dias;
}

// NUEVO: Función para obtener el total de días de vacaciones
function getTotalDiasVac(p) {
  let total = 0;
  if (p.vacaciones && p.vacaciones.length > 0) {
    p.vacaciones.forEach(periodo => {
      if (periodo.inicio && periodo.fin) {
        const inicio = ymdToLocal(periodo.inicio);
        const fin = ymdToLocal(periodo.fin);
        const dias = Math.round((fin - inicio) / 86400000) + 1;
        total += dias;
      }
    });
  }
  return total;
}

function normalizeData(){
  Object.keys(data).forEach(pl => {
    let newPl = pl.toUpperCase().replace("_"," ");
    if(newPl==="I") newPl="PLANTA I";
    if(newPl==="HN") newPl="PLANTA HN";
    if(newPl!==pl){ data[newPl]=data[pl]; delete data[pl]; pl=newPl; }

    data[pl]=data[pl].map(p=>{
      // NUEVO: Compatibilidad con versión anterior
      if (!p.vacaciones) {
        p.vacaciones = [];
        if (p.vacacion_inicio && p.vacacion_fin) {
          p.vacaciones.push({
            inicio: p.vacacion_inicio,
            fin: p.vacacion_fin
          });
        }
        // Eliminar campos antiguos
        delete p.vacacion_inicio;
        delete p.vacacion_fin;
      }
      
      if(!p.articulos) p.articulos=[];
      if(!p.loa_frac) p.loa_frac=[];
      
      // Normalizar arrays si vienen como strings
      if(typeof p.articulos==="string"){
        p.articulos=p.articulos.replace(/;/g,",").split(",").map(a=>{
          a=a.trim();
          if(a.includes("/")){
            const [d,m,y]=a.split("/");
            return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
          }
          return a;
        }).filter(a=>a.length>0);
      }
      
      if(typeof p.loa_frac==="string"){
        p.loa_frac=p.loa_frac.replace(/;/g,",").split(",").map(a=>{
          a=a.trim();
          if(a.includes("/")){
            const [d,m,y]=a.split("/");
            return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
          }
          return a;
        }).filter(a=>a.length>0);
      }
      
      return p;
    });
  });
}

async function loadJSON(){
  try{
    const r = await fetch(jsonPath+"?nocache="+Math.random());
    data = await r.json();
  }catch(e){ data={}; }

  normalizeData();
  buildFlatList();
  renderGrid();
  renderMobileView();
  verificarNovedadesHoy();
}

function buildFlatList(){
  const f=document.getElementById('filtroPlanta').value;
  flatPeople=[];
  Object.keys(data).forEach(pl=>{
    if(f!=="TODOS" && f!==pl) return;
    data[pl].forEach(p=>flatPeople.push({planta:pl, ...p}));
  });
  flatPeople.sort((a,b)=> a.planta.localeCompare(b.planta) || a.nombre.localeCompare(b.nombre));
}

function getDatesArray(){
  let arr=[]; for(let d=new Date(startDate); d<=endDate; d.setDate(d.getDate()+1)) arr.push(new Date(d)); return arr;
}

function monthFilterShows(d){ return true; }

function renderGrid(){
  const dates=getDatesArray();
  const wrap=document.getElementById('gridWrap');
  const dayI=["D","L","M","X","J","V","S"];
  const monthNames=["ene.","feb.","mar.","abr.","may.","jun.","jul.","ago.","sep.","oct.","nov.","dic."];

  let html='<table><thead><tr><th class="sticky">Planta / Nombre</th>';

  dates.forEach(d=>{
    if(!monthFilterShows(d)) return;
    const ymd=dateToYMD(d);
    const today=dateToYMD(new Date());
    html+=`<th class="${ymd===today?'today-header':''}">
      <div style="font-size:11px">${dayI[d.getDay()]}</div>
      <div style="font-size:9px">${monthNames[d.getMonth()]}</div>
      <div>${("0"+d.getDate()).slice(-2)}</div>
    </th>`;
  });

  html+='</tr></thead><tbody>';

  flatPeople.forEach((p,i)=>{
    const totalVac = getTotalDiasVac(p);
    const diasVac = getDiasVacPersona(p);
    const art = p.articulos || [];
    const loa = p.loa_frac || [];

    html+=`<tr onclick="abrirPopupPersona(flatPeople[${i}])" style="cursor:pointer">
      <td class="name ${p.planta==='PLANTA HN'?'name-hn':''}">
        <div style="font-size:15px;font-weight:bold;">${p.nombre}</div>
        <div style="font-size:11px;color:#444">
          Legajo: ${p.legajo}<br>
          Vacaciones: ${totalVac} días (${p.vacaciones ? p.vacaciones.length : 0} período${p.vacaciones && p.vacaciones.length !== 1 ? 's' : ''})<br>
          Planta: ${p.planta}
        </div>
      </td>`;

    let count=0;
    dates.forEach(d=>{
      if(!monthFilterShows(d)) return;
      const ymd=dateToYMD(d);
      const ld=ymdToLocal(ymd);

      let isVac = diasVac.includes(ymd);
      let isArt = art.includes(ymd);
      let isLoaFrac = loa.includes(ymd);

      let cls="";
      if(d.getDay()===0||d.getDay()===6) cls="holiday";
      if(feriadosAR.includes(ymd)) cls="holiday";
      if(isVac){ cls="vac"; count++; }
      else if(isArt) cls="art";
      else if(isLoaFrac) cls="loa_frac";

      html += `<td class="${cls}">` +
          (isVac ? `<span class='vac-num'>${count}</span>` : 
          (isArt ? `<span style="font-size:9px;font-weight:bold;">art. 155</span>` : 
          (isLoaFrac ? `<span style="font-size:8px;font-weight:bold;">LOA</span>` : ""))) +
        `</td>`;
    });

    html+='</tr>';
  });

  html+='</tbody></table>';
  wrap.innerHTML=html;
}

/* ================= VISTA MÓVIL ================== */
function renderMobileView() {
  const list = document.getElementById('mobilePersonList');
  let html = '';
  
  flatPeople.forEach((p, i) => {
    const totalVac = getTotalDiasVac(p);
    const numPeriodos = p.vacaciones ? p.vacaciones.length : 0;
    
    html += `
      <div class="mobile-person-card" onclick="mostrarIngresoMobile(flatPeople[${i}])" style="cursor: pointer;">
        <div class="mobile-person-header">
          <div class="mobile-person-name">${p.nombre}</div>
          <div class="mobile-person-planta">${p.planta}</div>
        </div>
        <div class="mobile-person-details">
          Legajo: ${p.legajo} • Vacaciones: ${totalVac} días (${numPeriodos} período${numPeriodos !== 1 ? 's' : ''})
        </div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

/* ================= MODAL INGRESO MÓVIL ================= */
let personaSeleccionadaMobile = null;

function mostrarIngresoMobile(p) {
  personaSeleccionadaMobile = p;
  
  // Buscar la próxima fecha de ingreso a trabajar
  let ingresoFecha = null;
  let periodoInfo = null;
  
  if (p.vacaciones && p.vacaciones.length > 0) {
    const hoy = new Date();
    const hoyYMD = dateToYMD(hoy);
    
    // Buscar si hoy está en un período de vacaciones
    const diasVac = getDiasVacPersona(p);
    
    if (diasVac.includes(hoyYMD)) {
      // Hoy está de vacaciones, buscar cuándo termina
      p.vacaciones.forEach(periodo => {
        if (periodo.inicio && periodo.fin) {
          const inicio = ymdToLocal(periodo.inicio);
          const fin = ymdToLocal(periodo.fin);
          const hoyDate = ymdToLocal(hoyYMD);
          
          if (hoyDate >= inicio && hoyDate <= fin) {
            periodoInfo = periodo;
            // Calcular día de reingreso
            ingresoFecha = calcularDiaReingreso(fin, p.articulos || [], p.loa_frac || []);
          }
        }
      });
    } else {
      // No está de vacaciones hoy, buscar si viene de unas vacaciones recientes
      p.vacaciones.forEach(periodo => {
        if (periodo.fin) {
          const finDate = ymdToLocal(periodo.fin);
          const reingreso = calcularDiaReingreso(finDate, p.articulos || [], p.loa_frac || []);
          const reingresoDate = ymdToLocal(reingreso);
          
          // Si el reingreso es hoy o futuro
          if (reingresoDate >= hoy) {
            if (!ingresoFecha || reingresoDate < ymdToLocal(ingresoFecha)) {
              ingresoFecha = reingreso;
              periodoInfo = periodo;
            }
          }
        }
      });
    }
  }
  
  // Mostrar el modal
  document.getElementById('mobileIngresoTitulo').textContent = p.nombre;
  
  if (ingresoFecha) {
    const hoyYMD = dateToYMD(new Date());
    const ingresoDate = ymdToLocal(ingresoFecha);
    const hoyDate = ymdToLocal(hoyYMD);
    
    let mensaje = '';
    
    if (ingresoFecha === hoyYMD) {
      mensaje = `Ingresa HOY a trabajar`;
    } else if (ingresoDate < hoyDate) {
      mensaje = `Ya ingresó a trabajar`;
    } else {
      const diffDias = Math.round((ingresoDate - hoyDate) / 86400000);
      mensaje = `Ingresa en ${diffDias} día${diffDias !== 1 ? 's' : ''}<br>`;
      mensaje += `<small>Fecha: ${ymdToDMY(ingresoFecha)}</small>`;
    }
    
    document.getElementById('mobileIngresoInfo').innerHTML = mensaje;
  } else {
    document.getElementById('mobileIngresoInfo').innerHTML = 
      'No tiene vacaciones programadas<br><small>o ya ingresó a trabajar</small>';
  }
  
  document.getElementById('mobileIngresoPopup').style.display = 'flex';
}

function cerrarMobileIngreso() {
  document.getElementById('mobileIngresoPopup').style.display = 'none';
  
  // Después de 300ms, abrir el popup completo
  setTimeout(() => {
    if (personaSeleccionadaMobile) {
      abrirPopupPersona(personaSeleccionadaMobile);
      personaSeleccionadaMobile = null;
    }
  }, 300);
}

// También permitir cerrar haciendo clic fuera del modal
document.getElementById('mobileIngresoPopup').addEventListener('click', function(e) {
  if (e.target.id === 'mobileIngresoPopup') {
    cerrarMobileIngreso();
  }
});

/* ================= POPUP PERSONA ================= */
function abrirPopupPersona(p){
  document.getElementById('tituloPopupPersona').innerText = `Calendario de ${p.nombre}`;
  generarTresMeses(p);
  generarResumenPersona(p);
  document.getElementById('calPersonaPopup').style.display = "flex";
}

function cerrarPopupPersona(){ 
  document.getElementById('calPersonaPopup').style.display = "none"; 
}

function generarTresMeses(p){
  document.getElementById('mesesPersona').innerHTML = "";
  
  const meses = [new Date(2025,11), new Date(2026,0), new Date(2026,1), new Date(2026,2)];
  let mostrar = [];

  meses.forEach(m => {
    const y = m.getFullYear(), mes = m.getMonth();
    const ini = new Date(y, mes, 1), fm = new Date(y, mes + 1, 0);

    let ok = false;

    // Verificar si hay vacaciones en este mes
    if (p.vacaciones && p.vacaciones.length > 0) {
      p.vacaciones.forEach(periodo => {
        if (periodo.inicio && periodo.fin) {
          const inicio = ymdToLocal(periodo.inicio);
          const fin = ymdToLocal(periodo.fin);
          if (!(fin < ini || inicio > fm)) ok = true;
        }
      });
    }

    // Verificar artículos
    if (!ok && p.articulos && p.articulos.length > 0) {
      p.articulos.forEach(a => {
        if(!a) return;
        const d = ymdToLocal(a);
        if(isNaN(d)) return;
        if(d.getMonth() === mes && d.getFullYear() === y) ok = true;
      });
    }

    // Verificar LOA Frac
    if (!ok && p.loa_frac && p.loa_frac.length > 0) {
      p.loa_frac.forEach(a => {
        if(!a) return;
        const d = ymdToLocal(a);
        if(isNaN(d)) return;
        if(d.getMonth() === mes && d.getFullYear() === y) ok = true;
      });
    }

    if(ok) mostrar.push(m);
  });

  if(!mostrar.length) mostrar = [new Date(2026,0)];
  mostrar.forEach(m => document.getElementById('mesesPersona').appendChild(crearMesPersona(m, p)));
}

function crearMesPersona(fm, p){
  const y = fm.getFullYear(), mes = fm.getMonth();
  const div = document.createElement("div"); 
  div.className = "calMes3";

  const vac = getDiasVacPersona(p);
  const art = p.articulos || [];
  const loa = p.loa_frac || [];
  const ini = new Date(y, mes, 1);
  const fin = new Date(y, mes + 1, 0).getDate();

  const nombres = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  let html = `<div class='calMes'><h3>${nombres[mes]} ${y}</h3><table><tr><th>L</th><th>M</th><th>Mi</th><th>J</th><th>V</th><th>S</th><th>D</th></tr><tr>`;

  let off = (ini.getDay() === 0 ? 6 : ini.getDay() - 1);
  for(let i = 0; i < off; i++) html += `<td class='diaFuera'></td>`;

  for(let d = 1; d <= fin; d++){
    const fstr = `${y}-${String(mes + 1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dow = ymdToLocal(fstr).getDay();

    let cls = "";
    if(vac.includes(fstr)) cls = "diaVac3";
    else if(art.includes(fstr)) cls = "diaArt3";
    else if(loa.includes(fstr)) cls = "diaLoaFrac3";
    else if(feriadosAR.includes(fstr)) cls = "diaFeriado3";
    else if(dow === 0 || dow === 6) cls = "diaFeriado3";

    html += `<td class='${cls}'>${d}</td>`;
    if((off + d) % 7 === 0) html += "</tr><tr>";
  }

  html += "</tr></table></div>";
  div.innerHTML = html;
  return div;
}

function generarResumenPersona(p){
  let html = `<h3>Resumen</h3>`;
  
  // Mostrar períodos de vacaciones
  if (p.vacaciones && p.vacaciones.length > 0) {
    html += `<div class="vacation-periods-container">`;
    html += `<h4>Períodos de Vacaciones</h4>`;
    
    p.vacaciones.forEach((periodo, index) => {
      const inicio = periodo.inicio;
      const fin = periodo.fin;
      const inicioDate = ymdToLocal(inicio);
      const finDate = ymdToLocal(fin);
      const dias = Math.round((finDate - inicioDate) / 86400000) + 1;
      const reingreso = calcularDiaReingreso(finDate, p.articulos || [], p.loa_frac || []);
      
      html += `
        <div class="vacation-period">
          <div class="vacation-period-header">
            <div class="vacation-period-title">Período ${index + 1}</div>
            <div class="vacation-period-dates">${dias} días</div>
          </div>
          <div class="vacation-period-info">
            <div class="info-item"><strong>Inicio:</strong> ${ymdToDMY(inicio)}</div>
            <div class="info-item"><strong>Fin:</strong> ${ymdToDMY(fin)}</div>
            <div class="info-item"><strong>Vuelve:</strong> ${ymdToDMY(reingreso)}</div>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
  } else {
    html += `<p class="no-vacations">No tiene períodos de vacaciones asignados.</p>`;
  }
  
  // Mostrar artículos
  html += `<p><strong>Artículos:</strong> ${(p.articulos||[]).map(a => ymdToDMY(a)).join(", ") || "Sin artículos"}</p>`;
  
  // Mostrar LOA Frac
  html += `<p><strong>LOA Frac:</strong> ${(p.loa_frac||[]).map(a => ymdToDMY(a)).join(", ") || "Sin LOA Frac"}</p>`;
  
  // Mostrar total
  const totalVac = getTotalDiasVac(p);
  html += `<p style='font-size:18px; margin-top: 20px; padding: 10px; background: #f0f8ff; border-radius: 6px;'>
    <strong>Total días de vacaciones:</strong> ${totalVac} días
  </p>`;
  
  document.getElementById('resumenPersona').innerHTML = html;
}

// NUEVO: Función para calcular día de reingreso para un período específico
function calcularDiaReingreso(finVac, art, loaFrac){
  let f = new Date(finVac); 
  f.setDate(f.getDate() + 1);
  while(true){
    const ymd = dateToYMD(f);
    const dow = f.getDay();
    if(dow !== 0 && dow !== 6 && !feriadosAR.includes(ymd) && 
       !(art||[]).includes(ymd) && !(loaFrac||[]).includes(ymd)) {
      return ymd;
    }
    f.setDate(f.getDate() + 1);
  }
}

/* ========== MODAL NOVEDADES ========== */
function verificarNovedadesHoy(){
  const hoy = dateToYMD(new Date());
  let vac = [], art = [], loa = [], ing = [];

  flatPeople.forEach(p => {
    // Verificar si comienza vacaciones hoy
    if (p.vacaciones && p.vacaciones.length > 0) {
      p.vacaciones.forEach(periodo => {
        if (periodo.inicio === hoy) vac.push({persona: p, periodo: periodo});
      });
    }
    
    if((p.articulos||[]).includes(hoy)) art.push(p);
    if((p.loa_frac||[]).includes(hoy)) loa.push(p);
    
    // Verificar si hoy es día de reingreso de algún período
    if(p.vacaciones && p.vacaciones.length > 0) {
      p.vacaciones.forEach(periodo => {
        if (periodo.fin) {
          const finDate = ymdToLocal(periodo.fin);
          const reingreso = calcularDiaReingreso(finDate, p.articulos || [], p.loa_frac || []);
          if(reingreso === hoy) ing.push({persona: p, periodo: periodo});
        }
      });
    }
  });

  if(!vac.length && !art.length && !loa.length && !ing.length) return;

  let h = `<h2>Novedades del día ${ymdToDMY(hoy)}</h2>`;
  if(art.length){ 
    h += `<h3>Artículos</h3><ul>` + art.map(p => `<li>${p.nombre}</li>`).join("") + "</ul>"; 
  }
  if(vac.length){ 
    h += `<h3>Comienzan vacaciones</h3><ul>` + 
         vac.map(v => `<li>${v.persona.nombre} (${ymdToDMY(v.periodo.inicio)} - ${ymdToDMY(v.periodo.fin)})</li>`).join("") + 
         "</ul>"; 
  }
  if(loa.length){ 
    h += `<h3>LOA Fraccionada</h3><ul>` + loa.map(p => `<li>${p.nombre}</li>`).join("") + "</ul>"; 
  }
  if(ing.length){ 
    h += `<h3>Ingresan a trabajar</h3><ul>` + 
         ing.map(i => `<li>${i.persona.nombre} (del período ${ymdToDMY(i.periodo.inicio)} - ${ymdToDMY(i.periodo.fin)})</li>`).join("") + 
         "</ul>"; 
  }

  const modal = document.createElement("div");
  modal.id = "modalNovedades";
  modal.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.65);display:flex;justify-content:center;align-items:center;z-index:999999";
  modal.innerHTML = `<div style='background:#fff;padding:20px;border-radius:12px;max-width:500px;width:90%'>${h}<button class='btn' onclick='document.getElementById("modalNovedades").remove()'>Cerrar</button></div>`;
  document.body.appendChild(modal);
}

/* ========== MANEJAR BOTÓN VOLVER DE ANDROID ========== */
// Variable para rastrear si hay un modal abierto
let modalAbierto = false;

// Interceptar el evento de botón "atrás" en Android
window.addEventListener('popstate', function(event) {
  if (modalAbierto) {
    // Si hay un modal abierto, lo cerramos en lugar de salir de la página
    event.preventDefault();
    
    // Cerrar el modal que esté visible
    const ingresoPopup = document.getElementById('mobileIngresoPopup');
    const calPersonaPopup = document.getElementById('calPersonaPopup');
    
    if (ingresoPopup.style.display === 'flex') {
      cerrarMobileIngreso();
    } else if (calPersonaPopup.style.display === 'flex') {
      cerrarPopupPersona();
    } else if (document.getElementById('modalNovedades')) {
      document.getElementById('modalNovedades').remove();
    }
  }
});

// Función para abrir modal de ingreso (actualizada)
function mostrarIngresoMobile(p) {
  personaSeleccionadaMobile = p;
  modalAbierto = true;
  
  // Buscar la próxima fecha de ingreso a trabajar
  let ingresoFecha = null;
  let periodoInfo = null;
  
  if (p.vacaciones && p.vacaciones.length > 0) {
    const hoy = new Date();
    const hoyYMD = dateToYMD(hoy);
    
    // Buscar si hoy está en un período de vacaciones
    const diasVac = getDiasVacPersona(p);
    
    if (diasVac.includes(hoyYMD)) {
      // Hoy está de vacaciones, buscar cuándo termina
      p.vacaciones.forEach(periodo => {
        if (periodo.inicio && periodo.fin) {
          const inicio = ymdToLocal(periodo.inicio);
          const fin = ymdToLocal(periodo.fin);
          const hoyDate = ymdToLocal(hoyYMD);
          
          if (hoyDate >= inicio && hoyDate <= fin) {
            periodoInfo = periodo;
            // Calcular día de reingreso
            ingresoFecha = calcularDiaReingreso(fin, p.articulos || [], p.loa_frac || []);
          }
        }
      });
    } else {
      // No está de vacaciones hoy, buscar si viene de unas vacaciones recientes
      p.vacaciones.forEach(periodo => {
        if (periodo.fin) {
          const finDate = ymdToLocal(periodo.fin);
          const reingreso = calcularDiaReingreso(finDate, p.articulos || [], p.loa_frac || []);
          const reingresoDate = ymdToLocal(reingreso);
          
          // Si el reingreso es hoy o futuro
          if (reingresoDate >= hoy) {
            if (!ingresoFecha || reingresoDate < ymdToLocal(ingresoFecha)) {
              ingresoFecha = reingreso;
              periodoInfo = periodo;
            }
          }
        }
      });
    }
  }
  
  // Mostrar el modal
  document.getElementById('mobileIngresoTitulo').textContent = p.nombre;
  
  if (ingresoFecha) {
    const hoyYMD = dateToYMD(new Date());
    const ingresoDate = ymdToLocal(ingresoFecha);
    const hoyDate = ymdToLocal(hoyYMD);
    
    let mensaje = '';
    
    if (ingresoFecha === hoyYMD) {
      mensaje = `Ingresa HOY a trabajar`;
    } else if (ingresoDate < hoyDate) {
      mensaje = `Ya ingresó a trabajar`;
    } else {
      const diffDias = Math.round((ingresoDate - hoyDate) / 86400000);
      mensaje = `Ingresa en ${diffDias} día${diffDias !== 1 ? 's' : ''}<br>`;
      mensaje += `<small>Fecha: ${ymdToDMY(ingresoFecha)}</small>`;
    }
    
    document.getElementById('mobileIngresoInfo').innerHTML = mensaje;
  } else {
    document.getElementById('mobileIngresoInfo').innerHTML = 
      'No tiene vacaciones programadas<br><small>o ya ingresó a trabajar</small>';
  }
  
  document.getElementById('mobileIngresoPopup').style.display = 'flex';
}

function cerrarMobileIngreso() {
  modalAbierto = false;
  document.getElementById('mobileIngresoPopup').style.display = 'none';
  
  // Después de 300ms, abrir el popup completo
  setTimeout(() => {
    if (personaSeleccionadaMobile) {
      abrirPopupPersona(personaSeleccionadaMobile);
      personaSeleccionadaMobile = null;
    }
  }, 300);
}

// Función para abrir popup persona (actualizada)
function abrirPopupPersona(p){
  modalAbierto = true;
  document.getElementById('tituloPopupPersona').innerText = `Calendario de ${p.nombre}`;
  generarTresMeses(p);
  generarResumenPersona(p);
  document.getElementById('calPersonaPopup').style.display = "flex";
}

function cerrarPopupPersona(){ 
  modalAbierto = false;
  document.getElementById('calPersonaPopup').style.display = "none"; 
}

/* EVENTOS */
document.getElementById('filtroPlanta').onchange = () => { 
  buildFlatList(); 
  renderGrid(); 
  renderMobileView();
};

document.getElementById('upload').onchange = e => {
  const f = e.target.files[0]; 
  if(!f) return;
  
  const r = new FileReader();
  r.onload = v => {
    try{
      data = JSON.parse(v.target.result);
      normalizeData();
      buildFlatList();
      renderGrid();
      renderMobileView();
      verificarNovedadesHoy();
      alert("JSON cargado exitosamente");
    }
    catch(err){
      alert("Archivo inválido: " + err.message);
    }
  };
  r.readAsText(f, "utf-8");
};

// Agregar evento para cerrar con la tecla ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const ingresoPopup = document.getElementById('mobileIngresoPopup');
    if (ingresoPopup.style.display === 'flex') {
      cerrarMobileIngreso();
    } else {
      const calPersonaPopup = document.getElementById('calPersonaPopup');
      if (calPersonaPopup.style.display === 'flex') {
        cerrarPopupPersona();
      } else if (document.getElementById('modalNovedades')) {
        document.getElementById('modalNovedades').remove();
      }
    }
  }
});

/* INICIO */
loadJSON();
</script>

</body>
</html>