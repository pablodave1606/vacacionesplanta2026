<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vacaciones - Planta</title>

<style>
/* ====== MEJORAS DE LECTURA EN EL MODAL ====== */
.calMes { 
  background:#fafafa; 
  padding:15px; 
  border-radius:12px; 
  border:1px solid #ddd; 
}
.calMes h3 { text-align:center; font-size:20px; margin-bottom:10px; color:#333; }
.calMes3 table { border:1px solid #ccc; border-radius:8px; overflow:hidden; }
.calMes3 table th, .calMes3 table td { border:1px solid #ddd; padding:6px; }
.calMes3 table tr:nth-child(even) td { background:#fafafa; }

.diaVac3 { background:#7ed47e !important; font-weight:bold !important; }
.diaArt3 { background:#D7EEFF !important; }
.diaLoaFrac3 { background:#ffd8b3 !important; font-weight:bold !important; } /* NUEVO: color para LOA Frac */
.diaFeriado3 { background:#ffcccc !important; }
.diaFuera { color:#aaa; }

/* ================== ESTILOS GENERALES ================== */
.today-header { background:#ffe08c !important; font-weight:bold; border-bottom:2px solid #d09000; }

table thead th { position:sticky; top:0; z-index:20; background:#fafafa; box-shadow:0 2px 3px rgba(0,0,0,0.15); }
#gridWrap {
  border:1px solid #ddd;
  background:#fff;
  padding:8px;
  border-radius:6px;
  height: calc(100vh - 140px);  /* ocupa TODO el alto disponible */
  overflow: auto;
}

table { border-collapse:collapse; width:100%; font-size:12px; }
th,td { border:1px solid #eee; padding:4px; min-width:28px; text-align:center; white-space:nowrap; }
th.sticky { position:sticky; left:0; background:#fafafa; z-index:7; }
td.name { min-width:220px; text-align:left; position:sticky; left:0; background:#fff; z-index:6; }
.name-hn { background:#e8f4ff !important; }

body { font-family:Arial; margin:10px; background:#f6f7fb; color:#222; }
header { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
h1 { margin:0 0 10px 0; font-size:20px }

.vac { background:#7ed47e !important; font-weight:bold; }
.art { background:#D7EEFF !important; }
.loa_frac { background:#ffd8b3 !important; font-weight:bold; } /* NUEVO: color para LOA Frac */
.holiday { background:#ffcccc !important; }

.legend { display:flex; gap:10px; margin-left:10px }
.btn { padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer }
/* ===== ESTILOS PARA CALENDARIO MÓVIL ===== */
.calMesMobile table th, 
.calMesMobile table td {
  border: 1px solid #ddd !important;
  padding: 6px !important;
  min-width: auto !important;
}

.calMesMobile table {
  border: 1px solid #ccc !important;
  border-radius: 8px !important;
  overflow: hidden !important;
  margin-bottom: 10px !important;
}

/* Mejorar scroll en modal móvil */
.mobile-popup-content {
  max-height: 85vh;
  overflow-y: auto;
}

/* Responsive para móvil en el modal */
@media (max-width: 480px) {
  .calMesMobile {
    padding: 10px !important;
  }
  
  .calMesMobile table {
    font-size: 12px !important;
  }
  
  .calMesMobile table th,
  .calMesMobile table td {
    padding: 4px !important;
  }
}

/* ================== POPUP PERSONA ================== */
#calPersonaPopup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.65); display:none; justify-content:center; align-items:flex-start; padding-top:30px; z-index:99999; }
#calPersonaBox {
  background:#fff;
  padding:20px;
  border-radius:12px;
  width:95%;
  max-width:1100px;
  max-height:85vh;
  overflow-y:auto;
  box-shadow:0 0 25px rgba(0,0,0,0.35);
  margin-top:40px;     /* más aire arriba */
}

/* Botón fijo */
#calPersonaBox .btn {
  position:sticky;
  top:0;
  background:#fff;
  z-index:50;
  margin-bottom:10px;
}

.calMes3 {
  display:inline-block;
  width:30%;
  vertical-align:top;
  margin-bottom:20px;
  padding:5px;
}

#resumenPersona { margin-top:20px; padding:12px; border:1px solid #ccc; background:#fafafa; border-radius:6px; }

/* ================== VISTA CELULAR ================== */
#mobileView {
  display: none;
}

.mobile-person-card {
  background: white;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border: 1px solid #ddd;
}

.mobile-person-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.mobile-person-name {
  font-weight: bold;
  font-size: 16px;
}

.mobile-person-planta {
  font-size: 12px;
  background: #e8f4ff;
  padding: 2px 8px;
  border-radius: 12px;
}

.mobile-person-details {
  font-size: 12px;
  color: #666;
  margin-bottom: 10px;
}

.mobile-date-grid {
  display: flex;
  overflow-x: auto;
  gap: 8px;
  padding: 5px 0;
}

.mobile-date-item {
  min-width: 50px;
  text-align: center;
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #eee;
  background: #f9f9f9;
}

.mobile-date-item.vac {
  background: #7ed47e;
  border-color: #5cb85c;
  font-weight: bold;
}

.mobile-date-item.art {
  background: #D7EEFF;
  border-color: #87CEEB;
}

.mobile-date-item.loa_frac {
  background: #ffd8b3; /* NUEVO: color para LOA Frac */
  border-color: #e67e22;
  font-weight: bold;
}

.mobile-date-item.holiday {
  background: #ffcccc;
  border-color: #ff9999;
}

.mobile-date-day {
  font-size: 10px;
  color: #666;
}

.mobile-date-num {
  font-size: 14px;
  font-weight: bold;
}

.mobile-date-label {
  font-size: 9px;
  margin-top: 2px;
}

/* Modal móvil */
#mobilePersonPopup {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 100000;
  overflow-y: auto;
  padding: 20px 10px;
}

.mobile-popup-content {
  background: white;
  border-radius: 12px;
  padding: 20px;
  max-width: 500px;
  margin: 0 auto;
  position: relative;
  z-index: 100001;
}

/* Para cerrar tocando fuera del contenido */
#mobilePersonPopup::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

/* ===== ENCABEZADO LIMPIO ===== */
.header-clean {
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  padding:10px 0 20px 0;
  border-bottom:1px solid #ddd;
}

.header-title h1 {
  font-size:22px;
  margin:0;
  font-weight:800;
}

.subtitle {
  margin-top:3px;
  color:#666;
  font-size:13px;
}

.header-controls {
  display:flex;
  flex-direction:column;
  gap:10px;
}

.leg-item {
  display:flex;
  align-items:center;
  gap:6px;
}

.leg-box {
  width:18px;
  height:14px;
  border:1px solid #aaa;
}

/* ================== RESPONSIVE ================== */
@media (max-width: 768px) {
  #gridWrap {
    display: none !important;
  }
  
  #mobileView {
    display: block;
  }
  
  .header-clean {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
  
  .header-title h1 {
    font-size: 18px;
  }
  
  .header-controls {
    width: 100%;
  }
  
  .legend {
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .filters {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }
  
  .filters select, .filters input {
    width: 100%;
  }
  
  .calMes3 {
    width: 100% !important;
  }
}
</style>
</head>

<body>

<!-- POPUP PERSONA -->
<div id="calPersonaPopup">
  <div id="calPersonaBox">
    <button onclick="cerrarPopupPersona()" class="btn">Volver</button>
    <h2 id="tituloPopupPersona"></h2>
    <div id="mesesPersona"></div>
    <div id="resumenPersona"></div>
  </div>
</div>

<!-- POPUP MÓVIL -->
<div id="mobilePersonPopup">
  <div class="mobile-popup-content">
    <button id="mobileBackButton" onclick="cerrarMobilePopup()" class="btn" style="margin-bottom: 15px; width: 100%;">Volver</button>
    <h2 id="mobilePopupTitle"></h2>
    <div id="mobilePopupContent"></div>
  </div>
</div>

<header class="header-clean">
  <div class="header-title">
    <h1>VACACIONES Y ARTÍCULOS – CENTRO DE EXPLOSIVOS</h1>
    <div class="subtitle">Dic 2025 – Mar 2026</div>
  </div>

  <div class="header-controls">
    <div class="legend">
      <span class="leg-item"><div class="leg-box vac"></div> Vacaciones</span>
      <span class="leg-item"><div class="leg-box art"></div> Artículos</span>
      <span class="leg-item"><div class="leg-box loa_frac"></div> LOA Frac</span> <!-- NUEVO EN LEYENDA -->
      <span class="leg-item"><div class="leg-box holiday"></div> Feriados / Findes</span>
    </div>

    <div class="filters">
      Personal:
      <select id="filtroPlanta" class="btn">
        <option value="TODOS">Todos</option>
        <option value="PLANTA I">Planta I</option>
        <option value="PLANTA HN">Planta HN</option>
      </select>

      <input type="file" id="upload" accept=".json" class="btn">
    </div>
  </div>
</header>

<!-- VISTA PC -->
<div id="gridWrap"></div>

<!-- VISTA MÓVIL -->
<div id="mobileView">
  <div id="mobilePersonList"></div>
</div>

<script>
/* ================= CONFIG =================== */
// Variables para control del modal móvil
let isMobilePopupOpen = false;
let currentPersonData = null;

// CAMBIO: Usar el nuevo archivo JSON con LOA Frac
const jsonPath = "vacaciones.json";
const startDate = new Date(2025,11,1);
const endDate   = new Date(2026,2,31);

let data = {};
let flatPeople = [];

const feriadosAR = [
  "2025-12-08","2025-12-24","2025-12-25","2025-12-31",
  "2026-01-01","2026-02-16","2026-02-17",
  "2026-03-24","2026-03-29","2026-03-30"
];

function dateToYMD(d){ const mm=("0"+(d.getMonth()+1)).slice(-2); const dd=("0"+d.getDate()).slice(-2); return d.getFullYear()+"-"+mm+"-"+dd; }
function ymdToLocal(s){ const [y,m,d]=s.split("-"); return new Date(y,m-1,d); }
function ymdToDMY(s){ if(!s) return ""; const [y,m,d]=s.split("-"); return `${d}/${m}/${y}`; }

function normalizeData(){
  Object.keys(data).forEach(pl => {
    let newPl = pl.toUpperCase().replace("_"," ");
    if(newPl==="I") newPl="PLANTA I";
    if(newPl==="HN") newPl="PLANTA HN";
    if(newPl!==pl){ data[newPl]=data[pl]; delete data[pl]; pl=newPl; }

    data[pl]=data[pl].map(p=>{
      if(!p.articulos) p.articulos=[];
      if(!p.loa_frac) p.loa_frac=[]; // NUEVO: Asegurar que existe loa_frac
      
      if(typeof p.articulos==="string"){
        p.articulos=p.articulos.replace(/;/g,",").split(",").map(a=>{
          a=a.trim();
          if(a.includes("/")){
            const [d,m,y]=a.split("/");
            return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
          }
          return a;
        }).filter(a=>a.length>0);
      }
      
      // NUEVO: Normalizar también loa_frac si fuera string
      if(typeof p.loa_frac==="string"){
        p.loa_frac=p.loa_frac.replace(/;/g,",").split(",").map(a=>{
          a=a.trim();
          if(a.includes("/")){
            const [d,m,y]=a.split("/");
            return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
          }
          return a;
        }).filter(a=>a.length>0);
      }
      
      return p;
    });
  });
}

async function loadJSON(){
  try{
    const r = await fetch(jsonPath+"?nocache="+Math.random());
    data = await r.json();
  }catch(e){ data={}; }

  normalizeData();
  buildFlatList();
  renderGrid();
  renderMobileView();
  verificarNovedadesHoy();
}

function buildFlatList(){
  const f=filtroPlanta.value;
  flatPeople=[];
  Object.keys(data).forEach(pl=>{
    if(f!=="TODOS" && f!==pl) return;
    data[pl].forEach(p=>flatPeople.push({planta:pl, ...p}));
  });
  flatPeople.sort((a,b)=> a.planta.localeCompare(b.planta) || a.nombre.localeCompare(b.nombre));
}

function getDatesArray(){
  let arr=[]; for(let d=new Date(startDate); d<=endDate; d.setDate(d.getDate()+1)) arr.push(new Date(d)); return arr;
}

/* YA NO HAY FILTRO DE MESES */
function monthFilterShows(d){ return true; }

function renderGrid(){
  const dates=getDatesArray();
  const wrap=document.getElementById('gridWrap');
  const dayI=["D","L","M","X","J","V","S"];
  const monthNames=["ene.","feb.","mar.","abr.","may.","jun.","jul.","ago.","sep.","oct.","nov.","dic."];

  let html='<table><thead><tr><th class="sticky">Planta / Nombre</th>';

  dates.forEach(d=>{
    if(!monthFilterShows(d)) return;
    const ymd=dateToYMD(d);
    const today=dateToYMD(new Date());
    html+=`<th class="${ymd===today?'today-header':''}">
      <div style="font-size:11px">${dayI[d.getDay()]}</div>
      <div style="font-size:9px">${monthNames[d.getMonth()]}</div>
      <div>${("0"+d.getDate()).slice(-2)}</div>
    </th>`;
  });

  html+='</tr></thead><tbody>';

  flatPeople.forEach((p,i)=>{
    let s=p.vacacion_inicio?ymdToLocal(p.vacacion_inicio):null;
    let e=p.vacacion_fin?ymdToLocal(p.vacacion_fin):null;
    let totalVac=0;

    if(s&&e){ if(p.articulos.includes(dateToYMD(e))) e=new Date(e.setDate(e.getDate()-1)); totalVac=Math.max(0, Math.round((e-s)/86400000)+1); }

    html+=`<tr onclick="abrirPopupPersona(flatPeople[${i}])" style="cursor:pointer">
      <td class="name ${p.planta==='PLANTA HN'?'name-hn':''}">
        <div style="font-size:15px;font-weight:bold;">${p.nombre}</div>
        <div style="font-size:11px;color:#444">Legajo: ${p.legajo}<br>Vacaciones:${totalVac} días<br>Planta: ${p.planta}</div>
      </td>`;

    let count=0;
    dates.forEach(d=>{
      if(!monthFilterShows(d)) return;
      const ymd=dateToYMD(d);
      const ld=ymdToLocal(ymd);

      let isVac=(s&&e&&ld>=s&&ld<=e);
      let isArt=p.articulos.includes(ymd);
      let isLoaFrac=p.loa_frac && p.loa_frac.includes(ymd); // NUEVO: Verificar LOA Frac

      let cls="";
      if(d.getDay()===0||d.getDay()===6) cls="holiday";
      if(feriadosAR.includes(ymd)) cls="holiday";
      if(isVac){ cls="vac"; count++; }
      else if(isArt) cls="art";
      else if(isLoaFrac) cls="loa_frac"; // NUEVO: Prioridad: vacaciones > artículos > LOA Frac

      html += `<td class="${cls}">` +
          (isVac ? `<span class='vac-num'>${count}</span>` : 
          (isArt ? `<span style="font-size:9px;font-weight:bold;">art. 155</span>` : 
          (isLoaFrac ? `<span style="font-size:8px;font-weight:bold;">LOA</span>` : ""))) + // NUEVO: Etiqueta LOA
        `</td>`;
    });

    html+='</tr>';
  });

  html+='</tbody></table>';
  wrap.innerHTML=html;
}

/* ================== VISTA MÓVIL ================== */
function renderMobileView() {
  const list = document.getElementById('mobilePersonList');
  let html = '';
  
  flatPeople.forEach((p, i) => {
    let s = p.vacacion_inicio ? ymdToLocal(p.vacacion_inicio) : null;
    let e = p.vacacion_fin ? ymdToLocal(p.vacacion_fin) : null;
    let totalVac = 0;
    
    if (s && e) { 
      if (p.articulos.includes(dateToYMD(e))) e = new Date(e.setDate(e.getDate() - 1)); 
      totalVac = Math.max(0, Math.round((e - s) / 86400000) + 1); 
    }
    
    html += `
      <div class="mobile-person-card" onclick="abrirMobilePopup(flatPeople[${i}])" style="cursor: pointer;">
        <div class="mobile-person-header">
          <div class="mobile-person-name">${p.nombre}</div>
          <div class="mobile-person-planta">${p.planta}</div>
        </div>
        <div class="mobile-person-details">
          Legajo: ${p.legajo} • Vacaciones: ${totalVac} días
        </div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

function abrirMobilePopup(p) {
  // Guardar datos de la persona actual
  currentPersonData = p;
  
  // Guardar el estado actual en el historial
  history.pushState({ modalOpen: true, personIndex: flatPeople.indexOf(p) }, '');
  
  isMobilePopupOpen = true;
  
  // Actualizar el contenido del modal
  document.getElementById('mobilePopupTitle').textContent = p.nombre;
  
  let content = `
    <div style="margin-bottom: 20px;">
      <p><strong>Legajo:</strong> ${p.legajo}</p>
      <p><strong>Planta:</strong> ${p.planta}</p>
    </div>
  `;
  
  // Mostrar información de vacaciones si tiene
  if (p.vacacion_inicio && p.vacacion_fin) {
    const s = ymdToLocal(p.vacacion_inicio);
    const e = ymdToLocal(p.vacacion_fin);
    let totalVac = Math.max(0, Math.round((e - s) / 86400000) + 1);
    
    // CALCULAR DÍA DE REINGRESO (VUELVE A TRABAJAR)
    const diaReingreso = calcularDiaIngreso(e, p.articulos || [], p.loa_frac || []); // MODIFICADO: Incluir LOA Frac
    
    content += `
      <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin-top: 0;">Vacaciones</h3>
        <p><strong>Inicio:</strong> ${ymdToDMY(p.vacacion_inicio)}</p>
        <p><strong>Fin:</strong> ${ymdToDMY(p.vacacion_fin)}</p>
        <p><strong>Total:</strong> ${totalVac} días</p>
        <p style="background: #ffe08c; padding: 8px; border-radius: 4px; font-weight: bold;">
          <strong>Vuelve a trabajar:</strong> ${diaReingreso}
        </p>
      </div>
    `;
  }
  
  // Mostrar artículos si tiene
  if (p.articulos && p.articulos.length > 0) {
    content += `
      <div style="margin-bottom: 15px;">
        <h3>Artículos</h3>
        <p>${p.articulos.map(a => ymdToDMY(a)).join(", ")}</p>
      </div>
    `;
  }
  
  // NUEVO: Mostrar LOA Frac si tiene
  if (p.loa_frac && p.loa_frac.length > 0) {
    content += `
      <div style="margin-bottom: 15px;">
        <h3>LOA Fraccionada</h3>
        <p>${p.loa_frac.map(a => ymdToDMY(a)).join(", ")}</p>
      </div>
    `;
  }
  
  // AÑADIR CALENDARIOS DE MESES CON NOVEDADES
  content += '<div id="mobileCalendarContainer" style="margin-top: 20px;"></div>';
  
  document.getElementById('mobilePopupContent').innerHTML = content;
  
  // Generar y mostrar los calendarios
  mostrarCalendariosMobile(p);
  
  document.getElementById('mobilePersonPopup').style.display = 'block';
}

function cerrarMobilePopup() {
  // Volver al estado anterior en el historial
  if (isMobilePopupOpen) {
    history.back();
  } else {
    // Si por algún motivo no está abierto, solo ocultar
    cerrarMobilePopupDesdeHistorial();
  }
}

// Función para cerrar el modal desde el historial
function cerrarMobilePopupDesdeHistorial() {
  document.getElementById('mobilePersonPopup').style.display = 'none';
  isMobilePopupOpen = false;
  currentPersonData = null;
}

// Manejar el botón de retroceso del navegador/Android
window.addEventListener('popstate', function(event) {
  if (isMobilePopupOpen) {
    cerrarMobilePopupDesdeHistorial();
  }
});

// También puedes manejar la tecla Escape
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape' && isMobilePopupOpen) {
    cerrarMobilePopup();
  }
});

// Cerrar modal haciendo clic fuera del contenido
document.getElementById('mobilePersonPopup').addEventListener('click', function(event) {
  if (event.target === this) {
    cerrarMobilePopup();
  }
});

function mostrarCalendariosMobile(p) {
  const container = document.getElementById('mobileCalendarContainer');
  if (!container) return;
  
  container.innerHTML = '<h3>Calendario</h3>';
  
  // Obtener vacaciones, artículos y LOA Frac
  const vacaciones = diasVacPersona(p);
  const articulos = p.articulos || [];
  const loaFrac = p.loa_frac || []; // NUEVO: Obtener LOA Frac
  
  // Crear lista de meses con novedades (de Dic 2025 a Mar 2026)
  const meses = [
    new Date(2025, 11), // Diciembre 2025
    new Date(2026, 0),  // Enero 2026
    new Date(2026, 1),  // Febrero 2026
    new Date(2026, 2)   // Marzo 2026
  ];
  
  meses.forEach(fechaMes => {
    const y = fechaMes.getFullYear();
    const mes = fechaMes.getMonth();
    
    // Verificar si hay novedades en este mes
    let tieneNovedad = false;
    
    // Verificar vacaciones
    if (vacaciones.some(fecha => {
      const d = ymdToLocal(fecha);
      return d.getMonth() === mes && d.getFullYear() === y;
    })) {
      tieneNovedad = true;
    }
    
    // Verificar artículos
    if (articulos.some(fecha => {
      const d = ymdToLocal(fecha);
      return d.getMonth() === mes && d.getFullYear() === y;
    })) {
      tieneNovedad = true;
    }
    
    // NUEVO: Verificar LOA Frac
    if (loaFrac.some(fecha => {
      const d = ymdToLocal(fecha);
      return d.getMonth() === mes && d.getFullYear() === y;
    })) {
      tieneNovedad = true;
    }
    
    // Solo mostrar meses con novedades
    if (tieneNovedad) {
      container.appendChild(crearMesMobile(fechaMes, p));
    }
  });
  
  // Si no hay novedades en ningún mes
  if (container.children.length === 1) { // Solo tiene el <h3>
    container.innerHTML += '<p style="color: #666; font-style: italic;">No hay novedades en el período.</p>';
  }
}

function crearMesMobile(fm, p) {
  const y = fm.getFullYear();
  const mes = fm.getMonth();
  const div = document.createElement("div");
  div.className = "calMesMobile";
  div.style.cssText = `
    background: #fafafa;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #ddd;
    margin-bottom: 20px;
  `;
  
  // Obtener vacaciones, artículos y LOA Frac
  const vac = diasVacPersona(p);
  const art = p.articulos || [];
  const loa = p.loa_frac || []; // NUEVO: Obtener LOA Frac
  
  const ini = new Date(y, mes, 1);
  const fin = new Date(y, mes + 1, 0).getDate();
  
  const nombres = [
    "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
    "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
  ];
  
  let html = `<h4 style="text-align: center; margin-top: 0;">${nombres[mes]} ${y}</h4>`;
  html += `<table style="width: 100%; border-collapse: collapse; font-size: 14px;">`;
  html += `<tr>
    <th style="border: 1px solid #ccc; padding: 6px; background: #f0f0f0;">L</th>
    <th style="border: 1px solid #ccc; padding: 6px; background: #f0f0f0;">M</th>
    <th style="border: 1px solid #ccc; padding: 6px; background: #f0f0f0;">Mi</th>
    <th style="border: 1px solid #ccc; padding: 6px; background: #f0f0f0;">J</th>
    <th style="border: 1px solid #ccc; padding: 6px; background: #f0f0f0;">V</th>
    <th style="border: 1px solid #ccc; padding: 6px; background: #f0f0f0;">S</th>
    <th style="border: 1px solid #ccc; padding: 6px; background: #f0f0f0;">D</th>
  </tr><tr>`;
  
  let off = (ini.getDay() === 0 ? 6 : ini.getDay() - 1);
  for (let i = 0; i < off; i++) {
    html += `<td style="border: 1px solid #eee; padding: 6px; color: #ccc;"></td>`;
  }
  
  for (let d = 1; d <= fin; d++) {
    const fstr = `${y}-${String(mes + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
    const dow = ymdToLocal(fstr).getDay();
    
    let estilo = "border: 1px solid #eee; padding: 6px; text-align: center;";
    
    if (vac.includes(fstr)) {
      estilo += "background: #7ed47e !important; font-weight: bold;";
    } else if (art.includes(fstr)) {
      estilo += "background: #D7EEFF !important;";
    } else if (loa.includes(fstr)) { // NUEVO: LOA Frac
      estilo += "background: #ffd8b3 !important; font-weight: bold;";
    } else if (feriadosAR.includes(fstr) || dow === 0 || dow === 6) {
      estilo += "background: #ffcccc !important;";
    }
    
    html += `<td style="${estilo}">${d}</td>`;
    
    if ((off + d) % 7 === 0) {
      html += "</tr><tr>";
    }
  }
  
  html += "</tr></table>";
  
  // Leyenda actualizada
  html += `
    <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 12px; flex-wrap: wrap;">
      <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 15px; height: 15px; background: #7ed47e; border: 1px solid #5cb85c;"></div>
        <span>Vacaciones</span>
      </div>
      <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 15px; height: 15px; background: #D7EEFF; border: 1px solid #87CEEB;"></div>
        <span>Artículo</span>
      </div>
      <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 15px; height: 15px; background: #ffd8b3; border: 1px solid #e67e22;"></div>
        <span>LOA Frac</span>
      </div>
      <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 15px; height: 15px; background: #ffcccc; border: 1px solid #ff9999;"></div>
        <span>Feriado/Fin de semana</span>
      </div>
    </div>
  `;
  
  div.innerHTML = html;
  return div;
}

/* ================= POPUP PC ================= */
function abrirPopupPersona(p){
  tituloPopupPersona.innerText="Calendario de "+p.nombre;
  generarTresMeses(p);
  generarResumenPersona(p);
  calPersonaPopup.style.display="flex";
}

function cerrarPopupPersona(){ calPersonaPopup.style.display="none"; }

function generarTresMeses(p){
  mesesPersona.innerHTML="";
  const inicio=p.vacacion_inicio?ymdToLocal(p.vacacion_inicio):null;
  const fin=p.vacacion_fin?ymdToLocal(p.vacacion_fin):null;

  const meses=[new Date(2025,11),new Date(2026,0),new Date(2026,1),new Date(2026,2)];
  let mostrar=[];

  meses.forEach(m=>{
    const y = m.getFullYear(), mes = m.getMonth();
    const ini = new Date(y,mes,1), fm = new Date(y,mes+1,0);

    let ok = false;

    if(inicio && fin && !(fin < ini || inicio > fm)) ok = true;

    if(!ok){
      (p.articulos || []).forEach(a=>{
        if(!a) return;
        const d = ymdToLocal(a);
        if(isNaN(d)) return;
        if(d.getMonth()===mes && d.getFullYear()===y) ok=true;
      });
    }
    
    // NUEVO: Verificar también LOA Frac (Solo este cambio se hizo)
    if(!ok){
      (p.loa_frac || []).forEach(a=>{
        if(!a) return;
        const d = ymdToLocal(a);
        if(isNaN(d)) return;
        if(d.getMonth()===mes && d.getFullYear()===y) ok=true;
      });
    }

    if(ok) mostrar.push(m);
  });

  if(!mostrar.length) mostrar=[new Date(2026,0)];
  mostrar.forEach(m=>mesesPersona.appendChild(crearMesPersona(m,p)));
}

function crearMesPersona(fm,p){
  const y=fm.getFullYear(), mes=fm.getMonth();
  const div=document.createElement("div"); div.className="calMes3";

  const vac=diasVacPersona(p), art=p.articulos||[], loa=p.loa_frac||[]; // NUEVO: Incluir LOA Frac
  const ini=new Date(y,mes,1), fin=new Date(y,mes+1,0).getDate();

  const nombres=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  let html=`<div class='calMes'><h3>${nombres[mes]} ${y}</h3><table><tr><th>L</th><th>M</th><th>Mi</th><th>J</th><th>V</th><th>S</th><th>D</th></tr><tr>`;

  let off=(ini.getDay()===0?6:ini.getDay()-1);
  for(let i=0;i<off;i++) html+=`<td class='diaFuera'></td>`;

  for(let d=1;d<=fin;d++){
    const fstr=`${y}-${String(mes+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dow=ymdToLocal(fstr).getDay();

    let cls="";
    if(vac.includes(fstr)) cls="diaVac3";
    else if(art.includes(fstr)) cls="diaArt3";
    else if(loa.includes(fstr)) cls="diaLoaFrac3"; // NUEVO: LOA Frac
    else if(feriadosAR.includes(fstr)) cls="diaFeriado3";
    else if(dow===0||dow===6) cls="diaFeriado3";

    html+=`<td class='${cls}'>${d}</td>`;
    if((off+d)%7===0) html+="</tr><tr>";
  }

  html+="</tr></table></div>";
  div.innerHTML=html;
  return div;
}

function diasVacPersona(p){
  if(!p.vacacion_inicio||!p.vacacion_fin) return [];
  let a=[], d=ymdToLocal(p.vacacion_inicio), fin=ymdToLocal(p.vacacion_fin);
  while(d<=fin){ a.push(dateToYMD(d)); d=new Date(d.setDate(d.getDate()+1)); }
  return a;
}

function generarResumenPersona(p){
  if(!p.vacacion_inicio||!p.vacacion_fin){
    resumenPersona.innerHTML="<b>No tiene vacaciones.</b>";
    return;
  }
  const fin=ymdToLocal(p.vacacion_fin);
  const ingr=calcularDiaIngreso(fin,p.articulos,p.loa_frac); // MODIFICADO: Incluir LOA Frac
  resumenPersona.innerHTML=`<h3>Resumen</h3>
  <p><b>Primer día:</b> ${ymdToDMY(p.vacacion_inicio)}</p>
  <p><b>Último día:</b> ${ymdToDMY(p.vacacion_fin)}</p>
  <p><b>Artículos:</b> ${(p.articulos||[]).map(a=>ymdToDMY(a)).join(", ") || "Sin artículos"}</p>
  <p><b>LOA Frac:</b> ${(p.loa_frac||[]).map(a=>ymdToDMY(a)).join(", ") || "Sin LOA Frac"}</p>
  <p style='font-size:18px'><b>Ingresa a trabajar:</b> ${ingr}</p>`;
}

// MODIFICADO: Incluir LOA Frac en el cálculo del día de ingreso
function calcularDiaIngreso(finVac, art, loaFrac){
  let f=new Date(finVac); f.setDate(f.getDate()+1);
  while(true){
    const ymd=dateToYMD(f), dow=f.getDay();
    if(dow!==0&&dow!==6 && !feriadosAR.includes(ymd) && !(art||[]).includes(ymd) && !(loaFrac||[]).includes(ymd)) return ymdToDMY(ymd);
    f.setDate(f.getDate()+1);
  }
}

/* ========== MODAL NOVEDADES ========== */
function verificarNovedadesHoy(){
  const hoy=dateToYMD(new Date());
  let vac=[], art=[], loa=[], ing=[]; // NUEVO: Añadido array para LOA Frac

  flatPeople.forEach(p=>{
    if(p.vacacion_inicio===hoy) vac.push(p);
    if((p.articulos||[]).includes(hoy)) art.push(p);
    if((p.loa_frac||[]).includes(hoy)) loa.push(p); // NUEVO: Verificar LOA Frac
    if(p.vacacion_fin){
      const i=calcularDiaIngreso(ymdToLocal(p.vacacion_fin),p.articulos,p.loa_frac);
      if(i===ymdToDMY(hoy)) ing.push(p);
    }
  });

  if(!vac.length&&!art.length&&!loa.length&&!ing.length) return; // MODIFICADO: Incluir loa

  let h=`<h2>Novedades del día ${ymdToDMY(hoy)}</h2>`;
  if(art.length){ h+=`<h3>Artículos</h3><ul>`+art.map(p=>`<li>${p.nombre}</li>`).join("")+"</ul>"; }
  if(vac.length){ h+=`<h3>Comienzan vacaciones</h3><ul>`+vac.map(p=>`<li>${p.nombre}</li>`).join("")+"</ul>"; }
  if(loa.length){ h+=`<h3>LOA Fraccionada</h3><ul>`+loa.map(p=>`<li>${p.nombre}</li>`).join("")+"</ul>"; } // NUEVO: Mostrar LOA Frac
  if(ing.length){ h+=`<h3>Ingresan a trabajar</h3><ul>`+ing.map(p=>`<li>${p.nombre}</li>`).join("")+"</ul>"; }

  const modal=document.createElement("div");
  modal.id="modalNovedades";
  modal.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.65);display:flex;justify-content:center;align-items:center;z-index:999999";
  modal.innerHTML=`<div style='background:#fff;padding:20px;border-radius:12px;max-width:500px;width:90%'>${h}<button class='btn' onclick='document.getElementById("modalNovedades").remove()'>Cerrar</button></div>`;
  document.body.appendChild(modal);
}

/* EVENTOS */
filtroPlanta.onchange=()=>{ 
  buildFlatList(); 
  renderGrid(); 
  renderMobileView();
};

upload.onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=v=>{
    try{
      data=JSON.parse(v.target.result);
      normalizeData();
      buildFlatList();
      renderGrid();
      renderMobileView();
      verificarNovedadesHoy();
      alert("JSON cargado");
    }
    catch(err){
      alert("Archivo inválido");
    }
  };
  r.readAsText(f,"utf-8");
};

/* INICIO */
loadJSON();
</script>

</body>
</html>