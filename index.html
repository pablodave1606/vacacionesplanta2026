<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vacaciones - Planta</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* ====== MEJORAS DE LECTURA EN EL MODAL ====== */
.calMes { 
  background:#fafafa; 
  padding:15px; 
  border-radius:12px; 
  border:1px solid #ddd; 
}
.calMes h3 { text-align:center; font-size:20px; margin-bottom:10px; color:#333; }
.calMes3 table { border:1px solid #ccc; border-radius:8px; overflow:hidden; }
.calMes3 table th, .calMes3 table td { border:1px solid #ddd; padding:6px; }
.calMes3 table tr:nth-child(even) td { background:#fafafa; }

/* CLASES DE TIPO DE D√çA CON !important PARA QUE SOBREESCRIBAN LOS COLORES DE MES */
.diaVac3 { background:#7ed47e !important; font-weight:bold !important; }
.diaArt3 { background:#D7EEFF !important; }
.diaLoaFrac3 { background:#ffd8b3 !important; font-weight:bold !important; }
.diaFeriado3 { background:#ffcccc !important; }
.diaFuera { color:#aaa; }

/* ================== ESTILOS GENERALES ================== */
.today-header { background:#ffe08c !important; font-weight:bold; border-bottom:2px solid #d09000; }

table thead th { position:sticky; top:0; z-index:20; background:#fafafa; box-shadow:0 2px 3px rgba(0,0,0,0.15); }
#gridWrap {
  border:1px solid #ddd;
  background:#fff;
  padding:8px;
  border-radius:6px;
  height: calc(100vh - 140px);
  overflow: auto;
  position: relative;
}



table { 
  border-collapse:collapse; 
  width:100%; 
  font-size:12px; 
  position: relative;
  z-index: 2;
}
th,td { border:1px solid #eee; padding:4px; min-width:28px; text-align:center; white-space:nowrap; }
th.sticky { position:sticky; left:0; background:#fafafa; z-index:7; }
td.name { min-width:220px; text-align:left; position:sticky; left:0; background:#fff; z-index:6; }
.name-hn { background:#e8f4ff !important; }

body {
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:#f6f7fb;
  color:#1f2937;
}

/* CLASES PRINCIPALES CON !important Y MAYOR ESPECIFICIDAD */
/* A√ëADIMOS table td DELANTE PARA MAYOR ESPECIFICIDAD */
table td.vac { background:#7ed47e !important; font-weight:bold; }
table td.art { background:#D7EEFF !important; }
table td.loa_frac { background:#ffd8b3 !important; font-weight:bold; }
table td.holiday { background:#ffcccc !important; }

.legend { display:flex; gap:10px; margin-left:10px }
.btn { padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer }

/* ================== POPUP PERSONA ================== */
#calPersonaPopup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.65); display:none; justify-content:center; align-items:flex-start; padding-top:30px; z-index:99999; }
#calPersonaBox {
  background:#fff;
  padding:20px;
  border-radius:12px;
  width:95%;
  max-width:1100px;
  max-height:85vh;
  overflow-y:auto;
  box-shadow:0 0 25px rgba(0,0,0,0.35);
  margin-top:40px;
}

/* BOT√ìN VOLVER AGUANDADO */
#calPersonaBox .btn {
  position:sticky;
  top:0;
  background:#007bff;
  color: white;
  z-index:50;
  margin-bottom:15px;
  padding:12px 20px;
  font-size:16px;
  font-weight:bold;
  border:none;
  border-radius:8px;
  box-shadow:0 3px 6px rgba(0,0,0,0.2);
  transition:all 0.3s;
  width:100%;
}

#calPersonaBox .btn:hover {
  background:#0056b3;
  transform:translateY(-2px);
  box-shadow:0 5px 8px rgba(0,0,0,0.3);
}

.calMes3 {
  display:inline-block;
  width:30%;
  vertical-align:top;
  margin-bottom:20px;
  padding:5px;
}

#resumenPersona { margin-top:20px; padding:12px; border:1px solid #ccc; background:#fafafa; border-radius:6px; }

/* ================== VISTA CELULAR ================== */
#mobileView { display: none; }

.mobile-person-card {
  background: linear-gradient(180deg, #ffffff 0%, #f9fafb 100%);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  border: none;
  transition: transform .15s ease, box-shadow .15s ease;
}

.mobile-person-card:active {
  transform: scale(0.98);
}


.mobile-person-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.mobile-person-name {
  font-weight: 700;
  font-size: 16px;
  color: #111827;
}


.mobile-person-planta {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  background: linear-gradient(135deg, #e0f2ff, #cce7ff);
  color: #0056b3;
  padding: 4px 10px;
  border-radius: 999px;
}


.mobile-person-details {
  font-size: 12px;
  color: #666;
  margin-bottom: 10px;
}

/* ===== ENCABEZADO LIMPIO ===== */
.header-clean {
  background: white;
  padding: 16px;
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.06);
  margin-bottom: 16px;
}


.header-title h1 {
  font-size: 20px;
  font-weight: 800;
  letter-spacing: -0.5px;
}


.subtitle {
  margin-top:3px;
  color:#666;
  font-size:13px;
}

.header-controls {
  display:flex;
  flex-direction:column;
  gap:10px;
}

.leg-item {
  display:flex;
  align-items:center;
  gap:6px;
}

.leg-box {
  width:18px;
  height:14px;
  border:1px solid #aaa;
}

/* ================== RESPONSIVE ================== */
@media (max-width: 768px) {
  #gridWrap { display: none !important; }
  #mobileView { display: block; }
  
  .header-clean {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
  
  .header-title h1 { font-size: 18px; }
  .header-controls { width: 100%; }
  .legend { flex-wrap: wrap; gap: 8px; }
  
  .filters {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }
  
  .filters select, .filters input { width: 100%; }
  .calMes3 { width: 100% !important; }
}

/* ================ ESTILOS PARA PER√çODOS ================ */
.vacation-periods-container {
  margin: 15px 0;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #7ed47e;
}

.vacation-period {
  margin-bottom: 10px;
  padding: 8px;
  background: white;
  border-radius: 6px;
  border: 1px solid #e0e0e0;
}

.vacation-period:last-child {
  margin-bottom: 0;
}

.vacation-period-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 5px;
}

.vacation-period-title {
  font-weight: bold;
  color: #2c3e50;
}

.vacation-period-dates {
  font-size: 13px;
  color: #666;
}

.vacation-period-info {
  display: flex;
  gap: 15px;
  font-size: 12px;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.no-vacations {
  color: #666;
  font-style: italic;
  padding: 10px;
  text-align: center;
  background: #f9f9f9;
  border-radius: 6px;
}

/* ================== MODAL INGRESO M√ìVIL ================== */
#mobileIngresoPopup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.85);
  backdrop-filter: blur(10px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 100000;
  padding: 20px;
  animation: fadeIn 0.3s ease-out;
}

#mobileIngresoBox {
  background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 24px;
  width: 92%;
  max-width: 440px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  border: 1px solid rgba(226, 232, 240, 0.8);
  animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* ================= MODAL PROFESIONAL - ESTILOS ================= */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    transform: translateY(40px) scale(0.95);
    opacity: 0;
  }
  to {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

/* Encabezado del modal - SIMPLIFICADO */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24px 24px 16px;
  border-bottom: 1px solid #f1f5f9;
}

.modal-person-name {
  font-size: 24px;
  font-weight: 800;
  color: #0f172a;
  margin: 0;
  line-height: 1.3;
}

.modal-close-btn {
  background: none;
  border: none;
  font-size: 28px;
  color: #94a3b8;
  cursor: pointer;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.modal-close-btn:hover {
  background: #f1f5f9;
  color: #475569;
}

/* Tarjeta de estado - M√ÅS ENFOCADA */
.status-card {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-radius: 18px;
  padding: 30px 24px;
  margin: 0 24px 20px;
  text-align: center;
  border: 1px solid rgba(14, 165, 233, 0.2);
  position: relative;
  overflow: hidden;
}

.status-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #3b82f6, #06b6d4);
}

.status-icon {
  font-size: 52px;
  margin-bottom: 20px;
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.status-main-text {
  font-size: 28px;
  font-weight: 800;
  color: #0f172a;
  margin-bottom: 8px;
  line-height: 1.2;
}

.status-secondary-text {
  font-size: 16px;
  color: #475569;
  margin-bottom: 24px;
  font-weight: 500;
}

.status-date {
  font-size: 24px;
  font-weight: 700;
  color: #1d4ed8;
  background: rgba(255, 255, 255, 0.9);
  padding: 14px 20px;
  border-radius: 14px;
  display: inline-block;
  border: 1px solid rgba(14, 165, 233, 0.3);
  min-width: 180px;
}

/* Per√≠odo de vacaciones - M√ÅS COMPACTO */
.period-card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin: 0 24px 20px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}

.period-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.period-title {
  font-size: 12px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.period-days {
  font-size: 14px;
  font-weight: 700;
  color: white;
  background: linear-gradient(135deg, #10b981, #059669);
  padding: 4px 12px;
  border-radius: 999px;
}

.period-dates {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.period-date {
  flex: 1;
  text-align: center;
}

.date-label {
  display: block;
  font-size: 11px;
  color: #94a3b8;
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.date-value {
  display: block;
  font-size: 16px;
  font-weight: 700;
  color: #0f172a;
}

.period-divider {
  color: #cbd5e1;
  font-weight: 300;
  padding: 0 12px;
}

/* REMOVER LA SECCI√ìN DE INFORMACI√ìN ADICIONAL COMPLETAMENTE */
.additional-info {
  display: none !important;
}

/* Tarjeta de contacto - M√ÅS LIMPIA */
.contact-card {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 16px;
  padding: 20px;
  margin: 0 24px 24px;
  border: 1px solid #e2e8f0;
}

.contact-header {
  font-size: 12px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  text-align: center;
}

.contact-content {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.contact-item {
  display: flex;
  align-items: center;
  gap: 12px;
}

.contact-icon {
  font-size: 24px;
  width: 40px;
  height: 40px;
  background: white;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #e2e8f0;
}

.contact-details {
  flex: 1;
}

.contact-name {
  font-size: 14px;
  color: #475569;
  margin-bottom: 2px;
  font-weight: 600;
}

.contact-phone {
  font-size: 13px;
  color: #64748b;
}

.contact-office {
  text-align: center;
  font-size: 12px;
  color: #94a3b8;
  padding-top: 12px;
  border-top: 1px dashed #e2e8f0;
  margin-top: 8px;
}

/* Botones de acci√≥n */
.modal-actions {
  padding: 0 24px 24px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.action-btn {
  padding: 16px 24px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s ease;
  text-align: center;
}

.primary-btn {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
}

.primary-btn:hover {
  background: linear-gradient(135deg, #2563eb, #1e40af);
  transform: translateY(-2px);
  box-shadow: 0 6px 8px -1px rgba(59, 130, 246, 0.4);
}

.secondary-btn {
  background: white;
  color: #475569;
  border: 1px solid #e2e8f0;
}

.secondary-btn:hover {
  background: #f8fafc;
  border-color: #cbd5e1;
}

/* Estados espec√≠ficos */
.status-ingresa-hoy {
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  border-color: rgba(34, 197, 94, 0.2);
}

.status-ingresa-hoy::before {
  background: linear-gradient(90deg, #10b981, #22c55e);
}

.status-ingresa-futuro {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-color: rgba(14, 165, 233, 0.2);
}

.status-ya-ingreso {
  background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
  border-color: rgba(250, 204, 21, 0.2);
}

.status-ya-ingreso::before {
  background: linear-gradient(90deg, #f59e0b, #eab308);
}

.status-sin-vacaciones {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-color: rgba(100, 116, 139, 0.2);
}

.status-sin-vacaciones::before {
  background: linear-gradient(90deg, #64748b, #475569);
}

/* Scrollbar personalizado */
#mobileIngresoBox::-webkit-scrollbar {
  width: 6px;
}

#mobileIngresoBox::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 3px;
}

#mobileIngresoBox::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

#mobileIngresoBox::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* Responsive */
@media (max-width: 480px) {
  #mobileIngresoBox {
    width: 95%;
    padding: 0;
  }
  
  .modal-person-name {
    font-size: 22px;
  }
  
  .status-main-text {
    font-size: 24px;
  }
  
  .status-date {
    font-size: 20px;
    padding: 12px 16px;
  }
}

/* ========== SEPARADOR DE MESES CORREGIDO ========== */
/* La l√≠nea debe estar a la DERECHA del √∫ltimo d√≠a del mes anterior */
/* No al primer d√≠a del mes siguiente */
.mes-separator {
  border-right: 3px solid #999 !important;
}

/* Para n√∫meros de d√≠as de vacaciones */
.vac-num {
  font-weight: bold;
  font-size: 11px;
}

/* ===== LEYENDA DE COLORES EN MODAL (PC + M√ìVIL) ===== */
.leyenda-modal {
  margin: 15px 0 20px 0;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 10px;
  border: 1px solid #ddd;
}
.leyenda-modal h4 {
  margin: 0 0 10px 0;
  font-size: 15px;
  text-align: center;
  color: #333;
}
.leyenda-modal-items {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  font-size: 13px;
}
.leyenda-modal-item {
  display: flex;
  align-items: center;
  gap: 6px;
}
.leyenda-modal-box {
  width: 16px;
  height: 16px;
  border: 1px solid #888;
  border-radius: 3px;
}
/* ===== FIX MOBILE: VUELVE A TRABAJAR ===== */
@media (max-width: 768px) {

  .vacation-period-info {
    flex-direction: column;
    gap: 8px;
  }

  .vuelve-destacado {
    width: 100%;
    box-sizing: border-box;
    font-size: 14px !important;
    padding: 10px !important;
    margin: 6px 0 !important;
    text-align: center;
    white-space: normal;
  }
}
/* ===== FIX DEFINITIVO COLORES LEYENDA HEADER ===== */
.leg-box.vac {
  background: #7ed47e;
}

.leg-box.art {
  background: #D7EEFF;
}

.leg-box.loa_frac {
  background: #ffd8b3;
}

.leg-box.holiday {
  background: #ffcccc;
}

/* ===== FILTRO POR PUESTO ===== */
.filters {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.filters select {
  min-width: 120px;
}

.puesto-filter-container {
  display: flex;
  align-items: center;
  gap: 5px;
}

/* ========== ESTILOS PARA INFORMACI√ìN DE CONTACTO ========== */
.contacto-info {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(255, 255, 255, 0.92);
  padding: 10px 15px;
  border-radius: 8px;
  border: 1px solid #007bff;
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
  font-size: 11px;
  color: #333;
  z-index: 100;
  max-width: 280px;
  backdrop-filter: blur(5px);
}

.contacto-info strong {
  color: #0056b3;
  display: block;
  margin-bottom: 4px;
  font-size: 12px;
}

.contacto-info a {
  color: #007bff;
  text-decoration: none;
  font-weight: bold;
}

.contacto-info a:hover {
  text-decoration: underline;
}

.contacto-title {
  font-weight: bold;
  color: #0056b3;
  border-bottom: 1px solid #007bff;
  padding-bottom: 4px;
  margin-bottom: 6px;
  font-size: 12px;
}

/* Contacto en modal persona */
.contacto-modal {
  margin: 15px 0 10px 0;
  padding: 12px;
  background: #f0f8ff;
  border-radius: 8px;
  border-left: 4px solid #007bff;
  font-size: 12px;
  color: #333;
}

/* Responsive para contacto */
@media (max-width: 768px) {
  .contacto-info {
    position: static;
    margin: 15px auto;
    max-width: 90%;
    text-align: center;
  }
}

/* ========== MESES CON COLORES EN GRILLA PC ========== */
/* COLORES DE MES SIN !important Y MENOS OPACIDAD */
.mes-diciembre { background-color: rgba(255, 248, 225, 0.15); }
.mes-enero { background-color: rgba(225, 245, 254, 0.15); }
.mes-febrero { background-color: rgba(255, 242, 240, 0.15); }
.mes-marzo { background-color: rgba(240, 255, 240, 0.15); }

.mes-header {
  position: relative;
  font-weight: bold;
  color: #333;
}

.mes-header::after {
  content: attr(data-mes);
  position: absolute;
  bottom: -15px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 10px;
  color: #666;
  white-space: nowrap;
}

/* Estilo destacado para "Vuelve a trabajar" en modal PC */
.vuelve-destacado {
  background: linear-gradient(135deg, #e1f5e1 0%, #c8e6c9 100%) !important;
  border-left: 5px solid #27ae60 !important;
  border-radius: 8px;
  padding: 15px !important;
  margin: 10px 0;
  font-weight: bold;
  font-size: 16px !important;
  color: #1e8449 !important;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
}

/* ===== MARCA DE AGUA GLOBAL ===== */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: url('watermark.png');
  background-repeat: no-repeat;
  background-position: center center;
  background-size: 320px;
  opacity: 0.06;
  pointer-events: none;
  z-index: 0;
}
body > * {
  position: relative;
  z-index: 1;
}

/* ===== LIMPIAR PANTALLA PRINCIPAL EN CELULAR ===== */
@media (max-width: 768px) {

  /* Oculta leyendas y cuadritos en vista m√≥vil */
  .leyenda,
  .leyenda-colores,
  .legend,
  .legend-box,
  .leyenda-mobile,
  .leyenda-modal {
    display: none !important;
  }

}

/* ===== TITULO PRINCIPAL PRO ===== */
h1 {
  text-align: center;
  font-weight: 900;
  letter-spacing: -0.6px;
  color: #0f172a;
  margin: 14px 0 8px;
  font-size: 30px; /* PC */
}

/* Subt√≠tulo (fecha) */
.subtitle {
  text-align: center;
  font-size: 14px;
  color: #64748b;
  margin-bottom: 18px;
}

/* Versi√≥n m√≥vil */
@media (max-width: 768px) {
  h1 {
    font-size: 24px;   /* antes 22 ‚Üí ahora 24 */
    line-height: 1.2;
  }

  .subtitle {
    font-size: 13px;
  }
}
h1::after {
  content: "";
  display: block;
  width: 70px;
  height: 4px;
  margin: 12px auto 0;
  border-radius: 999px;
  background: linear-gradient(90deg, #22c55e, #3b82f6);
}

/* ========== ESTILOS PARA ETIQUETAS EN CALENDARIO MODAL ========== */
/* Estilos para las etiquetas en los d√≠as del calendario (modal persona) */
.calMes3 td {
  position: relative;
  height: 40px;
}

.calMes3 td > div:first-child {
  font-size: 14px;
  font-weight: bold;
}

.calMes3 .diaArt3 > div:nth-child(2),
.calMes3 .diaLoaFrac3 > div:nth-child(2) {
  font-size: 8px;
  font-weight: bold;
  color: #333;
  margin-top: 1px;
  line-height: 1;
}

/* Para m√≥viles - ajustar tama√±o */
@media (max-width: 768px) {
  .calMes3 td {
    height: 35px;
    padding: 2px !important;
  }
  
  .calMes3 td > div:first-child {
    font-size: 13px;
  }
  
  .calMes3 .diaArt3 > div:nth-child(2),
  .calMes3 .diaLoaFrac3 > div:nth-child(2) {
    font-size: 7px;
  }
}
/* ===== FONDO PARA VISTA M√ìVIL ===== */
@media (max-width: 768px) {
  #mobileView {
    position: relative;
    background-image: url('chango.jpg');
    background-size: cover;
    background-position: center 50px;
    background-attachment: fixed;
    background-repeat: no-repeat;
    min-height: 100vh;
  }
  
  #mobileView::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.7); /* Capa blanca semi-transparente para mejor legibilidad */
    z-index: 0;
  }
  
  #mobilePersonList {
    position: relative;
    z-index: 1; /* Asegura que las tarjetas est√©n sobre el fondo */
  }
  
  .mobile-person-card {
    background: rgba(255, 255, 255, 0.85); /* Fondo semi-transparente para mejor legibilidad */
    backdrop-filter: blur(5px); /* Efecto de desenfoque para mayor legibilidad */
  }
  
  /* Ajustar la marca de agua existente para m√≥vil */
  body::before {
    background-image: none; /* Ocultar marca de agua en m√≥vil si es muy intrusiva */
  }
}
</style>
</head>

<body>

<!-- CONTACTO FIJO EN ESQUINA -->
<div class="contacto-info">
  <div class="contacto-title">INFORMACI√ìN DE CONTACTO</div>
  <strong>Oficina H0</strong>
  Aux. T√©cnico: <strong>Daverio Pablo</strong><br>
  Ante consultas comunicarse al:<br>
  üìû 155/255 | üì± Cel: 3534112506
</div>

<!-- POPUP PERSONA -->
<div id="calPersonaPopup">
  <div id="calPersonaBox">
    <button onclick="cerrarPopupPersona()" class="btn">Volver</button>
    
<h2 id="tituloPopupPersona"></h2>

<!-- CONTACTO EN MODAL PERSONA -->
<div class="contacto-modal">
  <strong>Oficina H0</strong> | Aux. T√©cnico: <strong>Daverio Pablo</strong><br>
  üìû 155/255 | üì± Cel: 3534112506
</div>

<!-- LEYENDA DE COLORES -->
<div class="leyenda-modal">
  <h4>Leyenda de colores</h4>
  <div class="leyenda-modal-items">
    <div class="leyenda-modal-item">
      <div class="leyenda-modal-box" style="background:#7ed47e;"></div>
      <span>Vacaciones</span>
    </div>
    <div class="leyenda-modal-item">
      <div class="leyenda-modal-box" style="background:#D7EEFF;"></div>
      <span>Art√≠culos</span>
    </div>
    <div class="leyenda-modal-item">
      <div class="leyenda-modal-box" style="background:#ffd8b3;"></div>
      <span>LOA Frac</span>
    </div>
    <div class="leyenda-modal-item">
      <div class="leyenda-modal-box" style="background:#ffcccc;"></div>
      <span>Feriados / Findes</span>
    </div>
  </div>
</div>

    <div id="mesesPersona"></div>
    <div id="resumenPersona"></div>
  </div>
</div>

<!-- POPUP INGRESO M√ìVIL - VERSI√ìN SIMPLIFICADA -->
<div id="mobileIngresoPopup">
  <div id="mobileIngresoBox">
    <!-- Encabezado limpio y simple -->
    <div class="modal-header">
      <h2 id="mobileIngresoTitulo" class="modal-person-name"></h2>
      <button class="modal-close-btn" onclick="cerrarMobileIngreso()">√ó</button>
    </div>

    <!-- Tarjeta de estado principal - ENFOCADA -->
    <div id="mobileIngresoInfo" class="status-card">
      <div class="status-icon" id="mobileIngresoIcon"></div>
      <div class="status-main-text" id="mobileIngresoMainText"></div>
      <div class="status-secondary-text" id="mobileIngresoSecondaryText"></div>
      <div class="status-date" id="mobileIngresoDate"></div>
    </div>

    <!-- Per√≠odo de vacaciones (solo si existe) -->
    <div id="mobilePeriodInfo" class="period-card">
      <div class="period-header">
        <span class="period-title">PER√çODO DE VACACIONES</span>
        <span class="period-days" id="mobilePeriodDays"></span>
      </div>
      <div class="period-dates">
        <div class="period-date">
          <span class="date-label">Inicio</span>
          <span class="date-value" id="mobilePeriodStart"></span>
        </div>
        <div class="period-divider">‚Üí</div>
        <div class="period-date">
          <span class="date-label">Fin</span>
          <span class="date-value" id="mobilePeriodEnd"></span>
        </div>
      </div>
    </div>

    <!-- Contacto (solo cuando es relevante) -->
    <div id="mobileContactInfo" class="contact-card">
      <div class="contact-header">CONSULTAS</div>
      <div class="contact-content">
        <div class="contact-item">
          <div class="contact-icon">üë®‚Äçüíº</div>
          <div class="contact-details">
            <div class="contact-name">Aux. T√©cnico: <strong>Daverio Pablo</strong></div>
            <div class="contact-phone">üìû 155/255 | üì± 3534112506</div>
          </div>
        </div>
        <div class="contact-office">Oficina H0</div>
      </div>
    </div>

    <!-- Bot√≥n de acci√≥n -->
    <div class="modal-actions">
      <button id="mobileIngresoBtn" class="action-btn primary-btn" onclick="cerrarMobileIngreso()">
        Ver calendario completo
      </button>
      <button class="action-btn secondary-btn" onclick="cerrarMobileIngreso()">
        Cerrar
      </button>
    </div>
  </div>
</div>

<header class="header-clean">
  <div class="header-title">
    <h1> CENTRO DE EXPLOSIVOS - VACACIONES Y ART√çCULOS</h1>
    <div class="subtitle">Dic 2025 ‚Äì Mar 2026</div>
  </div>

  <div class="header-controls">
    <div class="legend">
      <span class="leg-item"><div class="leg-box vac"></div> Vacaciones</span>
      <span class="leg-item"><div class="leg-box art"></div> Art√≠culos</span>
      <span class="leg-item"><div class="leg-box loa_frac"></div> LOA Frac</span>
      <span class="leg-item"><div class="leg-box holiday"></div> Feriados / Findes</span>
    </div>

    <div class="filters">
      Personal:
      <select id="filtroPlanta" class="btn">
        <option value="TODOS">Todos</option>
        <option value="PLANTA I">Planta I</option>
        <option value="PLANTA HN">Planta HN</option>
      </select>

      <div class="puesto-filter-container">
        Puesto:
        <select id="filtroPuesto" class="btn">
          <option value="TODOS">Todos los puestos</option>
        </select>
      </div>

      <input type="file" id="upload" accept=".json" class="btn">
    </div>
  </div>
</header>

<!-- VISTA PC -->
<div id="gridWrap"></div>

<!-- VISTA M√ìVIL -->
<div id="mobileView">
  <div id="mobilePersonList"></div>
</div>

<script>
/* ================= CONFIG =================== */
const jsonPath = "vacaciones.json";
const startDate = new Date(2025,11,1);
const endDate   = new Date(2026,2,31);

let data = {};
let flatPeople = [];

const feriadosAR = [
  "2025-12-08","2025-12-24","2025-12-25","2025-12-31",
  "2026-01-01","2026-02-16","2026-02-17",
  "2026-03-24","2026-03-29","2026-03-30"
];

// Colores de fondo para cada mes en la grilla
const coloresMeses = {
  11: 'mes-diciembre',  // Diciembre
  0: 'mes-enero',      // Enero
  1: 'mes-febrero',    // Febrero
  2: 'mes-marzo'       // Marzo
};

// Nombres de meses para la grilla
const nombresMesesGrilla = {
  11: 'DIC',
  0: 'ENE',
  1: 'FEB',
  2: 'MAR'
};

// Variable global para controlar si hay modales abiertos
let modalAbierto = false;

// Interceptar el evento de bot√≥n "atr√°s" en Android - VERSI√ìN MEJORADA
window.addEventListener('popstate', function(event) {
  if (modalAbierto) {
    // Prevenir que se cierre la p√°gina
    event.preventDefault();
    event.stopPropagation();
    
    // Agregar una nueva entrada al historial para mantener al usuario en la misma p√°gina
    history.pushState(null, null, window.location.pathname);
    
    // Cerrar el modal que est√© visible seg√∫n su orden de prioridad
    const ingresoPopup = document.getElementById('mobileIngresoPopup');
    const calPersonaPopup = document.getElementById('calPersonaPopup');
    const modalNovedades = document.getElementById('modalNovedades');
    
    if (ingresoPopup && ingresoPopup.style.display === 'flex') {
      cerrarMobileIngreso();
    } else if (calPersonaPopup && calPersonaPopup.style.display === 'flex') {
      cerrarPopupPersona();
    } else if (modalNovedades) {
      modalNovedades.remove();
      modalAbierto = false;
    }
  }
});

// Agregar una entrada inicial al historial para poder manejarlo
history.pushState({ modal: false }, '');

function dateToYMD(d){ const mm=("0"+(d.getMonth()+1)).slice(-2); const dd=("0"+d.getDate()).slice(-2); return d.getFullYear()+"-"+mm+"-"+dd; }
function ymdToLocal(s){ const [y,m,d]=s.split("-"); return new Date(y,m-1,d); }
function ymdToDMY(s){ if(!s) return ""; const [y,m,d]=s.split("-"); return `${d}/${m}/${y}`; }

// Funci√≥n para obtener todos los d√≠as de vacaciones de una persona (m√∫ltiples per√≠odos)
function getDiasVacPersona(p) {
  const dias = [];
  if (p.vacaciones && p.vacaciones.length > 0) {
    p.vacaciones.forEach(periodo => {
      if (periodo.inicio && periodo.fin) {
        let d = ymdToLocal(periodo.inicio);
        const fin = ymdToLocal(periodo.fin);
        while (d <= fin) {
          dias.push(dateToYMD(d));
          d = new Date(d.setDate(d.getDate() + 1));
        }
      }
    });
  }
  return dias;
}

// Funci√≥n para obtener el total de d√≠as de vacaciones
function getTotalDiasVac(p) {
  let total = 0;
  if (p.vacaciones && p.vacaciones.length > 0) {
    p.vacaciones.forEach(periodo => {
      if (periodo.inicio && periodo.fin) {
        const inicio = ymdToLocal(periodo.inicio);
        const fin = ymdToLocal(periodo.fin);
        const dias = Math.round((fin - inicio) / 86400000) + 1;
        total += dias;
      }
    });
  }
  return total;
}

function normalizeData(){
  Object.keys(data).forEach(pl => {
    let newPl = pl.toUpperCase().replace("_"," ");
    if(newPl==="I") newPl="PLANTA I";
    if(newPl==="HN") newPl="PLANTA HN";
    if(newPl!==pl){ data[newPl]=data[pl]; delete data[pl]; pl=newPl; }

    data[pl]=data[pl].map(p=>{
      // Compatibilidad con versi√≥n anterior
      if (!p.vacaciones) {
        p.vacaciones = [];
        if (p.vacacion_inicio && p.vacacion_fin) {
          p.vacaciones.push({
            inicio: p.vacacion_inicio,
            fin: p.vacacion_fin
          });
        }
        // Eliminar campos antiguos
        delete p.vacacion_inicio;
        delete p.vacacion_fin;
      }
      
      // Inicializar puestos si no existen
      if (!p.puestos) {
        p.puestos = [];
      }
      
      // Normalizar puestos si vienen como strings
      if(typeof p.puestos==="string"){
        p.puestos=p.puestos.replace(/;/g,",").split(",").map(a=>a.trim()).filter(a=>a.length>0);
      }
      
      if(!p.articulos) p.articulos=[];
      if(!p.loa_frac) p.loa_frac=[];
      
      // Normalizar arrays si vienen como strings
      if(typeof p.articulos==="string"){
        p.articulos=p.articulos.replace(/;/g,",").split(",").map(a=>{
          a=a.trim();
          if(a.includes("/")){
            const [d,m,y]=a.split("/");
            return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
          }
          return a;
        }).filter(a=>a.length>0);
      }
      
      if(typeof p.loa_frac==="string"){
        p.loa_frac=p.loa_frac.replace(/;/g,",").split(",").map(a=>{
          a=a.trim();
          if(a.includes("/")){
            const [d,m,y]=a.split("/");
            return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
          }
          return a;
        }).filter(a=>a.length>0);
      }
      
      return p;
    });
  });
}

// Funci√≥n para obtener todos los puestos √∫nicos de una planta
function obtenerTodosLosPuestos(planta) {
  const puestosSet = new Set();
  
  if (planta === "TODOS") {
    // Obtener puestos de todas las plantas
    Object.keys(data).forEach(pl => {
      data[pl].forEach(persona => {
        if (persona.puestos && persona.puestos.length > 0) {
          persona.puestos.forEach(puesto => {
            puestosSet.add(puesto.trim());
          });
        }
      });
    });
  } else if (data[planta]) {
    // Obtener puestos de una planta espec√≠fica
    data[planta].forEach(persona => {
      if (persona.puestos && persona.puestos.length > 0) {
        persona.puestos.forEach(puesto => {
          puestosSet.add(puesto.trim());
        });
      }
    });
  }
  
  // Convertir a array y ordenar alfab√©ticamente
  return Array.from(puestosSet).sort((a, b) => a.localeCompare(b));
}

// Funci√≥n para cargar puestos en el filtro
function cargarPuestosEnFiltro(plantaSeleccionada) {
  const filtroPuesto = document.getElementById('filtroPuesto');
  const puestos = obtenerTodosLosPuestos(plantaSeleccionada);
  
  // Guardar el valor actual
  const valorActual = filtroPuesto.value;
  
  // Limpiar opciones (excepto la primera)
  filtroPuesto.innerHTML = '<option value="TODOS">Todos los puestos</option>';
  
  // Agregar opciones de puestos
  puestos.forEach(puesto => {
    const option = document.createElement('option');
    option.value = puesto;
    option.textContent = puesto;
    filtroPuesto.appendChild(option);
  });
  
  // Restaurar valor si existe
  if (puestos.includes(valorActual)) {
    filtroPuesto.value = valorActual;
  } else {
    filtroPuesto.value = "TODOS";
  }
  
  // Habilitar/deshabilitar seg√∫n la selecci√≥n de planta
  if (plantaSeleccionada === "TODOS") {
    filtroPuesto.disabled = true;
  } else {
    filtroPuesto.disabled = false;
  }
}

async function loadJSON(){
  try{
    const r = await fetch(jsonPath+"?nocache="+Math.random());
    data = await r.json();
  }catch(e){ data={}; }

  normalizeData();
  cargarPuestosEnFiltro("TODOS");
  buildFlatList();
  renderGrid();
  renderMobileView();
  verificarNovedadesHoy();
}

function buildFlatList(){
  const plantaFiltro = document.getElementById('filtroPlanta').value;
  const puestoFiltro = document.getElementById('filtroPuesto').value;
  
  flatPeople=[];
  
  Object.keys(data).forEach(pl=>{
    if(plantaFiltro !== "TODOS" && plantaFiltro !== pl) return;
    
    data[pl].forEach(p=>{
      // Filtrar por puesto si se ha seleccionado uno espec√≠fico
      if (puestoFiltro !== "TODOS") {
        if (!p.puestos || !p.puestos.includes(puestoFiltro)) {
          return; // Saltar esta persona si no tiene el puesto seleccionado
        }
      }
      
      flatPeople.push({planta:pl, ...p});
    });
  });
  
  flatPeople.sort((a,b)=> a.planta.localeCompare(b.planta) || a.nombre.localeCompare(b.nombre));
}

function filtrarPorPlantaYPuesto() {
  buildFlatList();
  renderGrid();
  renderMobileView();
}

function getDatesArray(){
  let arr=[]; 
  let d = new Date(startDate);
  while(d <= endDate){
    arr.push(new Date(d));
    d.setDate(d.getDate() + 1);
  }
  return arr;
}

function renderGrid(){
  const dates=getDatesArray();
  const wrap=document.getElementById('gridWrap');
  const dayI=["D","L","M","X","J","V","S"];
  const monthNames=["ene.","feb.","mar.","abr.","may.","jun.","jul.","ago.","sep.","oct.","nov.","dic."];

  let html='<table><thead><tr><th class="sticky">Planta / Nombre</th>';

  let mesAnterior = null;
  let mesActual = null;
  
  dates.forEach((d, index)=>{
    const ymd=dateToYMD(d);
    const today=dateToYMD(new Date());
    
    // Verificar si cambi√≥ de mes
    const mes = d.getMonth();
    let claseMes = coloresMeses[mes] || '';
    
    // Verificar si es el PRIMER d√≠a del mes
    let esPrimerDiaMes = mesActual !== mes;
    mesActual = mes;
    
    // Determinar si poner separador: NO en el primer d√≠a del mes siguiente
    // SINO en el √öLTIMO d√≠a del mes anterior
    let claseSeparador = '';
    
    // Necesitamos saber cu√°l es el mes anterior
    if (mesAnterior !== null && mesAnterior !== mes) {
      // Estamos en el primer d√≠a de un nuevo mes
      // La l√≠nea debe estar en el d√≠a ANTERIOR (√∫ltimo del mes anterior)
      // NO en este d√≠a
    }
    mesAnterior = mes;
    
    // Obtener el nombre del mes para mostrar en el header
    const nombreMes = nombresMesesGrilla[mes] || '';
    
    html+=`<th class="${ymd===today?'today-header':''} ${claseMes} ${claseSeparador}" data-mes="${nombreMes}">
      <div style="font-size:11px">${dayI[d.getDay()]}</div>
      <div style="font-size:9px">${monthNames[d.getMonth()]}</div>
      <div>${("0"+d.getDate()).slice(-2)}</div>
    </th>`;
  });

  html+='</tr></thead><tbody>';

  flatPeople.forEach((p,i)=>{
    const totalVac = getTotalDiasVac(p);
    const diasVac = getDiasVacPersona(p);
    const art = p.articulos || [];
    const loa = p.loa_frac || [];
    const puestos = p.puestos || [];

    html+=`<tr onclick="abrirPopupPersona(flatPeople[${i}])" style="cursor:pointer">
      <td class="name ${p.planta==='PLANTA HN'?'name-hn':''}">
        <div style="font-size:15px;font-weight:bold;">${p.nombre}</div>
        <div style="font-size:11px;color:#444">
          Legajo: ${p.legajo}<br>
          ${puestos.length > 0 ? `Puesto${puestos.length > 1 ? 's' : ''}: ${puestos.join(', ')}<br>` : ''}
          Vacaciones: ${totalVac} d√≠as (${p.vacaciones ? p.vacaciones.length : 0} per√≠odo${p.vacaciones && p.vacaciones.length !== 1 ? 's' : ''})<br>
          Planta: ${p.planta}
        </div>
      </td>`;

    let count=0;
    let mesAnteriorFila = null;
    
    dates.forEach((d, index)=>{
      const ymd=dateToYMD(d);

      let isVac = diasVac.includes(ymd);
      let isArt = art.includes(ymd);
      let isLoaFrac = loa.includes(ymd);

      let cls="";
      if(d.getDay()===0||d.getDay()===6) cls="holiday";
      if(feriadosAR.includes(ymd)) cls="holiday";
      if(isVac){ cls="vac"; count++; }
      else if(isArt) cls="art";
      else if(isLoaFrac) cls="loa_frac";
      
      // Agregar color de fondo seg√∫n el mes
      const mes = d.getMonth();
      const claseMesFondo = coloresMeses[mes] || '';
      
      // ========== CORRECCI√ìN: SEPARADOR EN EL √öLTIMO D√çA DEL MES ANTERIOR ==========
      let claseSeparadorFila = '';
      
      // Verificar si estamos en el primer d√≠a de un nuevo mes (excepto diciembre)
      if (mesAnteriorFila !== null && mesAnteriorFila !== mes && mes !== 11) {
        // La l√≠nea debe estar en el d√≠a ANTERIOR (√∫ltimo del mes anterior)
        // Para esto necesitamos modificar la celda ANTERIOR, no la actual
        // Esto es complicado de hacer aqu√≠, mejor lo hacemos diferente...
      }
      
      // En su lugar, verificamos si el D√çA SIGUIENTE es de un mes diferente
      if (index < dates.length - 1) {
        const siguienteDia = dates[index + 1];
        const mesSiguiente = siguienteDia.getMonth();
        if (mes !== mesSiguiente) {
          // Ma√±ana es de un mes diferente, poner separador en ESTA celda (√∫ltima del mes actual)
          claseSeparadorFila = 'mes-separator';
        }
      }
      
      mesAnteriorFila = mes;

      let contenido = "";
      if (isVac) {
        contenido = `<span class='vac-num'>${count}</span>`;
      } else if (isArt) {
        contenido = `<span style="font-size:9px;font-weight:bold;">art</span>`;
      } else if (isLoaFrac) {
        contenido = `<span style="font-size:8px;font-weight:bold;">LOA</span>`;
      }

      // IMPORTANTE: Las clases de tipo de d√≠a (cls) van PRIMERO para prioridad
      // Las clases de tipo de d√≠a tienen mayor especificidad en CSS (table td.clase)
      html += `<td class="${cls} ${claseMesFondo} ${claseSeparadorFila}">${contenido}</td>`;
    });

    html+='</tr>';
  });

  html+='</tbody></table>';
  wrap.innerHTML=html;
}

/* ================= VISTA M√ìVIL ================== */
function renderMobileView() {
  const list = document.getElementById('mobilePersonList');
  let html = '';
  
  flatPeople.forEach((p, i) => {
    const totalVac = getTotalDiasVac(p);
    const numPeriodos = p.vacaciones ? p.vacaciones.length : 0;
    const puestos = p.puestos || [];
    
    html += `
      <div class="mobile-person-card" onclick="mostrarIngresoMobile(flatPeople[${i}])" style="cursor: pointer;">
        <div class="mobile-person-header">
          <div class="mobile-person-name">${p.nombre}</div>
          <div class="mobile-person-planta">${p.planta}</div>
        </div>
        <div class="mobile-person-details">
          Legajo: ${p.legajo}<br>
          ${puestos.length > 0 ? `Puesto${puestos.length > 1 ? 's' : ''}: ${puestos.join(', ')}<br>` : ''}
          Vacaciones: ${totalVac} d√≠as (${numPeriodos} per√≠odo${numPeriodos !== 1 ? 's' : ''})
        </div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

/* ================= MODAL INGRESO M√ìVIL - SIMPLIFICADO ================= */
let personaSeleccionadaMobile = null;

function mostrarIngresoMobile(p) {
  personaSeleccionadaMobile = p;
  modalAbierto = true;
  
  // Agregar entrada al historial
  history.pushState({ modal: true }, '');
  
  // Configurar informaci√≥n b√°sica - SOLO EL NOMBRE
  document.getElementById('mobileIngresoTitulo').textContent = p.nombre;
  
  // Buscar la pr√≥xima fecha de ingreso
  let ingresoFecha = null;
  let periodoSeleccionado = null;
  
  if (p.vacaciones && p.vacaciones.length > 0) {
    const hoy = new Date();
    const hoyYMD = dateToYMD(hoy);
    
    // Buscar si hoy est√° en un per√≠odo de vacaciones
    const diasVac = getDiasVacPersona(p);
    
    if (diasVac.includes(hoyYMD)) {
      // Hoy est√° de vacaciones, buscar cu√°ndo termina
      p.vacaciones.forEach(periodo => {
        if (periodo.inicio && periodo.fin) {
          const inicio = ymdToLocal(periodo.inicio);
          const fin = ymdToLocal(periodo.fin);
          const hoyDate = ymdToLocal(hoyYMD);
          
          if (hoyDate >= inicio && hoyDate <= fin) {
            periodoSeleccionado = periodo;
            ingresoFecha = calcularDiaReingreso(fin, p.articulos || [], p.loa_frac || []);
          }
        }
      });
    } else {
      // Buscar el pr√≥ximo reingreso
      p.vacaciones.forEach(periodo => {
        if (periodo.fin) {
          const finDate = ymdToLocal(periodo.fin);
          const reingreso = calcularDiaReingreso(finDate, p.articulos || [], p.loa_frac || []);
          const reingresoDate = ymdToLocal(reingreso);
          
          if (reingresoDate >= hoy) {
            if (!ingresoFecha || reingresoDate < ymdToLocal(ingresoFecha)) {
              ingresoFecha = reingreso;
              periodoSeleccionado = periodo;
            }
          }
        }
      });
    }
  }
  
  // Configurar el estado visual
  const statusCard = document.getElementById('mobileIngresoInfo');
  const statusIcon = document.getElementById('mobileIngresoIcon');
  const mainText = document.getElementById('mobileIngresoMainText');
  const secondaryText = document.getElementById('mobileIngresoSecondaryText');
  const statusDate = document.getElementById('mobileIngresoDate');
  const periodCard = document.getElementById('mobilePeriodInfo');
  const contactCard = document.getElementById('mobileContactInfo');
  
  if (ingresoFecha) {
    const hoyYMD = dateToYMD(new Date());
    const ingresoDate = ymdToLocal(ingresoFecha);
    const hoyDate = ymdToLocal(hoyYMD);
    const diffDias = Math.round((ingresoDate - hoyDate) / 86400000);
    
    if (ingresoFecha === hoyYMD) {
      // Ingresa hoy
      statusCard.className = 'status-card status-ingresa-hoy';
      statusIcon.innerHTML = 'üè¢';
      mainText.textContent = 'INGRESA HOY';
      secondaryText.textContent = 'A trabajar';
      statusDate.textContent = ymdToDMY(ingresoFecha);
    } else if (ingresoDate < hoyDate) {
      // Ya ingres√≥
      statusCard.className = 'status-card status-ya-ingreso';
      statusIcon.innerHTML = '‚úÖ';
      mainText.textContent = 'YA INGRES√ì';
      secondaryText.textContent = 'A trabajar';
      statusDate.textContent = ymdToDMY(ingresoFecha);
    } else {
      // Ingresa en el futuro
      statusCard.className = 'status-card status-ingresa-futuro';
      statusIcon.innerHTML = 'üìÖ';
      mainText.textContent = `INGRESA EN ${diffDias} D√çA${diffDias !== 1 ? 'S' : ''}`;
      secondaryText.textContent = 'Fecha de reingreso';
      statusDate.textContent = ymdToDMY(ingresoFecha);
    }
    
    // Mostrar informaci√≥n del per√≠odo si existe
    if (periodoSeleccionado) {
      const inicioDate = ymdToLocal(periodoSeleccionado.inicio);
      const finDate = ymdToLocal(periodoSeleccionado.fin);
      const diasPeriodo = Math.round((finDate - inicioDate) / 86400000) + 1;
      
      document.getElementById('mobilePeriodDays').textContent = `${diasPeriodo} d√≠as`;
      document.getElementById('mobilePeriodStart').textContent = ymdToDMY(periodoSeleccionado.inicio);
      document.getElementById('mobilePeriodEnd').textContent = ymdToDMY(periodoSeleccionado.fin);
      periodCard.style.display = 'block';
    } else {
      periodCard.style.display = 'none';
    }
    
    // Mostrar contacto si est√° por ingresar o ya ingres√≥
    contactCard.style.display = 'block';
  } else {
    // No tiene vacaciones programadas
    statusCard.className = 'status-card status-sin-vacaciones';
    statusIcon.innerHTML = 'üìã';
    mainText.textContent = 'SIN VACACIONES';
    secondaryText.textContent = 'Programadas';
    statusDate.textContent = '‚Äî';
    periodCard.style.display = 'none';
    contactCard.style.display = 'block'; // Mostrar contacto igualmente
  }
  
  // Mostrar el modal
  document.getElementById('mobileIngresoPopup').style.display = 'flex';
}

function cerrarMobileIngreso() {
  modalAbierto = false;
  document.getElementById('mobileIngresoPopup').style.display = 'none';
  
  // Regresar en el historial
  history.back();
  
  setTimeout(() => {
    if (personaSeleccionadaMobile) {
      abrirPopupPersona(personaSeleccionadaMobile);
      personaSeleccionadaMobile = null;
    }
  }, 300);
}

// Tambi√©n permitir cerrar haciendo clic fuera del modal
document.getElementById('mobileIngresoPopup').addEventListener('click', function(e) {
  if (e.target.id === 'mobileIngresoPopup') {
    cerrarMobileIngreso();
  }
});

/* ================= POPUP PERSONA ================= */
function abrirPopupPersona(p){
  modalAbierto = true;
  
  // Agregar entrada al historial
  history.pushState({ modal: true }, '');
  
  document.getElementById('tituloPopupPersona').innerText = `Calendario de ${p.nombre}`;
  generarTresMeses(p);
  generarResumenPersona(p);
  document.getElementById('calPersonaPopup').style.display = "flex";
}

function cerrarPopupPersona(){ 
  modalAbierto = false;
  document.getElementById('calPersonaPopup').style.display = "none"; 
  
  // Regresar en el historial
  history.back();
}

function generarTresMeses(p){
  document.getElementById('mesesPersona').innerHTML = "";
  
  const meses = [new Date(2025,11), new Date(2026,0), new Date(2026,1), new Date(2026,2)];
  let mostrar = [];

  meses.forEach(m => {
    const y = m.getFullYear(), mes = m.getMonth();
    const ini = new Date(y, mes, 1), fm = new Date(y, mes + 1, 0);

    let ok = false;

    // Verificar si hay vacaciones en este mes
    if (p.vacaciones && p.vacaciones.length > 0) {
      p.vacaciones.forEach(periodo => {
        if (periodo.inicio && periodo.fin) {
          const inicio = ymdToLocal(periodo.inicio);
          const fin = ymdToLocal(periodo.fin);
          if (!(fin < ini || inicio > fm)) ok = true;
        }
      });
    }

    // Verificar art√≠culos
    if (!ok && p.articulos && p.articulos.length > 0) {
      p.articulos.forEach(a => {
        if(!a) return;
        const d = ymdToLocal(a);
        if(isNaN(d)) return;
        if(d.getMonth() === mes && d.getFullYear() === y) ok = true;
      });
    }

    // Verificar LOA Frac
    if (!ok && p.loa_frac && p.loa_frac.length > 0) {
      p.loa_frac.forEach(a => {
        if(!a) return;
        const d = ymdToLocal(a);
        if(isNaN(d)) return;
        if(d.getMonth() === mes && d.getFullYear() === y) ok = true;
      });
    }

    if(ok) mostrar.push(m);
  });

  if(!mostrar.length) mostrar = [new Date(2026,0)];
  mostrar.forEach(m => document.getElementById('mesesPersona').appendChild(crearMesPersona(m, p)));
}

function crearMesPersona(fm, p){
  const y = fm.getFullYear(), mes = fm.getMonth();
  const div = document.createElement("div"); 
  div.className = "calMes3";

  const vac = getDiasVacPersona(p);
  const art = p.articulos || [];
  const loa = p.loa_frac || [];
  const ini = new Date(y, mes, 1);
  const fin = new Date(y, mes + 1, 0).getDate();

  const nombres = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  let html = `<div class='calMes'><h3>${nombres[mes]} ${y}</h3><table><tr><th>L</th><th>M</th><th>Mi</th><th>J</th><th>V</th><th>S</th><th>D</th></tr><tr>`;

  let off = (ini.getDay() === 0 ? 6 : ini.getDay() - 1);
  for(let i = 0; i < off; i++) html += `<td class='diaFuera'></td>`;

  for(let d = 1; d <= fin; d++){
    const fstr = `${y}-${String(mes + 1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dow = ymdToLocal(fstr).getDay();

    let cls = "";
    let etiqueta = "";
    
    if(vac.includes(fstr)) {
      cls = "diaVac3";
      // Para vacaciones, NO mostramos etiqueta, solo el n√∫mero
    }
    else if(art.includes(fstr)) {
      cls = "diaArt3";
      etiqueta = "<div class='etiqueta-calendario' style='font-size:8px; font-weight:bold; color:#333; margin-top:1px;'>Art.</div>";
    }
    else if(loa.includes(fstr)) {
      cls = "diaLoaFrac3";
      etiqueta = "<div class='etiqueta-calendario' style='font-size:8px; font-weight:bold; color:#333; margin-top:1px;'>Loa F.</div>";
    }
    else if(feriadosAR.includes(fstr)) {
      cls = "diaFeriado3";
      // Para feriados, no mostramos etiqueta especial
    }
    else if(dow === 0 || dow === 6) {
      cls = "diaFeriado3";
      // Para fines de semana, no mostramos etiqueta
    }

    html += `<td class='${cls}'>
      <div style="font-size:14px; font-weight:bold;">${d}</div>
      ${etiqueta}
    </td>`;
    if((off + d) % 7 === 0) html += "</tr><tr>";
  }

  html += "</tr></table></div>";
  div.innerHTML = html;
  return div;
}

function generarResumenPersona(p){
  let html = `<h3>Resumen</h3>`;
  
  // Mostrar puestos
  const puestos = p.puestos || [];
  if (puestos.length > 0) {
    html += `<p><strong>Puesto${puestos.length > 1 ? 's' : ''}:</strong> ${puestos.join(', ')}</p>`;
  } else {
    html += `<p><strong>Puestos:</strong> Sin puestos asignados</p>`;
  }
  
  // Mostrar per√≠odos de vacaciones
  if (p.vacaciones && p.vacaciones.length > 0) {
    html += `<div class="vacation-periods-container">`;
    html += `<h4>Per√≠odos de Vacaciones</h4>`;
    
    p.vacaciones.forEach((periodo, index) => {
      const inicio = periodo.inicio;
      const fin = periodo.fin;
      const inicioDate = ymdToLocal(inicio);
      const finDate = ymdToLocal(fin);
      const dias = Math.round((finDate - inicioDate) / 86400000) + 1;
      const reingreso = calcularDiaReingreso(finDate, p.articulos || [], p.loa_frac || []);
      
      html += `
        <div class="vacation-period">
          <div class="vacation-period-header">
            <div class="vacation-period-title">Per√≠odo ${index + 1}</div>
            <div class="vacation-period-dates">${dias} d√≠as</div>
          </div>
          <div class="vacation-period-info">
            <div class="info-item"><strong>Inicio:</strong> ${ymdToDMY(inicio)}</div>
            <div class="info-item"><strong>Fin:</strong> ${ymdToDMY(fin)}</div>
            <div class="info-item vuelve-destacado"><strong>Vuelve a trabajar:</strong> ${ymdToDMY(reingreso)}</div>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
  } else {
    html += `<p class="no-vacations">No tiene per√≠odos de vacaciones asignados.</p>`;
  }
  
  // Mostrar art√≠culos
  html += `<p><strong>Art√≠culos:</strong> ${(p.articulos||[]).map(a => ymdToDMY(a)).join(", ") || "Sin art√≠culos"}</p>`;
  
  // Mostrar LOA Frac
  html += `<p><strong>LOA Frac:</strong> ${(p.loa_frac||[]).map(a => ymdToDMY(a)).join(", ") || "Sin LOA Frac"}</p>`;
  
  // Mostrar total
  const totalVac = getTotalDiasVac(p);
  html += `<p style='font-size:18px; margin-top: 20px; padding: 10px; background: #f0f8ff; border-radius: 6px;'>
    <strong>Total d√≠as de vacaciones:</strong> ${totalVac} d√≠as
  </p>`;
  
  document.getElementById('resumenPersona').innerHTML = html;
}

// Funci√≥n para calcular d√≠a de reingreso para un per√≠odo espec√≠fico
function calcularDiaReingreso(finVac, art, loaFrac){
  let f = new Date(finVac); 
  f.setDate(f.getDate() + 1);
  while(true){
    const ymd = dateToYMD(f);
    const dow = f.getDay();
    if(dow !== 0 && dow !== 6 && !feriadosAR.includes(ymd) && 
       !(art||[]).includes(ymd) && !(loaFrac||[]).includes(ymd)) {
      return ymd;
    }
    f.setDate(f.getDate() + 1);
  }
}

/* ========== MODAL NOVEDADES ========== */
function verificarNovedadesHoy(){
  const hoy = dateToYMD(new Date());
  let vac = [], art = [], loa = [], ing = [];

  flatPeople.forEach(p => {
    // Verificar si comienza vacaciones hoy
    if (p.vacaciones && p.vacaciones.length > 0) {
      p.vacaciones.forEach(periodo => {
        if (periodo.inicio === hoy) vac.push({persona: p, periodo: periodo});
      });
    }
    
    if((p.articulos||[]).includes(hoy)) art.push(p);
    if((p.loa_frac||[]).includes(hoy)) loa.push(p);
    
    // Verificar si hoy es d√≠a de reingreso de alg√∫n per√≠odo
    if(p.vacaciones && p.vacaciones.length > 0) {
      p.vacaciones.forEach(periodo => {
        if (periodo.fin) {
          const finDate = ymdToLocal(periodo.fin);
          const reingreso = calcularDiaReingreso(finDate, p.articulos || [], p.loa_frac || []);
          if(reingreso === hoy) ing.push({persona: p, periodo: periodo});
        }
      });
    }
  });

  if(!vac.length && !art.length && !loa.length && !ing.length) return;

  // Configurar modalAbierto
  modalAbierto = true;
  
  let h = `<h2>Novedades del d√≠a ${ymdToDMY(hoy)}</h2>`;
  if(art.length){ 
    h += `<h3>Art√≠culos</h3><ul>` + art.map(p => `<li>${p.nombre}</li>`).join("") + "</ul>"; 
  }
  if(vac.length){ 
    h += `<h3>Comienzan vacaciones</h3><ul>` + 
         vac.map(v => `<li>${v.persona.nombre} (${ymdToDMY(v.periodo.inicio)} - ${ymdToDMY(v.periodo.fin)})</li>`).join("") + 
         "</ul>"; 
  }
  if(loa.length){ 
    h += `<h3>LOA Fraccionada</h3><ul>` + loa.map(p => `<li>${p.nombre}</li>`).join("") + "</ul>"; 
  }
  if(ing.length){ 
    h += `<h3>Ingresan a trabajar</h3><ul>` + 
         ing.map(i => `<li>${i.persona.nombre} (del per√≠odo ${ymdToDMY(i.periodo.inicio)} - ${ymdToDMY(i.periodo.fin)})</li>`).join("") + 
         "</ul>"; 
  }

  const modal = document.createElement("div");
  modal.id = "modalNovedades";
  modal.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.65);display:flex;justify-content:center;align-items:center;z-index:999999";
  modal.innerHTML = `<div style='background:#fff;padding:20px;border-radius:12px;max-width:500px;width:90%'>${h}
    <div class="contacto-modal" style="margin-top:15px;">
      <strong>Oficina H0</strong> | Aux. T√©cnico: <strong>Daverio Pablo</strong><br>
      üìû 155/255 | üì± Cel: 3534112506
    </div>
    <button class='btn' onclick='document.getElementById("modalNovedades").remove(); modalAbierto = false; history.back();' style='background:#007bff;color:white;padding:12px 20px;font-size:16px;font-weight:bold;border:none;border-radius:8px;width:100%;margin-top:15px;'>Cerrar</button></div>`;
  document.body.appendChild(modal);
  
  // Agregar entrada al historial
  history.pushState({ modal: true }, '');
}

/* EVENTOS */
document.getElementById('filtroPlanta').addEventListener('change', function() {
  const plantaSeleccionada = this.value;
  cargarPuestosEnFiltro(plantaSeleccionada);
  filtrarPorPlantaYPuesto();
});

document.getElementById('filtroPuesto').addEventListener('change', function() {
  filtrarPorPlantaYPuesto();
});

document.getElementById('upload').addEventListener('change', e => {
  const f = e.target.files[0]; 
  if(!f) return;
  
  const r = new FileReader();
  r.onload = v => {
    try{
      data = JSON.parse(v.target.result);
      normalizeData();
      const plantaSeleccionada = document.getElementById('filtroPlanta').value;
      cargarPuestosEnFiltro(plantaSeleccionada);
      buildFlatList();
      renderGrid();
      renderMobileView();
      verificarNovedadesHoy();
      alert("JSON cargado exitosamente");
    }
    catch(err){
      alert("Archivo inv√°lido: " + err.message);
    }
  };
  r.readAsText(f, "utf-8");
});

// Agregar evento para cerrar con la tecla ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const ingresoPopup = document.getElementById('mobileIngresoPopup');
    if (ingresoPopup.style.display === 'flex') {
      cerrarMobileIngreso();
    } else {
      const calPersonaPopup = document.getElementById('calPersonaPopup');
      if (calPersonaPopup.style.display === 'flex') {
        cerrarPopupPersona();
      } else if (document.getElementById('modalNovedades')) {
        document.getElementById('modalNovedades').remove();
        modalAbierto = false;
        history.back();
      }
    }
  }
});

/* INICIO */
loadJSON();
</script>

</body>
</html>
