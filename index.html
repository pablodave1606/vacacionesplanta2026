<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vacaciones - Planta</title>

<style>
/* ====== MEJORAS DE LECTURA EN EL MODAL ====== */

.calMes {
  background:#f7f7f7;
  padding:10px;
  border-radius:10px;
  margin-bottom:15px;
  border:1px solid #ddd;
}

.calMes h3 {
  text-align:center;
  font-size:20px;
  margin-bottom:10px;
  color:#333;
}

.calMes3 table {
  border:1px solid #ccc;
  border-radius:8px;
  overflow:hidden;
}

.calMes3 table th,
.calMes3 table td {
  border:1px solid #ddd;
  padding:6px;
}

.calMes3 table tr:nth-child(even) td {
  background:#fafafa;
}

.diaVac3, .diaArt3 {
  font-size:14px !important;
  font-weight:bold !important;
  border-radius:4px;
}

/* ================== ESTILOS GENERALES ================== */

.today-header {
  background: #ffe08c !important;
  font-weight: bold;
  border-bottom: 2px solid #d09000;
}

table thead th {
  position: sticky;
  top: 0;
  z-index: 20;
  background: #fafafa;
  box-shadow: 0 2px 3px rgba(0,0,0,0.15);
}

#gridWrap {
  border:1px solid #ddd;
  background:#fff;
  padding:8px;
  border-radius:6px;
  max-height: calc(100vh - 180px);
  overflow:auto;
}

table{
  border-collapse:collapse;
  width:100%;
  font-size:12px;
}

th,td{
  border:1px solid #eee;
  padding:4px;
  min-width:28px;
  text-align:center;
  white-space:nowrap;
}

th.sticky{
  position:sticky;
  left:0;
  background:#fafafa;
  z-index:7;
}

td.name{
  min-width:220px;
  text-align:left;
  position:sticky;
  left:0;
  background:#fff;
  z-index:6;
}

.name-hn { background: #e8f4ff !important; }

body{
  font-family:Arial,Helvetica,sans-serif;
  margin:10px;
  background:#f6f7fb;
  color:#222;
}

header{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

h1{ margin:0 0 10px 0; font-size:20px }

.controls{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

.vac{ background:#7ed47e !important; font-weight:bold; }
.art{ background:#D7EEFF !important; }
.holiday{ background:#ffcccc !important; }

.vac-num{ font-size:11px; color:#003300; }

.legend{ display:flex; gap:10px; margin-left:10px }
.btn{
  padding:6px 8px;
  border-radius:6px;
  border:1px solid #ccc;
  background:#fff;
  cursor:pointer
}

.filters{ display:flex; gap:6px; align-items:center }

#mobileMonthNav { display:none; }

/* ================== POPUP PERSONA ================== */

#calPersonaPopup {
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.65);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:30px;
  z-index:99999;
}

#calPersonaBox {
  background:#fff;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:1100px;
  max-height:90vh;
  overflow-y:auto;
  box-shadow:0 0 20px rgba(0,0,0,0.35);
}

.calMes3 {
  display:inline-block;
  width:32%;
  vertical-align:top;
  margin-bottom:10px;
}

.calMes3 table {
  width:100%;
  border-collapse:collapse;
  text-align:center;
  font-size:12px;
}

.calMes3 th {
  background:#f0f0f0;
  padding:6px 4px;
  font-weight:600;
}

.diaArt3 { background:#D7EEFF !important; }
.diaVac3 { background:#7ed47e !important; font-weight:bold; }
.diaFeriado3 { background:#ffcccc !important; }
.diaFuera { color:#bbb; }

#resumenPersona {
  margin-top:20px;
  padding:12px;
  border:1px solid #ccc;
  background:#fafafa;
  border-radius:6px;
}

/* ================== VISTA CELULAR ================== */

@media (max-width: 600px) {

  body { margin:5px; font-size:13px; }

  #gridWrap {
    padding:4px;
    max-height: calc(100vh - 120px);
  }

  table { font-size:10px; }

  th, td {
    padding:2px;
    min-width:20px;
  }

  td.name {
    min-width:90px;
    font-size:12px;
  }

  td.name div {
    font-size:11px !important;
  }

  .calMes3 {
    width:100% !important;
    margin-bottom:15px;
  }

  #calPersonaBox {
    padding:12px;
    width:94%;
  }

  #calPersonaBox h2 { font-size:18px; }

  #calPersonaBox .btn {
    padding:10px 14px;
    font-size:15px;
  }
}

#modal { display:none !important; }
</style>
</head>

<body>

<!-- ======================================== -->
<!-- POPUP PERSONA -->
<!-- ======================================== -->

<div id="calPersonaPopup">
  <div id="calPersonaBox">
    <button onclick="cerrarPopupPersona()" class="btn">Volver</button>
    <h2 id="tituloPopupPersona"></h2>
    <div id="mesesPersona"></div>
    <div id="resumenPersona"></div>
  </div>
</div>

<header>
  <div>
    <h1>VACACIONES Y ARTICULOS CENTRO DE EXPLOSIVOS (Dic 2025 - Mar 2026)</h1>
    <div style="font-size:13px;color:#555">
      Visualizador de vacaciones y artículos. Click en cualquier celda de la fila para ver la ficha.
    </div>
  </div>

  <div class="controls">
    
    <div class="filters">
      Meses:
      <label><input type="checkbox" checked id="m12"> Dic</label>
      <label><input type="checkbox" checked id="m1"> Ene</label>
      <label><input type="checkbox" checked id="m2"> Feb</label>
      <label><input type="checkbox" checked id="m3"> Mar</label>
    </div>

    <div class="legend">
      <div style="display:flex;align-items:center;gap:6px">
        <div style="width:18px;height:14px;background:#7ed47e;border:1px solid #4a8f4a"></div> Vacaciones
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <div style="width:18px;height:14px;background:#D7EEFF;border:1px solid #9fc7ea"></div> Artículos
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <div style="width:18px;height:14px;background:#ffcccc;border:1px solid #e09b9b"></div> Feriados / Findes
      </div>
    </div>

    <div class="filters">
      Personal:
      <select id="filtroPlanta" class="btn">
        <option value="TODOS">Todos</option>
        <option value="PLANTA I">Planta I</option>
        <option value="PLANTA HN">Planta HN</option>
      </select>
    </div>

    <input type="file" id="upload" accept=".json" class="btn">

  </div>
</header>

<div id="gridWrap"></div>

<script>
// ================= CONFIG ===================
const jsonPath = "vacaciones.json";
const startDate = new Date(2025,11,1);
const endDate   = new Date(2026,2,31);

let data = {};
let flatPeople = [];

const feriadosAR = [
  "2025-12-08","2025-12-24","2025-12-25","2025-12-31",
  "2026-01-01","2026-02-16","2026-02-17",
  "2026-03-24","2026-03-29","2026-03-30"
];
	/* ========= UTILIDADES ========== */
function dateToYMD(d){
  const mm = ("0"+(d.getMonth()+1)).slice(-2);
  const dd = ("0"+d.getDate()).slice(-2);
  return d.getFullYear()+"-"+mm+"-"+dd;
}

function ymdToLocalDate(s){
  const [y,m,d] = s.split("-");
  return new Date(y, m-1, d);
}

function ymdToDMY(s){
  if(!s) return "";
  const [y,m,d] = s.split("-");
  return `${d}/${m}/${y}`;
}

/* ========= NORMALIZACIÓN ========== */
function normalizeData(){
  Object.keys(data).forEach(pl => {
    let newPl = pl.toUpperCase().replace("_"," ").trim();
    if(newPl==="I") newPl="PLANTA I";
    if(newPl==="HN") newPl="PLANTA HN";

    if(newPl !== pl){
      data[newPl] = data[pl];
      delete data[pl];
      pl = newPl;
    }

    data[pl] = data[pl].map(p => {
      if(!p.articulos) p.articulos = [];

      if(typeof p.articulos === "string"){
        p.articulos = p.articulos
          .replace(/;/g,",")
          .split(",")
          .map(a=>{
            a=a.trim();
            if(a.includes("/")){
              const [d,m,y] = a.split("/");
              return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
            }
            return a;
          })
          .filter(a=>a.length>0);
      }
      return p;
    });
  });
}

/* ========= CARGA DEL JSON ========== */
async function loadJSON(){
  try{
    const res = await fetch(jsonPath+"?nocache="+Math.random());
    data = await res.json();
  }catch(e){ data = {}; }

  normalizeData();
  buildFlatList();
  renderGrid();
  verificarNovedadesHoy();   // <<< NUEVO: MUESTRA NOVEDADES DEL DÍA
}

/* ========= LISTA PLANA ========== */
function buildFlatList(){
  const filtro = filtroPlanta.value;
  flatPeople = [];
  Object.keys(data).forEach(pl => {
    if(filtro!=="TODOS" && filtro!==pl) return;
    data[pl].forEach(p => flatPeople.push({planta:pl, ...p}));
  });

  flatPeople.sort((a,b)=>
    a.planta.localeCompare(b.planta) ||
    a.nombre.localeCompare(b.nombre)
  );
}

/* ========= FECHAS ========== */
function getDatesArray(){
  const arr = [];
  for(let d=new Date(startDate); d<=endDate; d.setDate(d.getDate()+1))
    arr.push(new Date(d));
  return arr;
}

function monthFilterShows(date){
  const m = date.getMonth();
  return !(
    (m===11 && !m12.checked) ||
    (m===0  && !m1.checked) ||
    (m===1  && !m2.checked) ||
    (m===2  && !m3.checked)
  );
}

/* ========= TABLA PRINCIPAL ========== */
function renderGrid(){
  const dates = getDatesArray();
  const wrap = document.getElementById('gridWrap');

  const dayInitials = ["D","L","M","X","J","V","S"];
  const monthNames = ["ene.","feb.","mar.","abr.","may.","jun.","jul.","ago.","sep.","oct.","nov.","dic."];

  let html = '<table><thead><tr><th class="sticky">Planta / Nombre</th>';

  dates.forEach(d=>{
    if(!monthFilterShows(d)) return;

    const mIndex = d.getMonth();
    const ymd = dateToYMD(d);
    const today = dateToYMD(new Date());

    html += `
      <th data-month="${mIndex}" class="${ymd===today?'today-header':''}">
        <div style="font-size:11px;font-weight:bold">${dayInitials[d.getDay()]}</div>
        <div style="font-size:9px">${monthNames[mIndex]}</div>
        <div>${("0"+d.getDate()).slice(-2)}</div>
      </th>
    `;
  });

  html += "</tr></thead><tbody>";

  flatPeople.forEach((p,idx)=>{
    let s = p.vacacion_inicio ? ymdToLocalDate(p.vacacion_inicio) : null;
    let e = p.vacacion_fin    ? ymdToLocalDate(p.vacacion_fin)    : null;

    let totalVacCount = 0;
    if(s && e){
      if(p.articulos.includes(dateToYMD(e))){
        e = new Date(e);  
        e.setDate(e.getDate()-1);
      }
      totalVacCount = Math.max(0, Math.round((e-s)/86400000)+1);
    }

    html += `<tr onclick="abrirPopupPersona(flatPeople[${idx}])" style="cursor:pointer">`;

    html += `
<td class="name ${p.planta==='PLANTA HN'?'name-hn':''}">
  <div style="font-size:15px;font-weight:bold;">${p.nombre}</div>
  <div style="font-size:11px;color:#444;margin-top:3px;">
    Legajo: ${p.legajo}<br>
    Vacaciones tomadas: ${totalVacCount} días<br>
    Planta: ${p.planta}
  </div>
</td>`;

    let vacCounter = 0;

    dates.forEach(d=>{
      if(!monthFilterShows(d)) return;

      const ymd = dateToYMD(d);
      const localD = ymdToLocalDate(ymd);

      let isVac = (s && e && localD>=s && localD<=e);
      let isArt = p.articulos.includes(ymd);

      let cls = "";
      let inside = "";

      if(d.getDay()===0 || d.getDay()===6) cls="holiday";
      if(feriadosAR.includes(ymd)) cls="holiday";

      if(isVac){
        cls="vac";
        vacCounter++;
        inside=`<span class="vac-num">${vacCounter}</span>`;
      }

      if(isArt && !isVac) cls="art";

      html += `<td title="${ymdToDMY(ymd)}" class="${cls}">${inside}</td>`;
    });

    html += "</tr>";
  });

  html += "</tbody></table>";
  wrap.innerHTML = html;
}

/* ========= POPUP PERSONA ========== */
function abrirPopupPersona(p){
  tituloPopupPersona.innerText = "Calendario de " + p.nombre;
  generarTresMeses(p);
  generarResumenPersona(p);
  calPersonaPopup.style.display = "flex";
}

function cerrarPopupPersona(){
  calPersonaPopup.style.display = "none";
}

function generarTresMeses(p){
  const c = mesesPersona;
  c.innerHTML = "";

  const inicioVac = p.vacacion_inicio ? ymdToLocalDate(p.vacacion_inicio) : null;
  const finVac    = p.vacacion_fin    ? ymdToLocalDate(p.vacacion_fin)    : null;

  const mesesPosibles = [
    new Date(2025,11,1), // Dic
    new Date(2026,0,1),  // Ene
    new Date(2026,1,1),  // Feb
    new Date(2026,2,1)   // Mar
  ];

  let mesesMostrar = [];

  mesesPosibles.forEach(m => {
    const año = m.getFullYear();
    const mes = m.getMonth();
    const inicioMes = new Date(año, mes, 1);
    const finMes = new Date(año, mes+1, 0);

    let tieneAlgo = false;

    if(inicioVac && finVac){
      if(!(finVac < inicioMes || inicioVac > finMes)){
        tieneAlgo = true;
      }
    }

    if(!tieneAlgo){
      (p.articulos || []).forEach(a => {
        const d = ymdToLocalDate(a);
        if(d.getMonth() === mes && d.getFullYear() === año){
          tieneAlgo = true;
        }
      });
    }

    if(tieneAlgo) mesesMostrar.push(m);
  });

  if(mesesMostrar.length === 0){
    mesesMostrar.push(new Date(2026,0,1));
  }

  mesesMostrar.forEach(m => c.appendChild(crearMesPersona(m, p)));
}

function crearMesPersona(fechaMes, persona){
  const año = fechaMes.getFullYear();
  const mes = fechaMes.getMonth();

  const div = document.createElement("div");
  div.className = "calMes3";

  const diasVac = diasVacPersona(persona);
  const diasArt = persona.articulos || [];

  const inicioMes = new Date(año, mes, 1);
  const finMes = new Date(año, mes+1, 0).getDate();

  const nombres = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  let html = `
  <div class="calMes">
    <h3>${nombres[mes]} ${año}</h3>
    <table><tr>
      <th>L</th><th>M</th><th>Mi</th><th>J</th>
      <th>V</th><th>S</th><th>D</th>
    </tr><tr>`;

  let offset = inicioMes.getDay() === 0 ? 6 : inicioMes.getDay() - 1;
  for(let i=0;i<offset;i++) html += `<td class="diaFuera"></td>`;

  for(let d=1; d<=finMes; d++){
    const fstr = `${año}-${String(mes+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dow = ymdToLocalDate(fstr).getDay();

    let clase = "";
    if(diasVac.includes(fstr)) clase = "diaVac3";
    else if(diasArt.includes(fstr)) clase = "diaArt3";
    else if(feriadosAR.includes(fstr) || dow===0 || dow===6) clase = "diaFeriado3";

    html += `<td class="${clase}">${d}</td>`;

    if((offset + d) % 7 === 0) html += "</tr><tr>";
  }

  html += "</tr></table></div>";
  div.innerHTML = html;
  return div;
}

function diasVacPersona(p){
  if(!p.vacacion_inicio || !p.vacacion_fin) return [];
  let arr = [];

  let d = ymdToLocalDate(p.vacacion_inicio);
  const fin = ymdToLocalDate(p.vacacion_fin);

  while(d <= fin){
    arr.push(dateToYMD(d));
    d = new Date(d);
    d.setDate(d.getDate()+1);
  }
  return arr;
}

function generarResumenPersona(p){
  if(!p.vacacion_inicio || !p.vacacion_fin){
    resumenPersona.innerHTML = "<b>No tiene vacaciones cargadas.</b>";
    return;
  }

  const fin = ymdToLocalDate(p.vacacion_fin);
  const ingreso = calcularDiaIngreso(fin, p.articulos);

  resumenPersona.innerHTML = `
    <h3>Resumen</h3>
    <p><b>Primer día:</b> ${ymdToDMY(p.vacacion_inicio)}</p>
    <p><b>Último día:</b> ${ymdToDMY(p.vacacion_fin)}</p>
    <p><b>Artículos:</b> ${
      (p.articulos && p.articulos.length>0)
        ? p.articulos.map(a=>ymdToDMY(a)).join(", ")
        : "Sin artículos"
    }</p>
    <p style="font-size:18px;margin-top:10px;">
      <b>Ingresa a trabajar:</b> ${ingreso}
    </p>
  `;
}

function calcularDiaIngreso(finVac, articulos){
  let f = new Date(finVac);
  f.setDate(f.getDate()+1);

  while(true){
    const ymd = dateToYMD(f);
    const dow = f.getDay();
    const esFeriado = feriadosAR.includes(ymd);
    const esArt = (articulos||[]).includes(ymd);

    if(dow!==0 && dow!==6 && !esFeriado && !esArt)
      return ymdToDMY(ymd);

    f.setDate(f.getDate()+1);
  }
}

/* ========== MODAL DE NOVEDADES DEL DÍA ========== */

function verificarNovedadesHoy(){
  const hoy = dateToYMD(new Date());
  let inicioVacHoy = [];
  let articulosHoy = [];
  let ingresoHoy = [];

  flatPeople.forEach(p=>{
    if(p.vacacion_inicio === hoy) inicioVacHoy.push(p);

    if((p.articulos||[]).includes(hoy)) articulosHoy.push(p);

    if(p.vacacion_fin){
      const fin = ymdToLocalDate(p.vacacion_fin);
      const ingreso = calcularDiaIngreso(fin, p.articulos);
      if(ingreso === ymdToDMY(hoy)) ingresoHoy.push(p);
    }
  });

  if(inicioVacHoy.length===0 && articulosHoy.length===0 && ingresoHoy.length===0)
    return;

  let html = `<h2>Novedades del día ${ymdToDMY(hoy)}</h2>`;

  if(articulosHoy.length>0){
    html += `<h3>Artículos hoy</h3><ul>`;
    articulosHoy.forEach(p=> html+=`<li>${p.nombre} (${p.planta})</li>`);
    html += "</ul>";
  }

  if(inicioVacHoy.length>0){
    html += `<h3>Comienzan vacaciones hoy</h3><ul>`;
    inicioVacHoy.forEach(p=> html+=`<li>${p.nombre} (${p.planta})</li>`);
    html += "</ul>";
  }

  if(ingresoHoy.length>0){
    html += `<h3>Ingresan a trabajar hoy</h3><ul>`;
    ingresoHoy.forEach(p=> html+=`<li>${p.nombre} (${p.planta})</li>`);
    html += "</ul>";
  }

  mostrarModalNovedades(html);
}

function mostrarModalNovedades(html){
  const modal = document.createElement("div");
  modal.id = "modalNovedades";
  modal.style.cssText = `
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.65); z-index:999999;
    display:flex; justify-content:center; align-items:center;
  `;
  modal.innerHTML = `
    <div style="background:#fff;padding:20px;border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow:auto;">
      ${html}
      <button class="btn" onclick="document.getElementById('modalNovedades').remove()" style="margin-top:15px;font-size:16px;">Cerrar</button>
    </div>
  `;
  document.body.appendChild(modal);
}

/* ========= EVENTOS ========== */
filtroPlanta.onchange = ()=>{ buildFlatList(); renderGrid(); };
m12.onchange = renderGrid;
m1.onchange = renderGrid;
m2.onchange = renderGrid;
m3.onchange = renderGrid;

upload.onchange = function(e){
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ev=>{
    try{
      data = JSON.parse(ev.target.result);
      normalizeData();
      buildFlatList();
      renderGrid();
      alert("JSON cargado correctamente");
      verificarNovedadesHoy();
    }catch(err){ alert("Archivo JSON inválido"); }
  };
  r.readAsText(f,"utf-8");
};

/* ========= INICIO ========= */
loadJSON();
</script>

</body>
</html>
