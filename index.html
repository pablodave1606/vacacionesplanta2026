<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vacaciones - Planta</title>

<style>
.name-hn {
  background: #e8f4ff !important;
}

body{
  font-family:Arial,Helvetica,sans-serif;
  margin:10px;
  background:#f6f7fb;
  color:#222;
}
header{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
h1{margin:0 0 10px 0;font-size:20px}
.controls{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

.grid{
  overflow:auto;
  border:1px solid #ddd;
  background:#fff;
  padding:8px;
  border-radius:6px;
  max-height: calc(100vh - 180px);
}

table{
  border-collapse:collapse;
  width:100%;
  font-size:12px;
}

th,td{
  border:1px solid #eee;
  padding:4px;
  min-width:28px;
  text-align:center;
  white-space:nowrap;
}

th.sticky{
  position:sticky;
  left:0;
  background:#fafafa;
  z-index:7;
}

td.name{
  min-width:220px;
  text-align:left;
  position:sticky;
  left:0;
  background:#fff;
  z-index:6;
}

.vac{ background:#7ed47e !important; font-weight:bold; }
.art{ background:#D7EEFF !important; }
.holiday{ background:#ffcccc !important; }

.vac-num{ font-size:11px; color:#003300; }

.legend{display:flex;gap:10px;margin-left:10px}
.btn{
  padding:6px 8px;
  border-radius:6px;
  border:1px solid #ccc;
  background:#fff;
  cursor:pointer
}

.filters{display:flex;gap:6px;align-items:center}

@media(max-width:600px){ td.name{min-width:120px} }

#mobileMonthNav {
  display:none;
  margin-bottom:10px;
}

@media (max-width: 600px) {
  #mobileMonthNav {
    display:flex !important;
    gap:10px;
    flex-wrap:wrap;
  }
  #mobileMonthNav button {
    flex:1;
    padding:12px;
    background:#e1eaff;
    border:1px solid #7082ff;
    border-radius:10px;
    font-size:16px;
  }
}

/* ===== POPUP DE 3 MESES ===== */
#calPersonaPopup {
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.65);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:30px;
  z-index:99999;
}

#calPersonaBox {
  background:#fff;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:1100px;
  max-height:90vh;
  overflow-y:auto;
  box-shadow:0 0 20px rgba(0,0,0,0.35);
}

.calMes3 {
  display:inline-block;
  width:32%;
  vertical-align:top;
  margin-bottom:10px;
}

.calMes3 table {
  width:100%;
  border-collapse:collapse;
  text-align:center;
  font-size:12px;
}

.calMes3 th {
  background:#f0f0f0;
  padding:6px 4px;
  font-weight:600;
}

.diaArt3 { background:#D7EEFF !important; }
.diaVac3 { background:#7ed47e !important; font-weight:bold; }
.diaFeriado3 { background:#ffcccc !important; }
.diaFuera { color:#bbb; }

#resumenPersona {
  margin-top:20px;
  padding:12px;
  border:1px solid #ccc;
  background:#fafafa;
  border-radius:6px;
}
.name-clickable { cursor:pointer; text-decoration:underline; color:inherit; }

/* hide old per-day edit modal (not used) */
#modal { display:none !important; }
</style>
</head>

<body>

<!-- POPUP DE LA PERSONA (3 MESES) -->
<div id="calPersonaPopup">
  <div id="calPersonaBox">
    <button onclick="cerrarPopupPersona()" class="btn">Volver</button>
    <h2 id="tituloPopupPersona"></h2>
    <div id="mesesPersona"></div>
    <div id="resumenPersona"></div>
  </div>
</div>

<header>
  <div>
    <h1>VACACIONES Y ARTICULOS CENTRO DE EXPLOSIVOS (Dic 2025 - Mar 2026)</h1>
    <div style="font-size:13px;color:#555">
      Visualizador de vacaciones y artículos. Click en cualquier celda de la fila para ver la ficha.
    </div>
  </div>

  <div class="controls">

    <div class="filters">
      Meses:
      <label><input type="checkbox" checked id="m12"> Dic</label>
      <label><input type="checkbox" checked id="m1"> Ene</label>
      <label><input type="checkbox" checked id="m2"> Feb</label>
      <label><input type="checkbox" checked id="m3"> Mar</label>
    </div>

    <div class="legend">
      <div style="display:flex;align-items:center;gap:6px">
        <div style="width:18px;height:14px;background:#7ed47e;border:1px solid #4a8f4a"></div> Vacaciones
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <div style="width:18px;height:14px;background:#D7EEFF;border:1px solid #9fc7ea"></div> Artículos
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <div style="width:18px;height:14px;background:#ffcccc;border:1px solid #e09b9b"></div> Feriados / Findes
      </div>
    </div>

    <div class="filters">
      Personal:
      <select id="filtroPlanta" class="btn">
        <option value="TODOS">Todos</option>
        <option value="PLANTA I">Planta I</option>
        <option value="PLANTA HN">Planta HN</option>
      </select>
    </div>

    <input type="file" id="upload" accept=".json" class="btn">

  </div>
</header>

<div id="mobileMonthNav">
  <button onclick="scrollToMonth(11)">Dic</button>
  <button onclick="scrollToMonth(0)">Ene</button>
  <button onclick="scrollToMonth(1)">Feb</button>
  <button onclick="scrollToMonth(2)">Mar</button>
</div>

<div id="gridWrap" class="grid"></div>

<!-- legacy modal markup left but hidden -->
<div id="modal" class="modal" style="display:none">
  <div class="modal-box">
    <h3 id="modalTitle">Editar (deshabilitado)</h3>
    <div id="modalBody"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn" id="saveBtn">Guardar</button>
      <button class="btn" id="cancelBtn">Cancelar</button>
    </div>
  </div>
</div>

<script>
// ================= CONFIG ===================
const jsonPath = "vacaciones.json";
const startDate = new Date(2025,11,1);
const endDate   = new Date(2026,2,31);

let data = {};
let flatPeople = [];

const feriadosAR = [
  "2025-12-25","2026-01-01","2026-02-16",
  "2026-02-17","2026-03-24","2026-03-29","2026-03-30"
];

// ========= UTILIDADES ==========
function dateToYMD(d){
  const mm = ("0"+(d.getMonth()+1)).slice(-2);
  const dd = ("0"+d.getDate()).slice(-2);
  return d.getFullYear()+"-"+mm+"-"+dd;
}

function ymdToLocalDate(s){
  const [y,m,d] = s.split("-");
  return new Date(y, m-1, d);
}

function ymdToDMY(s){
  if(!s) return "";
  const [y,m,d] = s.split("-");
  return `${d}/${m}/${y}`;
}

// ========= NORMALIZACIÓN ==========
function normalizeData(){
  Object.keys(data).forEach(pl => {
    let newPl = pl.toUpperCase().replace("_"," ").trim();
    if(newPl==="I") newPl="PLANTA I";
    if(newPl==="HN") newPl="PLANTA HN";
    if(newPl !== pl){
      data[newPl] = data[pl];
      delete data[pl];
      pl = newPl;
    }
    data[pl] = data[pl].map(p => {
      if(!p.articulos) p.articulos = [];
      if(typeof p.articulos === "string"){
        p.articulos = p.articulos
          .replace(/;/g,",")
          .split(",")
          .map(a=>{
            a=a.trim();
            if(a.includes("/")){
              const [d,m,y] = a.split("/");
              return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
            }
            return a;
          })
          .filter(a=>a.length>0);
      }
      return p;
    });
  });
}

// ========= CARGA DEL JSON ==========
async function loadJSON(){
  try{
    const res = await fetch(jsonPath+"?nocache="+Math.random());
    data = await res.json();
  }catch(e){
    data = {};
  }

  normalizeData();
  buildFlatList();
  renderGrid();
}

// ========= LISTA PLANA ==========
function buildFlatList(){
  const filtro = document.getElementById("filtroPlanta").value;
  flatPeople = [];
  Object.keys(data).forEach(pl => {
    if(filtro!=="TODOS" && filtro!==pl) return;
    data[pl].forEach(p => flatPeople.push({planta:pl, ...p}));
  });
  flatPeople.sort((a,b)=>
    a.planta.localeCompare(b.planta) ||
    a.nombre.localeCompare(b.nombre)
  );
}

function getDatesArray(){
  const arr = [];
  for(let d=new Date(startDate); d<=endDate; d.setDate(d.getDate()+1)) arr.push(new Date(d));
  return arr;
}

function monthFilterShows(date){
  const m = date.getMonth();
  return !(
    (m===11 && !m12.checked) ||
    (m===0  && !m1.checked)  ||
    (m===1  && !m2.checked)  ||
    (m===2  && !m3.checked)
  );
}

function scrollToMonth(m){
  const first = document.querySelector(`th[data-month="${m}"]`);
  if(first) first.scrollIntoView({behavior:"smooth", inline:"start"});
}

// ========= RENDER (TR clicable) ==========
function renderGrid(){
  const dates = getDatesArray();
  const wrap = document.getElementById('gridWrap');

  const dayInitials = ["D","L","M","X","J","V","S"];
  const monthNames = ["ene.","feb.","mar.","abr.","may.","jun.","jul.","ago.","sep.","oct.","nov.","dic."];

  let html = '<table><thead><tr><th class="sticky">Planta / Nombre</th>';

  dates.forEach(d=>{
    if(!monthFilterShows(d)) return;

    const mIndex = d.getMonth();
    const ymd = dateToYMD(d);
    const today = dateToYMD(new Date());
    const isToday = (ymd===today);

    html += `
      <th data-month="${mIndex}" class="${isToday?'today-header':''}">
        <div style="font-size:11px;font-weight:bold">${dayInitials[d.getDay()]}</div>
        <div style="font-size:9px">${monthNames[mIndex]}</div>
        <div>${("0"+d.getDate()).slice(-2)}</div>
      </th>
    `;
  });

  html += "</tr></thead><tbody>";

  flatPeople.forEach((p,idx)=>{
    let totalVacCount = 0;
    let s = p.vacacion_inicio ? ymdToLocalDate(p.vacacion_inicio) : null;
    let e = p.vacacion_fin    ? ymdToLocalDate(p.vacacion_fin)    : null;

    if(s && e){
      if(p.articulos.includes(dateToYMD(e))){
        e = new Date(e);
        e.setDate(e.getDate()-1);
      }
      totalVacCount = Math.max(0, Math.round((e-s)/86400000)+1);
    }

    // Entire row clickable to open the person's popup
    html += `<tr onclick="abrirPopupPersona(flatPeople[${idx}])" style="cursor:pointer">`;

    html += `
<td class="name ${p.planta==='PLANTA HN'?'name-hn':''}">
  <div style="font-size:15px;font-weight:bold;">${p.nombre}</div>
  <div style="font-size:11px;color:#444;margin-top:3px;">
    Legajo: ${p.legajo}<br>
    Vacaciones tomadas: ${totalVacCount} días<br>
    Planta: ${p.planta}
  </div>
</td>`;

    let vacCounter = 0;

    dates.forEach(d=>{
      if(!monthFilterShows(d)) return;

      const mIndex = d.getMonth();
      const ymd = dateToYMD(d);
      const localD = new Date(ymd+"T00:00");

      let isVac = (s && e && localD>=s && localD<=e);
      let isArt = p.articulos.includes(ymd);

      let cls = "";
      let inside = "";

      if(d.getDay()===0 || d.getDay()===6) cls="holiday";
      if(feriadosAR.includes(ymd)) cls="holiday";

      if(isVac){
        cls="vac";
        vacCounter++;
        inside=`<span class="vac-num">${vacCounter}</span>`;
      }

      if(isArt && !isVac) cls="art";

      // Include tooltip showing date in dd/mm/yyyy
      html += `<td title="${ymdToDMY(ymd)}" data-month="${mIndex}" class="${cls}" data-person="${idx}" data-date="${ymd}">${inside}</td>`;
    });

    html += "</tr>";
  });

  html += "</tbody></table>";
  wrap.innerHTML = html;

  // IMPORTANT: do NOT attach per-cell click listeners (per your option A).
  // If later you want double-click to open day edit modal, we can add dblclick handlers.
}

// The old per-day modal functions remain in the file but are not wired/used.

function cellClicked(e){
  const td = e.currentTarget;
  openModalForDate(td.dataset.person, td.dataset.date);
}

function openModalForDate(index,date){
  // kept for reference but not used while per-cell clicks are disabled
  const p = flatPeople[index];

  modalTitle.innerText = `Editar: ${p.nombre} — ${ymdToDMY(date)}`;

  modalBody.innerHTML = `
    <label>Vacación - Inicio <input type="date" id="m_vstart" value="${p.vacacion_inicio||""}"></label>
    <label>Vacación - Fin <input type="date" id="m_vend"   value="${p.vacacion_fin||""}"></label>

    <label><input type="checkbox" id="m_isart" ${p.articulos.includes(date)?"checked":""}>
      Marcar este día como ARTÍCULO</label>

    <label>Agregar artículo <input type="date" id="m_addart"></label>

    <div style="font-size:13px;margin-top:6px">Artículos actuales:
      <span id="listArts">
        ${p.articulos.map(a => ymdToDMY(a)).join(", ")}
      </span>
    </div>
  `;

  modal.style.display="flex";

  saveBtn.onclick = ()=>{
    p.vacacion_inicio = m_vstart.value || null;
    p.vacacion_fin    = m_vend.value || null;

    if(!p.articulos) p.articulos = [];

    if(m_isart.checked && !p.articulos.includes(date))
         p.articulos.push(date);

    if(!m_isart.checked)
         p.articulos = p.articulos.filter(x=>x!==date);

    if(m_addart.value && !p.articulos.includes(m_addart.value))
         p.articulos.push(m_addart.value);

    syncBackToData();
    renderGrid();
    modal.style.display="none";
  };

  cancelBtn.onclick = ()=> modal.style.display="none";
}

function syncBackToData(){
  const newData = {};
  flatPeople.forEach(p=>{
    newData[p.planta] = newData[p.planta] || [];
  });
  flatPeople.forEach(p=>{
    newData[p.planta].push({
      legajo:p.legajo,
      nombre:p.nombre,
      vacacion_inicio:p.vacacion_inicio,
      vacacion_fin:p.vacacion_fin,
      articulos:p.articulos
    });
  });
  data = newData;
}

// ========= POPUP DE 3 MESES POR PERSONA ==========
function abrirPopupPersona(persona) {
  document.getElementById("tituloPopupPersona").innerText =
    "Calendario de " + persona.nombre;

  generarTresMeses(persona);
  generarResumenPersona(persona);

  document.getElementById("calPersonaPopup").style.display = "flex";
}

function cerrarPopupPersona() {
  document.getElementById("calPersonaPopup").style.display = "none";
}

function generarTresMeses(persona) {
  const cont = document.getElementById("mesesPersona");
  cont.innerHTML = "";

  // Siempre los meses Dic 2025, Ene 2026, Feb 2026
  const meses = [
    new Date(2025,11,1),
    new Date(2026,0,1),
    new Date(2026,1,1)
  ];

  meses.forEach(m => cont.appendChild(crearMesPersona(m, persona)));
}

function crearMesPersona(fechaMes, persona) {
  const año = fechaMes.getFullYear();
  const mes = fechaMes.getMonth();

  const div = document.createElement("div");
  div.className = "calMes3";

  const diasVac = diasVacPersona(persona);
  const diasArt = persona.articulos || [];

  const inicio = new Date(año, mes, 1);
  const finMes = new Date(año, mes + 1, 0).getDate();

  const nombreMeses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  let html = `
    <div class="calMes">
      <h3>${nombreMeses[mes]} ${año}</h3>
      <table><tr>
      <th>L</th><th>M</th><th>Mi</th><th>J</th><th>V</th><th>S</th><th>D</th>
      </tr><tr>`;

  let offset = inicio.getDay() === 0 ? 6 : inicio.getDay() - 1;
  for (let i=0;i<offset;i++) html += `<td class="diaFuera"></td>`;

  for (let d=1; d<=finMes; d++) {
    const fstr = `${año}-${String(mes+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;

    // Prioridad: Vacaciones > Artículo > Feriado/Findes
    let clase = "";
    if (diasVac.includes(fstr)) clase = "diaVac3";
    else if ((persona.articulos || []).includes(fstr)) clase = "diaArt3";
    else if (feriadosAR.includes(fstr) || new Date(fstr+"T00:00").getDay()===0 || new Date(fstr+"T00:00").getDay()===6) clase = "diaFeriado3";

    html += `<td class="${clase}">${d}</td>`;

    if ((offset + d) % 7 === 0) html += "</tr><tr>";
  }

  html += "</tr></table></div>";

  div.innerHTML = html;
  return div;
}

function diasVacPersona(p) {
  if (!p.vacacion_inicio || !p.vacacion_fin) return [];
  let arr = [];
  let d = new Date(p.vacacion_inicio);
  const fin = new Date(p.vacacion_fin);
  while (d <= fin) {
    arr.push(dateToYMD(d));
    d.setDate(d.getDate()+1);
  }
  return arr;
}

function generarResumenPersona(p) {
  const box = document.getElementById("resumenPersona");

  if (!p.vacacion_inicio || !p.vacacion_fin) {
    box.innerHTML = "<b>No tiene vacaciones cargadas.</b>";
    return;
  }

  const inicio = ymdToLocalDate(p.vacacion_inicio);
  const fin = ymdToLocalDate(p.vacacion_fin);

  const primer = ymdToDMY(p.vacacion_inicio);
  const ultimo = ymdToDMY(p.vacacion_fin);

  const ingreso = calcularDiaIngreso(fin, p.articulos);

  box.innerHTML = `
    <h3>Resumen</h3>
    <p><b>Primer día de vacaciones:</b> ${primer}</p>
    <p><b>Último día de vacaciones:</b> ${ultimo}</p>
    <p><b>Artículos:</b> ${ (p.articulos && p.articulos.length>0) ? p.articulos.map(a=>ymdToDMY(a)).join(", ") : "Sin artículos" }</p>
    <p style="font-size:18px;margin-top:10px;">
      <b>Ingresa a trabajar:</b> ${ingreso}
    </p>
  `;
}

function calcularDiaIngreso(finVac, articulos) {
  let f = new Date(finVac);
  f.setDate(f.getDate()+1);

  while (true) {
    const ymd = dateToYMD(f);
    const esFinde = f.getDay()===0 || f.getDay()===6;
    const esArt = (articulos || []).includes(ymd);
    const esFeriado = feriadosAR.includes(ymd);

    if (!esFinde && !esArt && !esFeriado) return ymdToDMY(ymd);

    f.setDate(f.getDate()+1);
  }
}

// ========= EVENTOS ==========
filtroPlanta.onchange = ()=>{ buildFlatList(); renderGrid(); };
m12.onchange = renderGrid;
m1.onchange = renderGrid;
m2.onchange = renderGrid;
m3.onchange = renderGrid;

// Subir JSON manual
upload.onchange = function(e){
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ev=>{
    try{
      data = JSON.parse(ev.target.result);
      normalizeData();
      buildFlatList();
      renderGrid();
      alert("JSON cargado correctamente");
    }catch(err){
      alert("Archivo JSON inválido");
    }
  };
  r.readAsText(f,"utf-8");
};

// ========= INICIO ==========
loadJSON();
</script>
</body>
</html>
